import{bC as re,bG as se,d as L,dv as ae,dt as le,a7 as v,aQ as P,a_ as ce,aB as Z,b$ as X,ah as k,d5 as ie,k as H,c as y,i as I,b as h,a2 as F,a5 as T,a as A,t as R,c4 as G,aa as de,bj as ue,bE as me,bv as $,a6 as K,ac as U,a9 as pe,bU as ge,a8 as he}from"./index-B7WIMVLo.js";import{g as S,w as _e,c as W,e as be,B as fe,i as Ie,s as Ee,a as we,F as Fe,d as Te}from"./appDialogsManager-DWM6BLp0.js";import{I as M}from"./iconTsx-Dm7uuor6.js";import{S as Le}from"./scrollable2-B9qrN0bL.js";import{T as ve}from"./transition-4sVVeuD9.js";import"./page-CFQq45dV.js";import"./putPreloader-BhMVPekh.js";import"./avatar-CyLVJWYN.js";import"./classNames-CN4lTu6a.js";import"./htmlToSpan-DhAls8qz.js";import"./wrapDuration-N7gVnHGH.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./toast-CTXjJKhu.js";import"./fastBlur-Co-79rP4.js";import"./emailSetup-0NlYvq0Q.js";import"./countryInputField-CGoQGdNE.js";import"./chatBackground-BOw4waSL.js";import"./tracking-CFAwSx7m.js";function Ae(e,t){return Y(e.toLowerCase(),t.toLowerCase(),t.length)}function Y(e,t,n){let r=[],i=0;const m=e.length,s=t.length;for(let a=0;a<s;a++)for(let o=0;o<m;o++){if(e[o]!==t[a])continue;const{found:l}=Y(e.slice(o+1),t.slice(a+1),n),u=[o,...l.map(p=>p+o+1)],b=q(e,t,u,n)-D.missing(n)*a;b>i&&(i=b,r=u)}return{found:r,score:q(e,t,r,n)}}const D={missing:e=>1/e,gap:(e,t)=>.25/e*t};function q(e,t,n,r,i){const m=e.length,s=t.length,a=n.length;if(!a)return 0;let o=1,l=0,u=-1;for(let b=0;b<a&&l<s;b++){const p=n[b];if(!(p<m))break;for(;e[p]!==t[l]&&l<s;)l++,o-=D.missing(r);l++,u!=-1&&p-u>1&&(o-=D.gap(s,p-u-1)),u=p}return o-=(r-l)*D.missing(r),o}const Ce="_Container_1o0hu_36",Se="_withScrollable_1o0hu_40",xe="_Scrollable_1o0hu_45",ye="_ScrollableContainer_1o0hu_54",De="_mobile_1o0hu_60",Pe="_Label_1o0hu_64",ke="_LabelText_1o0hu_75",Me="_Input_1o0hu_83",$e="_EmptySearchTip_1o0hu_94",Ze="_Char_1o0hu_106",He="_single_1o0hu_114",Ne="_middle_1o0hu_118",Re="_start_1o0hu_122",ze="_end_1o0hu_129",Be="_Hidden_1o0hu_137",Oe="_Item_1o0hu_141",je="_selected_1o0hu_141",Ve="_ItemLabel_1o0hu_144",Ge="_ItemLabelText_1o0hu_151",Ke="_ItemLabelEnter_1o0hu_154",Ue="_ItemIcon_1o0hu_157",We="_ItemIconCheck_1o0hu_160",qe="_AppearZoomEnterActive_1o0hu_173",Qe="_AppearZoomExitActive_1o0hu_173",Xe="_AppearZoomEnter_1o0hu_173",Ye="_AppearZoomExitTo_1o0hu_176",c={Container:Ce,withScrollable:Se,Scrollable:xe,ScrollableContainer:ye,mobile:De,Label:Pe,LabelText:ke,Input:Me,EmptySearchTip:$e,Char:Ze,single:He,middle:Ne,start:Re,end:ze,Hidden:Be,Item:Oe,selected:je,ItemLabel:Ve,ItemLabelText:Ge,ItemLabelEnter:Ke,ItemIcon:Ue,ItemIconCheck:We,AppearZoomEnterActive:qe,AppearZoomExitActive:Qe,AppearZoomEnter:Xe,AppearZoomExitTo:Ye},C=re("AddToFolderDropdownMenu",se.Debug);async function Dt(){return(await L.managers.filtersStorage.getDialogFilters()).filter(t=>t.id!==ae&&t.id!==le).sort((t,n)=>!t.id||!n.id?0:t?.localId-n?.localId)}const g=e=>Math.abs(e);async function Je(e,t){C.debug("addToFilter before",e),e={...e},e._==="dialogFilter"&&(e.excludePeerIds=e.excludePeerIds?.filter(r=>g(r)!==g(t)),e.exclude_peers=e.exclude_peers?.filter(r=>g(S(r))!==g(t))),e.pinnedPeerIds.find(r=>g(r)===g(t))||(e.includePeerIds=[...(e.includePeerIds||[]).filter(r=>g(r)!==g(t)),t],e.include_peers=[...(e.include_peers||[]).filter(r=>g(S(r))!==g(t)),await L.managers.appPeersManager.getInputPeerById(t)]),C.debug("addToFilter after",e),await L.managers.filtersStorage.updateDialogFilter(e)}async function et(e,t){C.debug("removeFromFilter before",e),e={...e},e.includePeerIds=e.includePeerIds?.filter(n=>g(t)!==g(n)),e.include_peers=e.include_peers?.filter(n=>g(S(n))!==g(t)),e.pinnedPeerIds=e.pinnedPeerIds?.filter(n=>g(t)!==g(n)),e.pinned_peers=e.pinned_peers?.filter(n=>g(S(n))!==g(t)),e._==="dialogFilter"&&(e.excludePeerIds=[...(e.excludePeerIds||[]).filter(n=>g(n)!==g(t)),t],e.exclude_peers=[...(e.exclude_peers||[]).filter(n=>g(S(n))!==g(t)),await L.managers.appPeersManager.getInputPeerById(t)]),C.debug("removeFromFilter after",e),await L.managers.filtersStorage.updateDialogFilter(e)}function tt(e,t){const n=document.createElement("span"),r=_e(e,t,!0);n.append(r),n.querySelector("custom-emoji-renderer-element")?.setTextColor("primary-text-color");const m=document.createTreeWalker(n,NodeFilter.SHOW_TEXT),s=[],a=[];for(;m.nextNode();)s.push(m.currentNode);for(const o of s){const l=document.createDocumentFragment(),u=o.nodeValue.split("").map(b=>{const p=document.createElement("span");return p.innerText=b,p});a.push(u),l.append(...u),o.parentNode.replaceChild(l,o)}return{span:n,charSpansGroups:a}}function nt(e,t){let n=0;const r=[];for(const i of e){const m=i.length,s=t.filter(o=>o>=n&&o<n+m).map(o=>o-n),a=s.length;n+=m;for(let o=0;o<a;o++){let l=o;for(;l<a-1&&s[l+1]-1===s[l];)l++;if(l===o){const p=s[o],E=i[p];E.classList.add(c.Char,c.single),r.push(E);continue}const u=i[s[o]],b=i[s[l]];u.classList.add(c.Char,c.start),b.classList.add(c.Char,c.end),r.push(u,b);for(let p=o+1;p<l;p++){const E=i[s[p]];E.classList.add(c.Char,c.middle),r.push(E)}o=l}}v(()=>{r.forEach(i=>{i.className=""})})}const N=R("<span>"),ot=.25,rt=({filter:e,isChecked:t,docId:n,emoji:r})=>{const[i,m]=y(!1);return(()=>{const s=N();return I(s,h(F,{get when(){return(n||r)&&!i()},get fallback(){return h(M,{get icon(){return we(e)}})},get children(){return h(Fe,{get managers(){return L.managers},color:"primary-text-color",docId:n,emoji:r,size:20,onFail:()=>m(!0),get dontAnimate(){return e.pFlags?.title_noanimate}})}}),null),I(s,h(ve,{get enterActiveClass(){return c.AppearZoomEnterActive},get exitActiveClass(){return c.AppearZoomEnterActive},get enterClass(){return c.AppearZoomEnter},get exitToClass(){return c.AppearZoomExitTo},get children(){return h(F,{get when(){return t()},get children(){const a=N();return I(a,h(M,{icon:"check"})),T(()=>A(a,c.ItemIconCheck)),a}})}}),null),T(()=>A(s,`btn-menu-item-icon ${c.ItemIcon}`)),s})()},st=({label:e,isSelected:t})=>(()=>{const n=N();return I(n,e,null),I(n,h(F,{get when(){return t()},get children(){return h(M,{icon:"enter",get class(){return c.ItemLabelEnter}})}}),null),T(()=>A(n,c.ItemLabel)),n})(),at=({filters:e,isInFilter:t,isSelected:n,onToggle:r,currentFilter:i})=>P(()=>{const m=ce();return C.debug("creating folder items"),v(()=>{C.debug("destroying folder items middleware"),m.destroy()}),e().map(s=>{const a=be(s.title),{span:o,charSpansGroups:l}=tt(a.text,m.get());o.classList.add(c.ItemLabelText);const u={iconElement:rt({filter:s,isChecked:()=>t(s),docId:a.docId,emoji:a.emoji}),textElement:st({label:o,isSelected:()=>n(s.id)}),onClick:Z},b=fe(u);return u.element?.addEventListener(X,async p=>{p.shiftKey&&i()!==s.id&&p.stopPropagation(),r(s)},!0),u.element?.classList.add(c.Item),k(()=>{n(s.id)&&(u.element?.classList.add(c.selected),v(()=>void u.element?.classList.remove(c.selected)))}),{filter:s,textContent:o.textContent,buttonMenuItem:b,element:u.element,charSpansGroups:l}})}),lt=({dialog:e,onNewDialog:t,isInFilter:n})=>{let r=!1;return async i=>{if(r||!i)return;const m=ie(i);r=!0;try{await(n(i)?et(m,e().peerId):Je(m,e().peerId));const s=await L.managers.dialogsStorage.getAnyDialog(e().peerId);if(!Ie(s))return;t(s)}catch{}finally{r=!1}}},ct=({folderItems:e,search:t,isSelected:n,setSelected:r})=>P(()=>{if(!t())return{folders:e(),visibleFoldersCount:e().length};const m=e().map(a=>({finderResult:Ae(a.textContent,t()),src:a})).sort(({finderResult:{found:a,score:o}},{finderResult:{found:l,score:u}})=>o===u?(a[0]||0)-(l[0]||0):u-o);r(0),v(()=>void r());const s=m.filter(({src:a,finderResult:o})=>{if(o.score>=ot)return k(()=>{n(a.filter.id)&&a.element.scrollIntoView({block:"center"})}),nt(a.charSpansGroups,o.found),!0;a.buttonMenuItem.forEach(l=>l.classList.add(c.Hidden)),v(()=>void a.buttonMenuItem.forEach(l=>l.classList.remove(c.Hidden)))}).length;return{folders:m.map(({src:a})=>a),visibleFoldersCount:s}}),it=({pivot:e})=>{let t=Z;return setTimeout(()=>{t=void 0},200),v(()=>{t?.()}),{showHint:()=>{t||(t=Ee({element:e(),vertical:"top",textElement:H("AddToFolderTip"),lighter:!0,auto:!0,useOverlay:!1,onClose:()=>{t=void 0}}).close)},closeAndDisableTooltip:()=>{t?.(),t=Z}}},dt=({search:e,setSearch:t,selected:n,setSelected:r,selectedFilter:i,currentFilter:m,onToggle:s,visibleFoldersCount:a})=>o=>{if(["ArrowUp","ArrowLeft","ArrowDown","ArrowRight","Enter"].includes(o.code)&&o.preventDefault(),o.code==="Escape"&&(e()?t(""):W.close()),o.code==="Enter"&&i()){s(i()),(!o.shiftKey||m()===i().id)&&W.close();return}if(typeof n()!="number")return;const l=["ArrowUp","ArrowLeft"].includes(o.code)?-1:["ArrowDown","ArrowRight"].includes(o.code)?1:0;r(u=>(u+l+a())%a())},ut=R("<input>"),Q=R("<div>"),mt=8,Pt=Te({name:"add-to-folder-dropdown-menu",component:(e,t,n)=>{e.element.classList.add("btn-menu",c.Container);let r,i,m;const[s,a]=y(""),[o,l]=y(),[u,b]=y([]),p=G(()=>e.dialog,(_,d)=>!!d?.[`index_${_.localId}`]),E=P(()=>u()[o()]?.filter),z=G(()=>E()?.id),B=P(()=>e.filters.length>mt),O=lt({dialog:()=>e.dialog,onNewDialog:_=>{e.dialog=_,e.onNewDialog?.(_)},isInFilter:p}),J=at({filters:()=>e.filters,isInFilter:p,isSelected:z,onToggle:O,currentFilter:e.currentFilter}),x=ct({folderItems:J,search:s,isSelected:z,setSelected:l}),{showHint:ee,closeAndDisableTooltip:te}=it({pivot:()=>r});n.closeTooltip=te;const ne=dt({search:s,setSearch:a,selected:o,setSelected:l,selectedFilter:E,currentFilter:e.currentFilter,onToggle:O,visibleFoldersCount:()=>x().visibleFoldersCount});de(()=>{m?.addEventListener(X,_=>{_.stopPropagation()},!0)}),ue(()=>{b(x().folders)}),k(()=>{typeof o()!="number"&&i?.scrollIntoView({block:"center"})}),k(()=>{e.element.classList.toggle(c.withScrollable,B())});const oe=me.registerEscapeHandler(()=>!s());v(()=>{e.onCleanup?.(),oe()});const j=()=>h(ge,{get each(){return x().folders},children:_=>_.buttonMenuItem});return h(F,{get when(){return B()},get fallback(){return h(j,{})},get children(){const _=Q();return _.style.setProperty("--max-visible-items","6"),I(_,h(F,{when:!$,get children(){const d=ut();return K(f=>void setTimeout(()=>void f.focus(),100),d),U(d,"keydown",ne,!0),d.addEventListener("blur",f=>{f.target.focus()}),d.$$input=f=>void a(f.target.value),T(()=>A(d,c.Input)),T(()=>d.value=s()),d}}),null),I(_,h(F,{get when(){return!x().visibleFoldersCount},get children(){return(()=>{const d=H("AddToFolderEmptySearchResult");return d.classList.add(c.EmptySearchTip),d})()}}),null),I(_,h(Le,{get class(){return c.Scrollable},thumbRef:d=>void(m=d),get children(){return[h(F,{when:!$,get children(){const d=Q();U(d,"pointerenter",ee);const f=i;return typeof f=="function"?K(f,d):i=d,I(d,()=>{const w=H("AddToFolderSearch");return w.classList.add(c.LabelText),w},null),I(d,h(M,{ref(w){const V=r;typeof V=="function"?V(w):r=w},icon:"info"}),null),T(()=>A(d,c.Label)),d}}),h(j,{})]}}),null),T(d=>{const f=c.ScrollableContainer,w={[c.mobile]:$};return f!==d._v$&&A(_,d._v$=f),d._v$2=he(_,w,d._v$2),d},{_v$:void 0,_v$2:void 0}),_}})}});pe(["input","keydown"]);export{Pt as default,Dt as fetchDialogFilters};
//# sourceMappingURL=index-B6sQ-RUb.js.map
