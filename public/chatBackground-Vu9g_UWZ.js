import{y as st,bW as it,bp as nt,a4 as at,t as A,ce as ot,ao as K,ee as Q,b9 as rt,bQ as ht,m as ct,a1 as lt,eD as dt,fY as gt,ek as mt,aC as ut,fZ as F,da as pt,cr as B,eb as ft,c as b,aa as _t,a7 as xt,i as S,ab as Pt,a as G,a5 as H,bf as vt,by as wt,eg as Ct,aW as yt,a6 as It,dY as Tt}from"./index-HSqJgTYz.js";import{c as bt}from"./classNames-CN4lTu6a.js";function Yt(o,t){if(o.focus(),st(o),t){const e=new KeyboardEvent(t.type,t);o.dispatchEvent(e)}}const St=A("<div>");function Bt(o){const[t,e]=it(o,["amount","withTransition"]);return(()=>{const s=St();return nt(s,at(e,{get style(){return{"padding-top":t.amount,transition:t.withTransition?".2s":void 0}}}),!1,!1),s})()}const Ut=!1,Et=Q&&dt,I=class I{constructor(){this.canvases=new Set}static getInstance(t){let e=this.INSTANCES.find(s=>s.options.element===t.element&&ot(s.options,t,["element"]));return e||(e=new I,e.init(t),this.INSTANCES.push(e)),e}init(t){this.options=t}renderToCanvas(t){return this.renderImageFromUrl(this.options.url).then(()=>this.fillCanvas(t))}renderImageFromUrl(t){if(this.renderImageFromUrlPromise)return this.renderImageFromUrlPromise;const e=this.image=document.createElement("img");return e.crossOrigin="anonymous",this.renderImageFromUrlPromise=K(e,t,!1).then(()=>!Q||!Et?e:createImageBitmap(e,{resizeWidth:1440,resizeHeight:2960}).then(s=>(this.imageBitmap=s,e)))}cleanup(t){this.canvases.delete(t),this.canvases.size||(rt(I.INSTANCES,this),this.imageBitmap?.close())}fillCanvas(t){const e=t.getContext("2d"),{width:s,height:i}=t,n=this.imageBitmap||this.image;let r=n.width,m=n.height;const h=(500+ht.height/2.5)*t.dpr,l=h/m;r*=l,m=h,this.options.mask?(e.fillStyle="#000",e.fillRect(0,0,s,i),e.globalCompositeOperation="destination-out"):e.globalCompositeOperation="source-over";const g=c=>{for(let d=0;d<s;d+=r)e.drawImage(n,d,c,r,m)},a=(i-m)/2;if(g(a),a>0){let c=a;do g(c-=m);while(c>=0)}const u=i-1;for(let c=a+m;c<u;c+=m)g(c)}setCanvasDimensions(t){const e=Math.min(2,window.devicePixelRatio),s=this.options.width*e;let i=this.options.height*e;t.dpr=e,t.dataset.originalHeight=""+i,ct.activeScreen===lt.large&&Ut&&(i*=1.5),t.width=s,t.height=i}createCanvas(){const t=document.createElement("canvas");return this.canvases.add(t),this.setCanvasDimensions(t),t}resize(t,e){this.init({...this.options,width:t,height:e});const s=[];for(const i of this.canvases)this.setCanvasDimensions(i),s.push(this.renderToCanvas(i));return Promise.all(s)}static resizeInstancesOf(t){const e=this.INSTANCES.filter(i=>i.options.element===t),s=t.getBoundingClientRect();return Promise.all(e.map(i=>i.resize(s.width,s.height)))}};I.INSTANCES=[];let U=I;const E=class E extends gt{static getWallPaperStorageUrl(t,e){return`backgrounds/${t}${e?"?blur":""}`}static hasWallPaperStorageUrl(t,e){const s=this.getWallPaperStorageUrl(t,e);return this.cacheStorage.has(s)}static getBackground({slug:t,canDownload:e,blur:s,managers:i,appDownloadManager:n}){var h;const r=this.getWallPaperStorageUrl(t,s),m=e&&!!i&&!!n;return(h=this.backgroundPromises)[r]||(h[r]=this.cacheStorage.getFile(r).then(l=>this.backgroundPromises[r]=URL.createObjectURL(l),m?async l=>{if(l.type!=="NO_ENTRY_FOUND")throw l;const g=await i.appThemesManager.getWallPaperBySlug(t);let a=await n.downloadMediaURL({media:g.document});return s&&(a=await this.blurWallPaperImage(a)),this.saveWallPaperToCache(t,a,s),this.backgroundPromises[r]=a}:void 0))}static blurWallPaperImage(t){const{canvas:e,promise:s}=ut(t,12,4);return s.then(()=>e.toDataURL())}static async saveWallPaperToCache(t,e,s){if(!t||t===F)return;const i=await fetch(e),n=i.clone(),r=await i.blob();return this.cacheStorage.save({entryName:this.getWallPaperStorageUrl(t,s),response:n,size:r.size})}static setBackgroundUrlToCache({slug:t,url:e,blur:s}){this.backgroundPromises[this.getWallPaperStorageUrl(t,s)]=e}};E.cacheStorage=new mt("cachedBackgrounds"),E.backgroundPromises={};let R=E;const Nt="_Container_nve2r_1",Rt="_CanvasCommon_nve2r_11",Dt="_blend_nve2r_22",C={Container:Nt,CanvasCommon:Rt,blend:Dt};function At(o,t){return-t*o*(o-2)}const D=50,X=D;class L{constructor(){this._width=D,this._height=X,this._tails=90,this._curve=[0,.25,.5,.75,1,1.5,2,2.5,3,3.5,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,18.3,18.6,18.9,19.2,19.5,19.8,20.1,20.4,20.7,21,21.3,21.6,21.9,22.2,22.5,22.8,23.1,23.4,23.7,24,24.3,24.6,24.9,25.2,25.5,25.8,26.1,26.3,26.4,26.5,26.6,26.7,26.8,26.9,27],this._positions=[{x:.8,y:.1},{x:.6,y:.2},{x:.35,y:.25},{x:.25,y:.6},{x:.2,y:.9},{x:.4,y:.8},{x:.65,y:.75},{x:.75,y:.4}],this._phases=this._positions.length,this.drawNextPositionAnimated=e=>{let s,i;if(e){const n=e();s=n>=1;const r=At(n,1),m=this._nextPositionTail??0,l=(this._nextPositionTail=this._nextPositionTails*r)-m;l&&(this._nextPositionLeft-=l,this.changeTailAndDraw(-l))}else{const n=this._frames;i=n.shift(),s=!n.length}return i&&this.drawImageData(i),s&&(this._nextPositionLeft=void 0,this._nextPositionTails=void 0,this._nextPositionTail=void 0,this._animatingToNextPosition=void 0),!s};const t=this._tails/this._curve[this._curve.length-1];for(let e=0,s=this._curve.length;e<s;++e)this._curve[e]=this._curve[e]*t;this._incrementalCurve=this._curve.map((e,s,i)=>e-(i[s-1]??0))}hexToRgb(t){const e=pt(t);return{r:e[0],g:e[1],b:e[2]}}getPositions(t){const e=this._positions.slice();e.push(...e.splice(0,t));const s=[];for(let i=0;i<e.length;i+=2)s.push(e[i]);return s}getNextPositions(t,e,s){const i=this.getPositions(t);if(!s[0]&&s.length===1)return[i];const r=this.getPositions(++t%this._phases).map((h,l)=>({x:(h.x-i[l].x)/e,y:(h.y-i[l].y)/e}));return s.map(h=>r.map((l,g)=>({x:i[g].x+l.x*h,y:i[g].y+l.y*h})))}curPosition(t,e){return this.getNextPositions(t,this._tails,[e])[0]}changeTail(t){for(this._tail+=t;this._tail>=this._tails;)this._tail-=this._tails,++this._phase>=this._phases&&(this._phase-=this._phases);for(;this._tail<0;)this._tail+=this._tails,--this._phase<0&&(this._phase+=this._phases)}changeTailAndDraw(t){this.changeTail(t);const e=this.curPosition(this._phase,this._tail);this.drawGradient(e)}getGradientImageData(t,e=this._phase,s=1-this._tail/this._tails){const i=this._hctx.createImageData(this._width,this._height),n=i.data,r=this._colors.length,m=u=>{const c=[];for(let d=0;d!=4;++d)c[d]={...this._positions[(u+d*2)%this._positions.length]},c[d].y=1-c[d].y;return c},h=(e+1)%this._positions.length,l=m(h),g=m(e);let a=0;for(let u=0;u<this._height;++u){const d=u/this._height-.5,N=d*d;for(let f=0;f<this._width;++f){const P=f/this._width-.5,y=.35*Math.sqrt(P*P+N),p=y*y*.8*8,_=Math.sin(p),W=Math.cos(p),Z=Math.max(0,Math.min(1,.5+P*W-d*_)),J=Math.max(0,Math.min(1,.5+P*_+d*W));let T=0,$=0,z=0,O=0;for(let x=0;x<r;++x){const tt=l[x].x+(g[x].x-l[x].x)*s,et=l[x].y+(g[x].y-l[x].y)*s,k=Z-tt,Y=J-et;let v=Math.max(0,.9-Math.sqrt(k*k+Y*Y));v=v*v*v*v,T+=v,$+=v*this._colors[x].r,z+=v*this._colors[x].g,O+=v*this._colors[x].b}n[a++]=$/T,n[a++]=z/T,n[a++]=O/T,n[a++]=255}}return i}drawImageData(t){this._hctx.putImageData(t,0,0),this._ctx.drawImage(this._hc,0,0,this._width,this._height)}drawGradient(t){this.drawImageData(this.getGradientImageData(t))}init(t){this._frames=[],this._phase=0,this._tail=0;const e=t.getAttribute("data-colors").split(",");this._colors=e.map(s=>this.hexToRgb(s)),this._hc||(this._hc=document.createElement("canvas"),this._hc.width=this._width,this._hc.height=this._height,this._hctx=this._hc.getContext("2d",{alpha:!1})),this._canvas=t,this._ctx=this._canvas.getContext("2d",{alpha:!1}),this.update()}update(){if(this._colors.length<2){const e=this._colors[0];this._ctx.fillStyle=`rgb(${e.r}, ${e.g}, ${e.b})`,this._ctx.fillRect(0,0,this._width,this._height);return}const t=this.curPosition(this._phase,this._tail);this.drawGradient(t)}toNextPosition(t){if(this._colors.length<2)return;if(t){this._nextPositionLeft=this._tails+(this._nextPositionLeft??0),this._nextPositionTails=this._nextPositionLeft,this._nextPositionTail=void 0,this._animatingToNextPosition=!0,B(this.drawNextPositionAnimated.bind(this,t),this);return}const e=this._tail,s=this._tails;let i;const n=[];for(let h=0,l=this._incrementalCurve.length;h<l;++h){const g=this._incrementalCurve[h];let a=(n[h-1]??e)+g;+a.toFixed(2)>s&&i===void 0&&(i=h,a%=s),n.push(a)}const r=n.slice(0,i),m=i!==void 0?n.slice(i):[];[r,m].forEach((h,l,g)=>{const a=h[h.length-1];if(a!==void 0&&a>s&&(h[h.length-1]=+a.toFixed(2)),this._tail=a??0,!h.length)return;const u=this.getNextPositions(this._phase,s,h);l!==g.length-1&&++this._phase>=this._phases&&(this._phase-=this._phases);const c=u.map(d=>this.getGradientImageData(d));this._frames.push(...c)}),this._animatingToNextPosition=!0,B(this.drawNextPositionAnimated,this)}cleanup(){}static createCanvas(t){const e=document.createElement("canvas");return e.width=D,e.height=X,t!==void 0&&(e.dataset.colors=t),e}static create(t){const e=this.createCanvas(t),s=new L;return s.init(e),{gradientRenderer:s,canvas:e}}}function j(o){const t=o.getContext("2d"),e=new Array(4).fill(0),s=t.getImageData(0,0,o.width,o.height).data,i=s.length/4;for(let r=0;r<s.length;r+=4)e[0]+=s[r],e[1]+=s[r+1],e[2]+=s[r+2],e[3]+=s[r+3];const n=new Uint8ClampedArray(4);return n[0]=e[0]/i,n[1]=e[1]/i,n[2]=e[2]/i,n[3]=e[3]/i,n}function Ft(o,t,e){const s=document.createElement("canvas"),i=t/e,n=50;return i===1?(s.width=n,s.height=s.width/i):i>1?(s.height=n,s.width=s.height/i):s.width=s.height=n,s.getContext("2d").drawImage(o,0,0,t,e,0,0,s.width,s.height),j(s)}function V(o){return Ft(o,o.naturalWidth,o.naturalHeight)}async function Gt(o){const t=document.createElement("img");return await K(t,o,!1),V(t)}function Lt(o){let{h:t,s:e,l:s}=ft(o[0],o[1],o[2]);return e>0&&(e=Math.min(100,e+5+.1*(100-e))),s=Math.max(0,s*.65),`hsla(${t}, ${e}%, ${s}%, .4)`}const Mt=A("<div>"),Wt=A("<img>");async function $t(o){const{themeController:t,managers:e,peerId:s}=o;let i=t.getTheme(),n=t.getThemeSettings(i).wallpaper;if(s&&s.isUser()){const g=await e.appProfileManager.getCachedFullUser(s.toUserId());if(g?.wallpaper)n=g.wallpaper;else if(g?.theme){const a="emoticon"in g.theme?g.theme.emoticon:void 0,u=Tt.accountThemes.themes?.find(c=>c.emoticon===a);if(u){i=u;const c=u?.settings.find(d=>d.wallpaper)?.wallpaper;c&&(n=c)}}}let r;try{r=q(n.slug,n.settings?.pFlags.blur)}catch{r=q(F)}const m=!!n?.pFlags?.pattern,h=n.settings?.intensity&&n.settings.intensity/100,l=!!h&&h<0;return{theme:i,backgroundUrl:r,isPattern:m,isDarkPattern:l,intensity:h,wallPaper:n}}function q(o,t){return o===F?"assets/img/pattern.svg":R.getWallPaperStorageUrl(o,t)}async function zt(o){o.naturalWidth||await new Promise(t=>{o.addEventListener("load",t,{once:!0})})}function Ht(o){let t;const[e,s]=b(),[i,n]=b(),[r,m]=b(),[h,l]=b();async function g(){const{backgroundUrl:a,isPattern:u,isDarkPattern:c,intensity:d,wallPaper:N}=await $t(o);l(a);let f,w,P,M;if(a)if(u){const p=t.getBoundingClientRect(),_=U.getInstance({element:t,url:a,width:p.width,height:p.height,mask:c});w=_.createCanvas(),w.classList.add(C.CanvasCommon),c||w.classList.add(C.blend),_.renderToCanvas(w)}else f=document.createElement("img"),f.classList.add(C.CanvasCommon),wt(f,a);const y=Ct(N);if(y){const{canvas:p,gradientRenderer:_}=L.create(y);P=p,o.gradientRendererRef?.(_),P.classList.add(C.CanvasCommon)}else o.gradientRendererRef?.(void 0);if(d){let p;f?p=f:p=c?P:w;let _=Math.abs(d)*(c?.5:1);f?_=Math.max(.3,1-d):c&&(_=Math.max(.3,_)),p?.style.setProperty("--opacity-max",""+_)}if(yt(()=>{s(w),n(P),m(f)}),o.onHighlightColor){let p;f?(await zt(f),p=V(f)):p=j(P);const _=Lt(Array.from(p));o.onHighlightColor(_)}return{patternRenderer:M}}return _t(()=>{const a=()=>{U.resizeInstancesOf(t)};window.addEventListener("resize",a);const u=g();xt(()=>{window.removeEventListener("resize",a),u.then(({patternRenderer:c})=>{c?.cleanup(e())})})}),(()=>{const a=Mt(),u=t;return typeof u=="function"?It(u,a):t=a,S(a,i,null),S(a,e,null),S(a,r,null),S(a,(()=>{const c=Pt(()=>!!h());return()=>c()&&(()=>{const d=Wt();return G(d,C.CanvasCommon),d.style.setProperty("visibility","hidden"),H(()=>vt(d,"src",h())),d})()})(),null),H(()=>G(a,bt(C.Container,o.class))),a})()}export{Ht as C,Bt as S,L as a,R as b,Gt as c,j as d,U as e,Yt as f,V as g,Lt as h};
//# sourceMappingURL=chatBackground-Vu9g_UWZ.js.map
