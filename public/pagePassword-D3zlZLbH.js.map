{"version":3,"mappings":"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","names":["passwordInput","monkey","onFirstMount","page","LoginPage","btnNext","Button","btnNextI18n","I18n","passwordInputField","PasswordInputField","resetLoading","resetLink","i18n","anchorCallback","rootScope","res","__vitePreload","m","err","SimpleConfirmationPopup","pageSignIn","waitTime","wrapFormattedDuration","formatDuration","toastNew","getStateInterval","getState","_state","state","replaceContent","htmlToSpan","wrapEmojiText","onSubmit","cancelEvent","toggle","toggleDisability","value","preloader","putPreloader","response","attachClickEvent","size","mediaSizes","PasswordMonkey","Page"],"ignoreList":[],"sources":["../src/pages/pagePassword.ts"],"sourcesContent":["/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport {putPreloader} from '@components/putPreloader';\nimport mediaSizes from '@helpers/mediaSizes';\nimport {AccountPassword} from '@layer';\nimport Page from '@/pages/page';\nimport Button from '@components/button';\nimport PasswordInputField from '@components/passwordInputField';\nimport PasswordMonkey from '@components/monkeys/password';\nimport I18n, {i18n} from '@lib/langPack';\nimport LoginPage, {SimpleConfirmationPopup} from '@/pages/loginPage';\nimport cancelEvent from '@helpers/dom/cancelEvent';\nimport {attachClickEvent} from '@helpers/dom/clickEvent';\nimport htmlToSpan from '@helpers/dom/htmlToSpan';\nimport replaceContent from '@helpers/dom/replaceContent';\nimport toggleDisability from '@helpers/dom/toggleDisability';\nimport wrapEmojiText from '@lib/richTextProcessor/wrapEmojiText';\nimport rootScope from '@lib/rootScope';\nimport anchorCallback from '@helpers/dom/anchorCallback';\nimport {toastNew} from '@components/toast';\nimport pageSignIn from '@/pages/pageSignIn';\nimport formatDuration from '@helpers/formatDuration';\nimport {wrapFormattedDuration} from '@components/wrappers/wrapDuration';\n\nconst TEST = false;\nlet passwordInput: HTMLInputElement;\nlet monkey: PasswordMonkey;\n\nconst onFirstMount = (): Promise<any> => {\n  const page = new LoginPage({\n    className: 'page-password',\n    withInputWrapper: true,\n    titleLangKey: 'Login.Password.Title',\n    subtitleLangKey: 'Login.Password.Subtitle'\n  });\n\n  const btnNext = Button('btn-primary btn-color-primary');\n  const btnNextI18n = new I18n.IntlElement({key: 'Login.Next'});\n\n  btnNext.append(btnNextI18n.element);\n\n  const passwordInputField = new PasswordInputField({\n    label: 'LoginPassword',\n    name: 'password'\n  });\n\n  passwordInput = passwordInputField.input as HTMLInputElement;\n\n  let resetLoading = false\n  const resetLink = i18n('ForgotPassword', [\n    anchorCallback(() => {\n      if(resetLoading) return;\n      resetLoading = true;\n\n      rootScope.managers.passwordManager.requestRecovery().then((res) => {\n        return import('./pageEmailRecover').then((m) => {\n          m.default.mount({email_pattern: res.email_pattern});\n        })\n      }).catch(async(err: ApiError) => {\n        if(err.type === 'PASSWORD_RECOVERY_NA') {\n          await SimpleConfirmationPopup.show({\n            titleLangKey: 'Login.ResetPassword.Title',\n            descriptionLangKey: 'Login.ResetPassword.NoEmailText',\n            button: {\n              langKey: 'Login.ResetPassword.ResetAccount',\n              isDanger: true\n            }\n          })\n\n          await SimpleConfirmationPopup.show({\n            titleLangKey: 'Login.ResetAccount.Title',\n            descriptionLangKey: 'Login.ResetAccount.Text',\n            button: {\n              langKey: 'Login.ResetPassword.ResetAccount',\n              isDanger: true\n            }\n          })\n\n          // Promise.reject({type: '2FA_CONFIRM_WAIT_518400'})\n          await rootScope.managers.appAccountManager.deleteAccount('Forgot password')\n          .then(() => {\n            pageSignIn.mount();\n          }).catch((err: ApiError) => {\n            if(err.type === '2FA_RECENT_CONFIRM') {\n              SimpleConfirmationPopup.show({\n                titleLangKey: 'Login.ResetAccountFail.Title',\n                descriptionLangKey: 'Login.ResetAccountFail.TextCancelled',\n                button: {\n                  langKey: 'OK'\n                }\n              })\n            } else if(err.type.startsWith('2FA_CONFIRM_WAIT_')) {\n              const waitTime = +err.type.replace('2FA_CONFIRM_WAIT_', '');\n              SimpleConfirmationPopup.show({\n                titleLangKey: 'Login.ResetAccountFail.Title',\n                descriptionLangKey: 'Login.ResetAccountFail.TextWait',\n                descriptionArgs: [wrapFormattedDuration(formatDuration(waitTime))],\n                button: {\n                  langKey: 'OK'\n                }\n              })\n            } else {\n              console.error(err);\n              toastNew({langPackKey: 'Error.AnError'});\n            }\n          })\n          return\n        }\n\n        toastNew({langPackKey: 'Error.AnError'});\n      }).finally(() => {\n        resetLoading = false;\n      });\n    })\n  ]);\n  resetLink.classList.add('forgot-link');\n\n  page.inputWrapper.append(passwordInputField.container, resetLink, btnNext);\n\n  let getStateInterval: number;\n\n  const getState = () => {\n    // * just to check session relevance\n    if(!getStateInterval) {\n      getStateInterval = window.setInterval(getState, 10e3);\n    }\n\n    return !TEST && rootScope.managers.passwordManager.getState().then((_state) => {\n      state = _state;\n\n      if(state.hint) {\n        replaceContent(passwordInputField.label, htmlToSpan(wrapEmojiText(state.hint)));\n      } else {\n        passwordInputField.setLabel();\n      }\n    });\n  };\n\n  let state: AccountPassword;\n\n  const onSubmit = (e?: Event) => {\n    if(e) {\n      cancelEvent(e);\n    }\n\n    if(!passwordInput.value.length) {\n      passwordInput.classList.add('error');\n      return;\n    }\n\n    const toggle = toggleDisability([passwordInput, btnNext], true);\n    const value = passwordInput.value;\n\n    btnNextI18n.update({key: 'PleaseWait'});\n    const preloader = putPreloader(btnNext);\n\n    passwordInputField.setValueSilently('' + Math.random()); // prevent saving suggestion\n    passwordInputField.setValueSilently(value); // prevent saving suggestion\n\n    rootScope.managers.passwordManager.check(value, state).then((response) => {\n      // console.log('passwordManager response:', response);\n\n      switch(response._) {\n        case 'auth.authorization':\n          clearInterval(getStateInterval);\n          import('./pageIm').then((m) => {\n            m.default.mount();\n          });\n          if(monkey) monkey.remove();\n          break;\n        default:\n          btnNext.removeAttribute('disabled');\n          btnNextI18n.update({key: response._ as any});\n          preloader.remove();\n          break;\n      }\n    }).catch((err: any) => {\n      toggle();\n      passwordInputField.input.classList.add('error');\n\n      switch(err.type) {\n        default:\n          // btnNext.innerText = err.type;\n          btnNextI18n.update({key: 'PASSWORD_HASH_INVALID'});\n          passwordInput.select();\n          break;\n      }\n\n      preloader.remove();\n\n      getState();\n    });\n  };\n\n  attachClickEvent(btnNext, onSubmit);\n\n  passwordInput.addEventListener('keypress', function(this, e) {\n    this.classList.remove('error');\n    btnNextI18n.update({key: 'Login.Next'});\n\n    if(e.key === 'Enter') {\n      return onSubmit();\n    }\n  });\n\n  const size = mediaSizes.isMobile ? 100 : 166;\n  monkey = new PasswordMonkey(passwordInputField, size);\n  page.imageDiv.append(monkey.container);\n  return Promise.all([\n    monkey.load(),\n    getState()\n  ]);\n};\n\nconst page = new Page('page-password', true, onFirstMount, () => {\n  monkey?.load()\n}, () => {\n  // if(!isAppleMobile) {\n  passwordInput.focus();\n  // }\n\n  rootScope.managers.appStateManager.pushToState('authState', {_: 'authStatePassword'});\n});\n\nexport default page;\n"],"file":"pagePassword-D3zlZLbH.js"}