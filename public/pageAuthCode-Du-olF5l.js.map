{"version":3,"mappings":"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","names":["authSentCode","headerElement","sentTypeElement","codeInputField","codeInputErrorLabel","resetEmailElement","resetEmailTimer","monkey","player","cleanup","submitCode","code","params","rootScope","response","__vitePreload","m","err","good","replaceContent","i18n","fastRaf","onFirstMount","inputWrapper","page","editButton","Icon","attachClickEvent","pageSignIn","getAnimation","imageDiv","size","mediaSizes","container","lottieLoader","animation","TrackingMonkey","handleResetEmail","updatePendingEmail","render","toastNew","SimpleConfirmationPopup","diff","tsNow","wrapFormattedDuration","formatDuration","anchorCallback","ctx","CODE_LENGTH","CodeInputFieldCompat","key","args","authSentCodeType","a","setBlankToAnchor","wrapEmailPattern","Page","_authCode"],"ignoreList":[],"sources":["../src/pages/pageAuthCode.ts"],"sourcesContent":["/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport mediaSizes from '@helpers/mediaSizes';\nimport {AuthSentCode, AuthSentCodeType, AuthSignIn} from '@layer';\nimport Page from '@/pages/page';\nimport pageSignIn from '@/pages/pageSignIn';\nimport TrackingMonkey from '@components/monkeys/tracking';\nimport CodeInputFieldCompat from '@components/codeInputField';\nimport {i18n, LangPackKey} from '@lib/langPack';\nimport replaceContent from '@helpers/dom/replaceContent';\nimport rootScope from '@lib/rootScope';\nimport lottieLoader from '@lib/rlottie/lottieLoader';\nimport RLottiePlayer from '@lib/rlottie/rlottiePlayer';\nimport setBlankToAnchor from '@lib/richTextProcessor/setBlankToAnchor';\nimport {attachClickEvent} from '@helpers/dom/clickEvent';\nimport Icon from '@components/icon';\nimport {fastRaf} from '@helpers/schedulers';\nimport {wrapEmailPattern} from '@components/popups/emailSetup';\nimport anchorCallback from '@helpers/dom/anchorCallback';\nimport tsNow from '@helpers/tsNow';\nimport {wrapFormattedDuration} from '@components/wrappers/wrapDuration';\nimport formatDuration from '@helpers/formatDuration';\nimport {SimpleConfirmationPopup} from '@/pages/loginPage';\nimport {toastNew} from '@components/toast';\nimport ctx from '@environment/ctx';\n\nlet authSentCode: AuthSentCode.authSentCode = null;\n\nlet headerElement: HTMLHeadElement = null;\nlet sentTypeElement: HTMLParagraphElement = null;\nlet codeInputField: CodeInputFieldCompat;\nlet codeInputErrorLabel: HTMLElement;\nlet resetEmailElement: HTMLDivElement, resetEmailTimer: number;\nlet monkey: TrackingMonkey, player: RLottiePlayer;\n\nconst cleanup = () => {\n  setTimeout(() => {\n    monkey?.remove();\n    player?.remove();\n    codeInputField?.cleanup()\n    if(resetEmailTimer) clearTimeout(resetEmailTimer);\n  }, 300);\n};\n\nconst submitCode = (code: string) => {\n  codeInputField.disabled = true;\n\n  const params: AuthSignIn = {\n    phone_number: authSentCode.phone_number,\n    phone_code_hash: authSentCode.phone_code_hash,\n    phone_code: code\n  };\n\n  // console.log('invoking auth.signIn with params:', params);\n\n  rootScope.managers.apiManager.invokeApi('auth.signIn', params, {ignoreErrors: true})\n  .then(async(response) => {\n    // console.log('auth.signIn response:', response);\n\n    switch(response._) {\n      case 'auth.authorization':\n        await rootScope.managers.apiManager.setUser(response.user);\n\n        import('./pageIm').then((m) => {\n          m.default.mount();\n        });\n        cleanup();\n        break;\n      case 'auth.authorizationSignUpRequired':\n        // console.log('Registration needed!');\n\n        import('./pageSignUp').then((m) => {\n          m.default.mount({\n            'phone_number': authSentCode.phone_number,\n            'phone_code_hash': authSentCode.phone_code_hash\n          });\n        });\n\n        cleanup();\n        break;\n      /* default:\n        codeInput.innerText = response._;\n        break; */\n    }\n  }).catch(async(err) => {\n    let good = false;\n    switch(err.type) {\n      case 'SESSION_PASSWORD_NEEDED':\n        // console.warn('pageAuthCode: SESSION_PASSWORD_NEEDED');\n        good = true;\n        await (await import('./pagePassword')).default.mount(); // lol\n        setTimeout(() => {\n          codeInputField.value = '';\n        }, 300);\n        break;\n      case 'PHONE_CODE_EXPIRED':\n        codeInputField.error = true;\n        replaceContent(codeInputErrorLabel, i18n('PHONE_CODE_EXPIRED'));\n        break;\n      case 'PHONE_CODE_EMPTY':\n      case 'PHONE_CODE_INVALID':\n        codeInputField.error = true;\n        replaceContent(codeInputErrorLabel, i18n('PHONE_CODE_INVALID'));\n        break;\n      default:\n        codeInputField.error = true;\n        replaceContent(codeInputErrorLabel, err.type);\n        break;\n    }\n\n    codeInputField.disabled = false;\n\n    if(!good) {\n      codeInputField.value = '';\n      fastRaf(() => {\n        codeInputField.input.focus();\n      });\n    }\n  });\n};\n\nconst onFirstMount = () => {\n  const inputWrapper = page.pageEl.querySelector('.input-wrapper') as HTMLDivElement;\n  inputWrapper.append(codeInputField.container);\n\n  codeInputErrorLabel = document.createElement('div');\n  codeInputErrorLabel.classList.add('error-label');\n  inputWrapper.append(codeInputErrorLabel);\n\n  const editButton = page.pageEl.querySelector('.phone-edit') as HTMLElement;\n  editButton.append(Icon('edit'));\n  attachClickEvent(editButton, () => {\n    return pageSignIn.mount();\n  });\n\n  inputWrapper.append(resetEmailElement);\n};\n\nconst getAnimation = () => {\n  const imageDiv = page.pageEl.querySelector('.auth-image') as HTMLDivElement;\n  const size = mediaSizes.isMobile ? 100 : 166;\n  if(authSentCode.type._ === 'auth.sentCodeTypeFragmentSms') {\n    if(imageDiv.firstElementChild) {\n      monkey?.remove();\n      monkey = undefined;\n      imageDiv.replaceChildren();\n    }\n\n    const container = document.createElement('div');\n    container.classList.add('media-sticker-wrapper');\n    imageDiv.append(container);\n    return lottieLoader.loadAnimationAsAsset({\n      container: container,\n      loop: true,\n      autoplay: true,\n      width: size,\n      height: size\n    }, 'jolly_roger').then((animation) => {\n      player = animation;\n      return lottieLoader.waitForFirstFrame(animation);\n    }).then(() => {});\n  } else {\n    if(imageDiv.firstElementChild) {\n      player?.remove();\n      player = undefined;\n      imageDiv.replaceChildren();\n    }\n\n    monkey = new TrackingMonkey(codeInputField, size);\n    imageDiv.append(monkey.container);\n    return monkey.load();\n  }\n};\n\nconst handleResetEmail = () => {\n  rootScope.managers.apiManager.invokeApi('auth.resetLoginEmail', {\n    phone_number: authSentCode.phone_number,\n    phone_code_hash: authSentCode.phone_code_hash\n  }).then((code) => {\n    if(code._ === 'auth.sentCode') {\n      code.phone_number = authSentCode.phone_number;\n      authSentCode = code;\n      if(code.type._ === 'auth.sentCodeTypeEmailCode') {\n        updatePendingEmail(code.type);\n      } else {\n        render();\n      }\n    } else {\n      console.error(code);\n      toastNew({langPackKey: 'Error.AnError'});\n    }\n  }).catch((err: ApiError) => {\n    if(err.type.includes('TASK_ALREADY_EXISTS')) {\n      SimpleConfirmationPopup.show({\n        titleLangKey: 'Login.ResetEmail.NeedPremium',\n        descriptionLangKey: 'Login.ResetEmail.NeedPremiumText',\n        button: {\n          langKey: 'OK'\n        }\n      })\n    } else {\n      console.error(err);\n      toastNew({langPackKey: 'Error.AnError'});\n    }\n  })\n}\n\nconst updatePendingEmail = (code: AuthSentCodeType.authSentCodeTypeEmailCode) => {\n  if(resetEmailTimer) clearTimeout(resetEmailTimer);\n\n  if(code.reset_pending_date != null) {\n    const diff = code.reset_pending_date - tsNow(true);\n    if(diff <= 0 || code.reset_pending_date <= 0) {\n      resetEmailElement.replaceChildren(i18n('Login.ResetEmail.PleaseWait'));\n      handleResetEmail();\n      return\n    }\n\n    resetEmailElement.replaceChildren(i18n('Login.ResetEmail.Pending', [\n      wrapFormattedDuration(formatDuration(diff, 2)),\n      anchorCallback(handleResetEmail)\n    ]));\n    resetEmailTimer = ctx.setTimeout(() => updatePendingEmail(code), 30_000);\n    return;\n  }\n\n  if(code.reset_available_period != null) {\n    resetEmailElement.replaceChildren(i18n('TroubleEmail', [\n      anchorCallback(() => {\n        SimpleConfirmationPopup.show({\n          titleLangKey: 'Login.ResetEmail.Title',\n          descriptionLangKey: 'Login.ResetEmail.Text',\n          descriptionArgs: [wrapFormattedDuration(formatDuration(code.reset_available_period, 2))],\n          button: {\n            langKey: 'Login.ResetEmail.Title'\n          }\n        }).then(() => {\n          handleResetEmail();\n        })\n      })\n    ]));\n  }\n}\n\nconst render = () => {\n  if(!headerElement) {\n    headerElement = page.pageEl.getElementsByClassName('phone')[0] as HTMLHeadElement;\n    sentTypeElement = page.pageEl.getElementsByClassName('sent-type')[0] as HTMLParagraphElement;\n  } else {\n    codeInputField.value = '';\n  }\n\n  const CODE_LENGTH = (authSentCode.type as AuthSentCodeType.authSentCodeTypeApp).length;\n  if(!codeInputField) {\n    codeInputField = new CodeInputFieldCompat({\n      length: CODE_LENGTH,\n      onChange: (code) => {\n        codeInputField.error = false;\n        replaceContent(codeInputErrorLabel, '');\n      },\n      onFill: (code) => {\n        submitCode(code);\n      }\n    });\n  }\n\n  codeInputField.options.length = CODE_LENGTH;\n\n  headerElement.innerText = authSentCode.phone_number;\n  if(!resetEmailElement) {\n    resetEmailElement = document.createElement('div');\n    resetEmailElement.classList.add('forgot-link');\n  }\n  resetEmailElement.innerHTML = '';\n  if(resetEmailTimer) clearTimeout(resetEmailTimer);\n\n  let key: LangPackKey, args: any[];\n  const authSentCodeType = authSentCode.type;\n  switch(authSentCodeType._) {\n    case 'auth.sentCodeTypeSms':\n      key = 'Login.Code.SentSms';\n      break;\n    case 'auth.sentCodeTypeApp':\n      key = 'Login.Code.SentInApp';\n      break;\n    case 'auth.sentCodeTypeCall':\n      key = 'Login.Code.SentCall';\n      break;\n    case 'auth.sentCodeTypeFragmentSms':\n      key = 'PhoneNumber.Code.Fragment.Info';\n      const a = document.createElement('a');\n      setBlankToAnchor(a);\n      a.href = authSentCodeType.url;\n      args = [a];\n      break;\n    case 'auth.sentCodeTypeEmailCode':\n      key = 'Login.Code.SentEmail';\n      args = [wrapEmailPattern(authSentCodeType.email_pattern)];\n      updatePendingEmail(authSentCodeType);\n      break;\n    default:\n      key = 'Login.Code.SentUnknown';\n      args = [authSentCodeType._];\n      break;\n  }\n\n  replaceContent(sentTypeElement, i18n(key, args));\n\n  rootScope.managers.appStateManager.pushToState('authState', {_: 'authStateAuthCode', sentCode: authSentCode});\n\n  return getAnimation().catch(() => {});\n}\n\nconst page = new Page('page-authCode', true, onFirstMount, (_authCode: typeof authSentCode) => {\n  authSentCode = _authCode;\n  render()\n}, () => {\n  fastRaf(() => {\n    codeInputField?.input.focus();\n  })\n});\n\nexport default page;\n"],"file":"pageAuthCode-Du-olF5l.js"}