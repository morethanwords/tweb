const __vite__fileDeps=["./pageIm-BRUGiFEv.js","./index-B7WIMVLo.js","./index-C-9gLbWc.css","./page-CFQq45dV.js","./pagePassword-D3zlZLbH.js","./putPreloader-BhMVPekh.js","./loginPage-E29Tlywq.js","./htmlToSpan-DhAls8qz.js","./wrapDuration-N7gVnHGH.js","./toast-CTXjJKhu.js","./pageSignIn-B3Hc6RvL.js","./countryInputField-CGoQGdNE.js","./qr-code-styling-CvBVNv73.js","./_commonjsHelpers-Cpj98o6Y.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{q as g,B as A,l as $,d as l,h as z,v as J,M as W,x as j,G as N,H as X,_ as h,D as G,z as Y,k as Z,A as C,J as R}from"./index-B7WIMVLo.js";import{P as ee}from"./page-CFQq45dV.js";import{p as M}from"./putPreloader-BhMVPekh.js";import{I as te,g as ae,t as D,b as ne,f as re,a as oe}from"./toast-CTXjJKhu.js";let x=!1;function se(){return O||(O=l.managers.apiManager.getConfig().then(t=>t.suggested_lang_code!==g.lastRequestedLangCode?Promise.all([t,g.getStrings(t.suggested_lang_code,["Login.ContinueOnLanguage"]),g.getCacheLangPackAndApply()]):[]))}let O;function ie(t){x||se().then(([a,s])=>{if(!a)return;const i=[];s.forEach(r=>{const p=g.strings.get(r.key);p&&(i.push(p),g.strings.set(r.key,r))});const n="Login.ContinueOnLanguage",e=A("btn-primary btn-secondary btn-primary-transparent primary",{text:n});e.lastElementChild.classList.remove("i18n"),$({text:[g.format(n,!0)]}).then(()=>{window.requestAnimationFrame(()=>{t.append(e)})}),l.addEventListener("language_apply",()=>{e.remove()},{once:!0}),i.forEach(r=>{g.strings.set(r.key,r)}),z(e,r=>{J(r),x=!0,e.disabled=!0,M(e),g.getLangPackAndApply(a.suggested_lang_code)})})}function q(t){let a,s="";for(let i=t.length,n=0,e=0;e<i;++e)a=e%3,n|=t[e]<<(16>>>a&24),(a===2||i-e===1)&&(s+=String.fromCharCode(L(n>>>18&63),L(n>>>12&63),L(n>>>6&63),L(n&63)),n=0);return s.replace(/A(?=A$|$)/g,"=")}function L(t){return t<26?t+65:t<52?t+71:t<62?t-4:t===62?43:t===63?47:65}W.bytesToBase64=q;const ce=()=>{if(!te)return;let t,a;const s=A("btn-primary btn-secondary btn-primary-transparent primary hide",{text:"Login.Passkey"}),i=()=>Promise.all([l.managers.apiManager.getBaseDcId(),l.managers.appAccountManager.initPasskeyLogin()]).then(([n,e])=>{a=n||void 0,t=e.options.data,s.classList.remove("hide")});return s.addEventListener("click",async()=>{const n=j(s,!0);try{const e=await N.getUserIds(),r=await navigator.credentials.get({publicKey:PublicKeyCredential.parseRequestOptionsFromJSON(JSON.parse(t).publicKey)}),p=ae(r),[f,I]=p.response.user_handle.split(":").map(u=>parseInt(u)),k=e.indexOf(I);if(k!==-1){X(k+1);return}await l.managers.apiManager.setBaseDcId(f),await l.managers.appAccountManager.finishPasskeyLogin(p,a===f?void 0:a),h(()=>import("./pageIm-BRUGiFEv.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(u=>u.default.mount())}catch(e){if(e.type==="SESSION_PASSWORD_NEEDED"){h(()=>import("./pagePassword-D3zlZLbH.js"),__vite__mapDeps([4,1,2,5,3,6,7,8,9,10,11]),import.meta.url).then(r=>r.default.mount());return}else e.type==="PASSKEY_CREDENTIAL_NOT_FOUND"?D({langPackKey:"Login.Passkey.Error.NotFound"}):D({langPackKey:"Login.Passkey.Error"});throw await i(),n(),e}}),{button:s,fetch:i}},B=3,le=async()=>{const a=Q.pageEl.querySelector(".auth-image");let s=M(a,!0);const i=document.createElement("div");i.classList.add("input-wrapper");const n=A("btn-primary btn-secondary btn-primary-transparent primary",{text:"Login.QR.Cancel"}),e=ce();i.append(...[n,e?.button].filter(Boolean)),G()===1&&ie(i);const r=a.parentElement,p=document.createElement("h4");Y(p,"Login.QR.Title");const f=document.createElement("ol");f.classList.add("qr-description"),["Login.QR.Help1","Login.QR.Help2","Login.QR.Help3"].forEach(d=>{const m=document.createElement("li");m.append(Z(d)),f.append(m)}),r.append(p,f,i),n.addEventListener("click",()=>{h(()=>import("./pageSignIn-B3Hc6RvL.js"),__vite__mapDeps([10,1,2,5,3,11,9]),import.meta.url).then(d=>d.default.mount()),u=!0});const k=(await Promise.all([h(()=>import("./qr-code-styling-CvBVNv73.js").then(d=>d.q),__vite__mapDeps([12,13]),import.meta.url)]))[0].default;let u=!1;l.addEventListener("user_auth",d=>{u=!0,E=null},{once:!0});const S={ignoreErrors:!0};let w;const V=async d=>{try{const m=await N.getUserIds();let c=await l.managers.apiManager.invokeApi("auth.exportLoginToken",{api_id:C.id,api_hash:C.hash,except_ids:m.map(_=>_.toUserId())},{ignoreErrors:!0});if(c._==="auth.loginTokenMigrateTo"&&(S.dcId||(S.dcId=c.dc_id,l.managers.apiManager.setBaseDcId(c.dc_id)),c=await l.managers.apiManager.invokeApi("auth.importLoginToken",{token:c.token},S)),c._==="auth.loginTokenSuccess"){const _=c.authorization;return await l.managers.apiManager.setUser(_.user),h(()=>import("./pageIm-BRUGiFEv.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(y=>y.default.mount()),!0}if(!w||!ne(w,c.token)){w=c.token;const _=q(c.token),y="tg://login?token="+re(_,!0),v=window.getComputedStyle(document.documentElement),F=v.getPropertyValue("--surface-color").trim(),H=v.getPropertyValue("--primary-text-color").trim(),K=v.getPropertyValue("--primary-color").trim(),U=await fetch("assets/img/logo_padded.svg").then(o=>o.text()).then(o=>(o=o.replace(/(fill:).+?(;)/,`$1${K}$2`),oe(o))),P=new k({width:240*window.devicePixelRatio,height:240*window.devicePixelRatio,data:y,image:U,dotsOptions:{color:H,type:"rounded"},cornersSquareOptions:{type:"extra-rounded"},imageOptions:{imageSize:1,margin:0},backgroundOptions:{color:F},qrOptions:{errorCorrectionLevel:"L"}});P.append(a),a.lastChild.classList.add("qr-canvas");let T;P._drawingPromise?T=P._drawingPromise:T=Promise.race([R(1e3),new Promise(o=>{P._canvas._image.addEventListener("load",()=>{window.requestAnimationFrame(()=>o())},{once:!0})})]),await T.then(()=>{if(s){s.style.animation="hide-icon .4s forwards";const o=a.children[1];o.style.display="none",o.style.animation="grow-icon .4s forwards",setTimeout(()=>{o.style.display=""},150),setTimeout(()=>{o.style.animation=""},500),s=void 0}else Array.from(a.children).slice(0,-1).forEach(o=>{o.remove()})})}if(d){const _=Date.now()/1e3,y=c.expires-_-await l.managers.timeManager.getServerTimeOffset();await R(y>B?1e3*B:1e3*y|0)}}catch(m){switch(m.type){case"SESSION_PASSWORD_NEEDED":h(()=>import("./pagePassword-D3zlZLbH.js"),__vite__mapDeps([4,1,2,5,3,6,7,8,9,10,11]),import.meta.url).then(c=>c.default.mount()),u=!0,E=null;break;case"AUTH_TOKEN_EXPIRED":return console.warn("pageSignQR: AUTH_TOKEN_EXPIRED"),!1;default:console.error("pageSignQR: default error:",m),u=!0;break}return!0}return!1};let b=!0;return async()=>{b&&(b=!1,e&&e.fetch()),u=!1;do if(u||await V(!0))break;while(!0)}};let E;const Q=new ee("page-signQR",!0,()=>E,()=>{E||(E=le()),E.then(t=>{t()}),l.managers.appStateManager.pushToState("authState",{_:"authStateSignQr"})}),me=Object.freeze(Object.defineProperty({__proto__:null,default:Q},Symbol.toStringTag,{value:"Module"}));export{ce as P,me as a,ie as g,Q as p};
//# sourceMappingURL=pageSignQR-C3BPFinV.js.map
