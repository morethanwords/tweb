import{dR as y,c as A,a7 as N,bB as D,b as s,ab as h,a2 as k,i as f,t as M,bG as I,af as w,aS as G,bn as O,aU as K,ag as V,ah as U,ce as $,aQ as L,bE as q,ad as H}from"./index-HSqJgTYz.js";import{u as j,S as Q}from"./saveButton-CuVHe3xN.js";import{ab as b,a5 as _,ad as W,a7 as z}from"./appDialogsManager-BdIzaAuR.js";import{T as x}from"./transition-bwrAB1aO.js";import{a as T}from"./wrapDuration-CUsLGsVf.js";import{S as C}from"./staticRadio-DCp-0a9y.js";import{S as J}from"./starsRangeInput-BXvJfA9R.js";import{u as X}from"./useStarsCommissionAndWithdrawalPrice-Cmg3y8bT.js";import"./iconTsx-SAombbu3.js";import"./classNames-CN4lTu6a.js";import"./page-BeYz3P4e.js";import"./putPreloader-CzgYdOgH.js";import"./avatar-BYUj9Qii.js";import"./htmlToSpan-DhAls8qz.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./toast-zd2DaNCI.js";import"./fastBlur-Co-79rP4.js";import"./emailSetup-BUamKkuk.js";import"./countryInputField-BmBCQw3f.js";import"./scrollable2-CmNzxNOF.js";import"./chatBackground-Vu9g_UWZ.js";import"./tracking-CdvUn1_N.js";import"./useAppConfig-BIscvbuN.js";var p=(e=>(e[e.Everybody=1]="Everybody",e[e.ContactsAndPremium=2]="ContactsAndPremium",e[e.Paid=3]="Paid",e))(p||{});const F="inputPrivacyKeyNoPaidMessages",Y=[{_:"inputPrivacyValueAllowContacts"}],v=120,B=()=>{const{rootScope:e}=y(),[l,o]=A(e.premium),i=new D;return i.add(e)("premium_toggle",u=>{o(u)}),N(()=>{i.removeAll()}),l},Z=10,ee=e=>{const{PopupPremium:l,i18n:o,toastNew:i,hideToast:u,Row:n}=y(),c=B(),m=t=>()=>{if(c())return t();i({langPackKey:"PrivacySettings.Messages.PremiumError",langPackArguments:[T(()=>{u(),l.show({feature:"message_privacy"})})]})},P=s(x,{mode:"outin",onEnter:async(t,a)=>{await t.animate({opacity:[0,1]},{duration:v}).finished,a()},onExit:async(t,a)=>{const r=t.animate({opacity:[1,0]},{duration:v}).finished;e.onExitAnimationPromise(r),await r,a()},get children(){return h(()=>!e.isPaid)()?o("Privacy.MessagesInfo",[T(()=>void l.show())]):o("PaidMessages.ChargeForMessagesDescription")}});return s(b,{name:"PrivacyMessagesTitle",caption:P,get children(){return[s(n,{clickable:()=>{e.setStore("option",p.Everybody)},get children(){return[s(n.CheckboxField,{get children(){return s(C,{floating:!0,get checked(){return e.store.option===p.Everybody}})}}),s(n.Title,{get children(){return o("PrivacySettingsController.Everbody")}})]}}),s(n,{get clickable(){return m(()=>{e.setStore("option",p.ContactsAndPremium)})},get children(){return[h(()=>h(()=>!!c())()&&s(n.CheckboxField,{get children(){return s(C,{floating:!0,get checked(){return e.store.option===p.ContactsAndPremium}})}})),h(()=>h(()=>!c())()&&s(n.Icon,{icon:"premium_lock"})),s(n.Title,{get children(){return o("Privacy.ContactsAndPremium")}})]}}),s(n,{get clickable(){return m(()=>{e.setStore(t=>({option:p.Paid,stars:t.stars||Z}))})},get children(){return[h(()=>h(()=>!!c())()&&s(n.CheckboxField,{get children(){return s(C,{floating:!0,get checked(){return e.isPaid}})}})),h(()=>h(()=>!c())()&&s(n.Icon,{icon:"premium_lock"})),s(n.Title,{get children(){return o("PaidMessages.ChargeForMessages")}})]}})]}})},te=M("<span class=primary>"),re=M("<div>"),se=e=>{const[l,{AppAddMembersTab:o}]=_(),{i18n:i,join:u,Row:n}=y(),{commissionPercents:c,willReceiveDollars:m}=X(()=>e.store.stars),P=()=>{l.slider.createTab(o).open({type:"privacy",skippable:!0,title:"PaidMessages.RemoveFee",placeholder:"PrivacyModal.Search.Placeholder",takeOut:a=>{e.setStore("chosenPeers",a)},selectedPeerIds:[...e.store.chosenPeers]})},t=()=>{if(!e.store.chosenPeers.length)return i("PrivacySettingsController.AddUsers");const{users:a,chats:r}=e.chosenPeersByType;return u([a.length?i("Users",[a.length]):null,r.length?i("Chats",[r.length]):null].filter(Boolean),!1)};return s(x,{onEnter:async(a,r)=>{const d=a;d.style.opacity="0",await e.exitAnimationPromise,await d.animate({opacity:[0,1]},{duration:v}).finished,d.style.removeProperty("opacity"),r()},onExit:async(a,r)=>{await a.animate({opacity:[1,0]},{duration:v}).finished,r()},get children(){return s(k,{get when(){return e.isPaid},get children(){const a=re();return f(a,s(b,{name:"PaidMessages.SetPrice",caption:"PaidMessages.SetPriceDescription",get captionArgs(){return[c(),m()]},get children(){return s(J,{get value(){return e.store.stars},get onChange(){return e.setStore.bind(null,"stars")}})}}),null),f(a,s(b,{name:"PrivacyExceptions",caption:"PaidMessages.RemoveFeeDescription",get children(){return s(n,{clickable:P,get children(){return[s(n.Title,{get children(){return i("PaidMessages.RemoveFee")}}),s(n.RightContent,{get children(){const r=te();return f(r,t),r}})]}})}}),null),a}})}})},E=I("useSaveSettings"),ne=({store:e,globalPrivacy:l,isPaid:o,hasChanges:i,chosenPeersByType:u})=>{const{rootScope:n}=y(),[c]=_(),m=()=>{const r=structuredClone(l());r.noncontact_peers_paid_stars=o()?e.stars:0,r.pFlags??(r.pFlags={}),W(r.pFlags,"new_noncontact_peers_require_premium",e.option===p.ContactsAndPremium),E("saving settings :>> ",r);const d=n.managers.appPrivacyManager.setGlobalPrivacySettings(r);return c.payload.onSaved(d),d},P=async()=>{const r=[],{chats:d,users:g}=u();return r.push(...Y),d.length&&r.push({_:"inputPrivacyValueAllowChatParticipants",chats:d}),g.length&&r.push({_:"inputPrivacyValueAllowUsers",users:await Promise.all(g.map(S=>n.managers.appUsersManager.getUserInput(S)))}),E("saving rules :>> ",r),n.managers.appPrivacyManager.setPrivacy(F,r)};let t=!1;return async()=>{if(!(t||!i())){t=!0;try{await Promise.all([m(),o()?P():void 0]),c.close()}finally{t=!1}}}},ae=e=>e instanceof Object?e.user_id?.toPeerId(!0):e.toPeerId(!0),oe=()=>{const{rootScope:e}=y(),l=z(),o=B(),[i]=w(()=>{const t=e.managers.appPrivacyManager.getPrivacy(F);return l.collect(t),t}),[u]=w(()=>{const t=e.managers.appPrivacyManager.getGlobalPrivacySettings();return l.collect(t),t});return{isReady:()=>i.state==="ready"&&u.state==="ready",globalPrivacy:u,privacyRules:i,currentOption:()=>o()?u().noncontact_peers_paid_stars?p.Paid:u().pFlags.new_noncontact_peers_require_premium?p.ContactsAndPremium:p.Everybody:p.Everybody,currentAllowedUsers:()=>i()?.filter(t=>t._==="privacyValueAllowUsers")?.map(t=>t?.users).flat()?.map(t=>t.toPeerId())||[],currentAllowedChats:()=>i()?.find(t=>t._==="privacyValueAllowChatParticipants")?.chats?.map(ae)?.filter(t=>t!==void 0)||[]}},ie=({isReady:e,globalPrivacy:l,currentOption:o,currentAllowedChats:i,currentAllowedUsers:u})=>{let n={};const[c,m]=G({});O(()=>{e()&&(n={option:o(),stars:Number(l().noncontact_peers_paid_stars)||void 0,chosenPeers:[...u(),...i()]},m(K(structuredClone(n))))});const[P,t]=A(!1),a=V(t,200,!0);U(()=>{const g=r()?[]:["chosenPeers","stars"];a(!$(c,n,g))});const r=L(()=>c.option===p.Paid);return[c,m,{hasChanges:P,isPaid:r,chosenPeersByType:()=>({chats:c.chosenPeers.filter(g=>g.isAnyChat()).map(g=>g.toChatId()),users:c.chosenPeers.filter(g=>g.isUser())})}]},R=I("MessagesPrivacyTab"),Ie=()=>{const[e]=_(),{isReady:l,globalPrivacy:o,privacyRules:i,currentOption:u,currentAllowedUsers:n,currentAllowedChats:c}=oe(),[m,P,{isPaid:t,hasChanges:a,chosenPeersByType:r}]=ie({isReady:l,globalPrivacy:o,currentOption:u,currentAllowedChats:c,currentAllowedUsers:n}),d=ne({store:m,globalPrivacy:o,isPaid:t,hasChanges:a,chosenPeersByType:r});e.isConfirmationNeededOnClose=j({hasChanges:a,saveAllSettings:d,descriptionLangKey:"UnsavedChangesDescription.Privacy"});const[g,S]=A();return q&&U(()=>{R("privacyRules() :>> ",i()),R("globalPrivacy() :>> ",o())}),s(k,{get when(){return l()},get children(){return[s(H,{get mount(){return e.header},get children(){return s(Q,{get hasChanges(){return a()},onClick:()=>void d()})}}),s(ee,{get isPaid(){return t()},store:m,setStore:P,onExitAnimationPromise:S}),s(se,{get isPaid(){return t()},store:m,setStore:P,get chosenPeersByType(){return r()},get exitAnimationPromise(){return g()}})]}})};export{Ie as default};
//# sourceMappingURL=tab-joqvI7GM.js.map
