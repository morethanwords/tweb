(this.webpackJsonp=this.webpackJsonp||[]).push([[6],{101:function(e,t,s){"use strict";var a=s(29);class i{constructor(){this.tempNum=0}generateMessageId(e,t=!1){const s=i.MESSAGE_ID_OFFSET,a=t?++this.tempNum:0;return e>=s?t?e+(a&i.MESSAGE_ID_INCREMENT-1):e:s+(e*i.MESSAGE_ID_INCREMENT+(a&i.MESSAGE_ID_INCREMENT-1))}getServerMessageId(e){return this.clearMessageId(e,!0)}clearMessageId(e,t){const s=i.MESSAGE_ID_OFFSET;if(e<s)return e;const a=i.MESSAGE_ID_INCREMENT-1,n=e&a;return n!==a&&(e-=n+1),t?(e-s)/i.MESSAGE_ID_INCREMENT:e}incrementMessageId(e,t){return this.generateMessageId(this.getServerMessageId(e)+t)}}i.MESSAGE_ID_INCREMENT=65536,i.MESSAGE_ID_OFFSET=4294967295;const n=new i;a.a&&(a.a.appMessagesIdsManager=n),t.a=n},102:function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var a=s(56),i=s(41),n=s(34),o=s(5),r=s(30),d=s(60);class l{constructor(e){this.tempId=0,this.detached=!0,this.promise=null,this.isUpload=!1,this.cancelable=!0,this.streamable=!1,this.tryAgainOnFail=!0,this.attachMethod="append",this.onClick=e=>{e&&Object(o.a)(e),this.preloader.classList.contains("manual")?this.loadFunc&&this.loadFunc(e):this.promise&&this.promise.cancel&&this.promise.cancel()},e&&Object(n.g)(this,e)}constructContainer(e={}){this.preloader||(this.preloader=document.createElement("div"),this.preloader.classList.add("preloader-container"),e.color&&this.preloader.classList.add("preloader-"+e.color),e.bold&&this.preloader.classList.add("preloader-bold"),this.streamable&&this.preloader.classList.add("preloader-streamable"))}constructDownloadIcon(){this.constructContainer()}construct(){this.construct=null,this.constructContainer(),this.preloader.innerHTML=`\n    <div class="you-spin-me-round">\n    <svg xmlns="http://www.w3.org/2000/svg" class="preloader-circular" viewBox="${this.streamable?"25 25 50 50":"27 27 54 54"}">\n    <circle class="preloader-path-new" cx="${this.streamable?"50":"54"}" cy="${this.streamable?"50":"54"}" r="${this.streamable?19:24}" fill="none" stroke-miterlimit="10"/>\n    </svg>\n    </div>`,this.streamable?this.totalLength=118.61124420166016:this.totalLength=149.82473754882812,this.cancelable?(this.preloader.innerHTML+='\n      <svg xmlns="http://www.w3.org/2000/svg" class="preloader-close" viewBox="0 0 24 24">\n        <g fill="none" fill-rule="evenodd">\n          <polygon points="0 0 24 0 24 24 0 24"/>\n          <path fill="#000" fill-rule="nonzero" d="M5.20970461,5.38710056 L5.29289322,5.29289322 C5.65337718,4.93240926 6.22060824,4.90467972 6.61289944,5.20970461 L6.70710678,5.29289322 L12,10.585 L17.2928932,5.29289322 C17.6834175,4.90236893 18.3165825,4.90236893 18.7071068,5.29289322 C19.0976311,5.68341751 19.0976311,6.31658249 18.7071068,6.70710678 L13.415,12 L18.7071068,17.2928932 C19.0675907,17.6533772 19.0953203,18.2206082 18.7902954,18.6128994 L18.7071068,18.7071068 C18.3466228,19.0675907 17.7793918,19.0953203 17.3871006,18.7902954 L17.2928932,18.7071068 L12,13.415 L6.70710678,18.7071068 C6.31658249,19.0976311 5.68341751,19.0976311 5.29289322,18.7071068 C4.90236893,18.3165825 4.90236893,17.6834175 5.29289322,17.2928932 L10.585,12 L5.29289322,6.70710678 C4.93240926,6.34662282 4.90467972,5.77939176 5.20970461,5.38710056 L5.29289322,5.29289322 L5.20970461,5.38710056 Z"/>\n        </g>\n      </svg>\n      <svg xmlns="http://www.w3.org/2000/svg" class="preloader-download" viewBox="0 0 24 24">\n        <g fill="none" fill-rule="evenodd">\n          <polygon points="0 0 24 0 24 24 0 24"/>\n          <path fill="#000" fill-rule="nonzero" d="M5,19 L19,19 C19.5522847,19 20,19.4477153 20,20 C20,20.5128358 19.6139598,20.9355072 19.1166211,20.9932723 L19,21 L5,21 C4.44771525,21 4,20.5522847 4,20 C4,19.4871642 4.38604019,19.0644928 4.88337887,19.0067277 L5,19 L19,19 L5,19 Z M11.8833789,3.00672773 L12,3 C12.5128358,3 12.9355072,3.38604019 12.9932723,3.88337887 L13,4 L13,13.585 L16.2928932,10.2928932 C16.6533772,9.93240926 17.2206082,9.90467972 17.6128994,10.2097046 L17.7071068,10.2928932 C18.0675907,10.6533772 18.0953203,11.2206082 17.7902954,11.6128994 L17.7071068,11.7071068 L12.7071068,16.7071068 C12.3466228,17.0675907 11.7793918,17.0953203 11.3871006,16.7902954 L11.2928932,16.7071068 L6.29289322,11.7071068 C5.90236893,11.3165825 5.90236893,10.6834175 6.29289322,10.2928932 C6.65337718,9.93240926 7.22060824,9.90467972 7.61289944,10.2097046 L7.70710678,10.2928932 L11,13.585 L11,4 C11,3.48716416 11.3860402,3.06449284 11.8833789,3.00672773 L12,3 L11.8833789,3.00672773 Z"/>\n        </g>\n      </svg>',this.downloadSvg=this.preloader.lastElementChild,this.cancelSvg=this.downloadSvg.previousElementSibling):this.preloader.classList.add("preloader-swing"),this.circle=this.preloader.firstElementChild.firstElementChild.firstElementChild,this.cancelable&&Object(r.b)(this.preloader,this.onClick)}setDownloadFunction(e){this.loadFunc=e}setManual(){this.preloader.classList.add("manual"),this.setProgress(0)}attachPromise(e){if(this.isUpload&&this.promise)return;this.promise=e;const t=--this.tempId,s=Date.now(),a=a=>{if(e.notify=e.notifyAll=null,t!==this.tempId)return;const n=Date.now()-s;if(!a&&this.cancelable){this.setProgress(100);const e=150;n<e?this.detach():setTimeout(()=>{t===this.tempId&&this.detach()},e)}else this.tryAgainOnFail?(this.attach(this.preloader.parentElement),Object(i.b)(()=>{this.setManual()})):this.detach();this.promise=e=null};e.then(()=>a(null)).catch(e=>a(e)),e.addNotifyListener&&e.addNotifyListener(e=>{if(t!==this.tempId)return;const s=e.done/e.total*100;this.setProgress(s)})}attach(e,t=!1,s){if(this.construct&&this.construct(),this.preloader.parentElement&&this.preloader.classList.remove("manual"),this.detached=!1,s&&this.attachPromise(s),this.detached||this.preloader.parentElement!==e){const t=Object(d.a)(this.preloader)?1:2;this.preloader.parentElement!==e&&e[this.attachMethod](this.preloader),Object(a.a)(this.preloader,"is-visible",!0,200,void 0,t)}this.cancelable&&t&&this.setProgress(0)}detach(){this.detached||(this.detached=!0,this.preloader&&this.preloader.parentElement&&Object(a.a)(this.preloader,"is-visible",!1,200,()=>{this.preloader.remove()},1))}setProgress(e){if(this.totalLength||Object(d.a)(this.circle))if(0!==e)try{this.totalLength||(this.totalLength=this.circle.getTotalLength()),this.circle.style.strokeDasharray=Math.max(5,e/100*this.totalLength)+", "+this.totalLength}catch(e){}else this.circle.style.strokeDasharray=""}}},103:function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return d})),s.d(t,"a",(function(){return l})),s.d(t,"e",(function(){return h})),s.d(t,"d",(function(){return c})),s.d(t,"f",(function(){return g}));var a=s(37),i=s(81),n=s(0),o=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};function r(e){let t,s;return e instanceof HTMLVideoElement?(t=e.videoWidth,s=e.videoHeight):(t=e.naturalWidth,s=e.naturalHeight),i={media:e,mediaSize:Object(a.c)(t,s),boxSize:Object(a.c)(320,240),quality:.9},new Promise(e=>{var t,s;const a=document.createElement("canvas"),n=i.mediaSize.aspectFitted(i.boxSize);a.width=n.width*window.devicePixelRatio,a.height=n.height*window.devicePixelRatio,a.getContext("2d").drawImage(i.media,0,0,a.width,a.height),a.toBlob(t=>{e({blob:t,size:n})},null!==(t=i.mimeType)&&void 0!==t?t:"image/jpeg",null!==(s=i.quality)&&void 0!==s?s:1)});var i}function d(e){return new Promise((t,s)=>{e.onseeked=()=>{e.onseeked=()=>{r(e).then(t),e.onseeked=void 0},e.currentTime=0},e.onerror=s,e.currentTime=Math.min(e.duration,1)})}function l(e){return o(this,void 0,void 0,(function*(){const t=yield function(e){return new Promise((t,s)=>{const a=document.createElement("video");a.volume=0,a.addEventListener("loadedmetadata",()=>t(a),{once:!0}),a.addEventListener("error",s,{once:!0}),a.src=e})}(e);return Promise.race([Object(i.a)(2e3),d(t)])}))}function h(e,t=e.HAVE_METADATA,s){return new Promise(a=>{e.readyState>=t?a():e.addEventListener(n.IS_APPLE_MOBILE&&!s?"loadeddata":"canplay",()=>a(),{once:!0})})}function c(e,t=!1){return o(this,void 0,void 0,(function*(){const s=[],a=(e,i)=>o(this,void 0,void 0,(function*(){if(e.isDirectory){const t=e.createReader();yield new Promise((e,s)=>{t.readEntries(t=>o(this,void 0,void 0,(function*(){for(const e of t)yield a(e,i);e()})))})}else if(e)if(t)s.push(e.type);else{const t=i.getAsFile(),a=e instanceof File?e:e instanceof DataTransferItem?e.getAsFile():yield new Promise((s,a)=>e.file(s,e=>s(t)));if(!a)return;s.push(a)}}));if(e instanceof DragEvent&&e.dataTransfer.files&&!e.dataTransfer.items)for(let a=0;a<e.dataTransfer.files.length;a++){const i=e.dataTransfer.files[a];s.push(t?i.type:i)}else{const s=(e.dataTransfer||e.clipboardData||e.originalEvent.clipboardData).items,i=[];for(let e=0;e<s.length;++e){const n=s[e];if("file"===n.kind){const e=(t?n:n.webkitGetAsEntry())||n.getAsFile();i.push(a(e,n))}}yield Promise.all(i)}return s}))}function g(e){const t=document.createElement("input");t.type="file",t.style.display="none",e&&(t.accept=e),document.body.append(t);const s=new Promise((e,s)=>{t.addEventListener("change",t=>{const a=t.target.files[0];a?e(a):s("NO_FILE_SELECTED")},{once:!0})}).finally(()=>{t.remove()});return t.click(),s}},107:function(e,t,s){"use strict";function a(e){}s.d(t,"a",(function(){return a}))},108:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));const a=()=>{let e={cleaned:!1};return{clean:()=>{e.cleaned=!0,e={cleaned:!1}},get:()=>{const t=e;return()=>!t.cleaned}}}},111:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var a=s(123);class i{constructor(e,t=0){this.options=e,this.minChars=t,this.fullTexts=new Map}indexObject(e,t){if(this.options&&t.trim()&&(t=Object(a.c)(t,this.options)),!t)return this.fullTexts.delete(e),!1;this.fullTexts.set(e,t)}search(e){const t=this.fullTexts;this.options&&(e=Object(a.c)(e,this.options));const s=[],i=e.split(" "),n=i.length;t.forEach((e,t)=>{let a=!0,o=0;for(let t=0;t<n;++t){const s=i[t],n=e.indexOf(s);if(-1===n||0!==n&&" "!==e[n-1]){a=!1;break}o+=s.length}if(a){o+=n-1;const a=e.length;(this.minChars<=o||a<=o)&&s.push({fullText:e,fullTextLength:a,what:t,foundChars:o})}}),s.sort((e,t)=>e.fullTextLength-t.fullTextLength||t.foundChars-e.foundChars);return new Set(s.map(e=>e.what))}}},112:function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return p}));var a=s(62);const i=new Map,n=new Set,o='Roboto, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif';let r;const d=()=>{cancelAnimationFrame(r),r=window.requestAnimationFrame(l)},l=()=>{n.forEach(h),n.clear()};window.addEventListener("resize",()=>{for(const[e]of i)n.add(e);d()},{capture:!0,passive:!0});const h=e=>{let t=i.get(e);const s=!t;let{text:n,textLength:r,from:d,multiplier:l,font:h,textWidth:c,elementWidth:p}=t||{};s&&(n=e.textContent,r=n.length,d=50,l=d>0&&d/100,h=`${e.dataset.fontWeight||400} 16px ${o}`,c=g(n,h),p=e.getBoundingClientRect().width,t={text:n,textLength:r,from:d,multiplier:l,font:h,textWidth:c,elementWidth:p},i.set(e,t));const u=e.getBoundingClientRect().width,f=s||p!==u;if(!s&&f&&(t.elementWidth=p=u),f)if(c>p){e.setAttribute("title",n);let s=n,i=p;for(;s.length>3;){let t=s.length;const n=l&&Object(a.a)(l*t<<0,1,t-2)||Math.max(t+d-1,1),o=s.substr(0,n).replace(/\s*$/,""),r=s.substr(n+1).replace(/^\s*/,"");if(s=o+r,i=g(s+"â€¦",h),i<p){e.textContent=o+"â€¦"+r;break}}t.elementWidth=e.getBoundingClientRect().width}else e.removeAttribute("title")};let c;function g(e,t){if(!c){const e=document.createElement("canvas");c=e.getContext("2d"),c.font=t}return c.measureText(e).width}class p extends HTMLElement{constructor(){super()}connectedCallback(){i.set(this,null),n.add(this),d()}disconnectedCallback(){i.delete(this)}}customElements.define("middle-ellipsis-element",p)},113:function(e,t,s){"use strict";var a=s(15),i=s(42),n=s(39),o=s(79),r=s(31),d=s(68),l=s(32),h=s(54),c=s(34),g=s(144),p=s(29),u=s(80),f=s(101),m=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};const _=new class{constructor(){this.drafts={},this.getAllDraftPromise=null,u.a.get("drafts").then(e=>{this.drafts=e||{}}),a.default.addMultipleEventsListeners({updateDraftMessage:e=>{const t=i.a.getPeerId(e.peer);this.saveDraft(t,e.threadId,e.draft,{notify:!0})}})}getKey(e,t){return e+(t?"_"+t:"")}getDraft(e,t){return this.drafts[this.getKey(e,t)]}addMissedDialogs(){return this.getAllDrafts().then(()=>{for(const e in this.drafts){if(-1!==e.indexOf("_"))continue;const t=e.toPeerId();n.a.getDialogOnly(t)||n.a.reloadConversation(t)}})}getAllDrafts(){return this.getAllDraftPromise||(this.getAllDraftPromise=l.a.invokeApi("messages.getAllDrafts").then(e=>{(o.a.updatesState.syncLoading||Promise.resolve()).then(()=>{o.a.processUpdateMessage(e)})}))}saveDraft(e,t,s,i={}){const n=this.processApiDraft(s),o=this.getKey(e,t);return n?this.drafts[o]=n:delete this.drafts[o],u.a.set({drafts:this.drafts}),i.notify&&a.default.dispatchEvent("draft_updated",{peerId:e,threadId:t,draft:n,force:i.force}),n}draftsAreEqual(e,t){if(typeof e!=typeof t)return!1;if(!Object(g.a)(e))return!0;if(e._!==t._)return!1;if("draftMessage"===e._&&t._===e._){if(e.reply_to_msg_id!==t.reply_to_msg_id)return!1;if(!Object(c.b)(e.entities,t.entities))return!1;if(e.message!==t.message)return!1;if(e.pFlags.no_webpage!==t.pFlags.no_webpage)return!1}return!0}isEmptyDraft(e){return!e||"draftMessageEmpty"===e._||!(e.reply_to_msg_id>0)&&!e.message.length}processApiDraft(e){if(!e||"draftMessage"!==e._)return;const t=r.b.parseEntities(e.message),s=e.entities||[],a=r.b.mergeEntities(s.slice(),t);return e.rMessage=r.b.wrapDraftText(e.message,{entities:a}),e.reply_to_msg_id&&(e.reply_to_msg_id=f.a.generateMessageId(e.reply_to_msg_id)),e}syncDraft(e,t,s,a=!0,o=!1){return m(this,void 0,void 0,(function*(){const r=this.getDraft(e,t);if(this.draftsAreEqual(r,s))return!0;let c,g={peer:i.a.getInputPeerById(e),message:""};if(this.isEmptyDraft(s))c={_:"draftMessageEmpty"};else{let e=s.message,t=s.entities;s.reply_to_msg_id&&(g.reply_to_msg_id=f.a.getServerMessageId(s.reply_to_msg_id)),(null==t?void 0:t.length)&&(g.entities=n.a.getInputEntities(t)),s.pFlags.no_webpage&&(g.no_webpage=s.pFlags.no_webpage),g.message=e}const p=c||s;return p.date=Object(h.g)(!0)+d.a.serverTimeOffset,this.saveDraft(e,t,p,{notify:!0,force:o}),!(a&&!t)||l.a.invokeApi("messages.saveDraft",g)}))}clearAllDrafts(){return l.a.invokeApi("messages.clearAllDrafts").then(e=>{if(e)for(const e in this.drafts){const[t,s]=e.split("_");a.default.dispatchEvent("draft_updated",{peerId:t.toPeerId(),threadId:s?+s:void 0,draft:void 0})}})}clearDraft(e,t){t?this.syncDraft(e,t):this.saveDraft(e,t,null,{notify:!0,force:!0})}setDraft(e,t,s,a){const i={_:"draftMessage",date:Date.now()/1e3|0,message:s,pFlags:{},entities:a};t?this.syncDraft(e,t,i,!1,!0):this.saveDraft(e,t,i,{notify:!0,force:!0})}};p.a.appDraftsManager=_,t.a=_},114:function(e,t,s){"use strict";var a=s(96),i=s(36),n=s(58),o=s(47),r=s(31),d=s(15),l=s(73),h=s(42),c=s(50),g=s(40);const p=new class{constructor(){this.savedAvatarURLs={}}isAvatarCached(e){return!!this.savedAvatarURLs[e]}removeFromAvatarsCache(e){this.savedAvatarURLs[e]&&delete this.savedAvatarURLs[e]}loadAvatar(e,t,s){const a=h.a.getInputPeerById(e);let i,n=!1,o=this.savedAvatarURLs[e];if(o&&o[s])"string"!=typeof o[s]?i=o[s]:(i=Promise.resolve(o[s]),n=!0);else{o||(o=this.savedAvatarURLs[e]={});const n={_:"inputPeerPhotoFileLocation",pFlags:{},peer:a,photo_id:t.photo_id};"photo_big"===s&&(n.pFlags.big=!0);const r={dcId:t.dc_id,location:n},d=l.a.download(r);i=o[s]=d.then(e=>o[s]=URL.createObjectURL(e))}return{cached:n,loadPromise:i}}putAvatar(e,t,s,o,r=new Image,l=!1){let h,g,p,{cached:u,loadPromise:f}=this.loadAvatar(t,s,o);if(r.classList.add("avatar-photo"),u)g=()=>{Object(i.a)(e,r),e.dataset.color=""};else{const l=d.default.settings.animationsEnabled;if(l&&r.classList.add("fade-in"),"photo_big"===o){const a=this.putAvatar(e,t,s,"photo_small");h=a.loadPromise,p=a.thumbImage}else if(s.stripped_thumb){p=new Image,e.classList.add("avatar-relative"),p.classList.add("avatar-photo","avatar-photo-thumbnail");const t=c.a.getPreviewURLFromBytes(s.stripped_thumb);h=Object(a.b)(p,t).then(()=>{Object(i.a)(e,p)})}g=()=>{p?e.append(r):Object(i.a)(e,r),setTimeout(()=>{e.childElementCount&&n.a.mutateElement(r,()=>{e.dataset.color="",l&&r.classList.remove("fade-in"),p&&p.remove()})},l?200:0)}}const m=f.then(e=>Object(a.b)(r,e)).then(g);return{cached:u,loadPromise:h||m,thumbImage:p}}s(e,t,s,a){e.innerHTML=t,e.dataset.color=s,e.classList.remove("tgico-saved","tgico-deletedaccount","tgico-reply_filled"),a&&e.classList.add(a)}putPhoto(e,t,s=!1,a="",i=!1){var n;const l=d.default.myId;if(t===l&&s)return void this.s(e,"","","tgico-saved");if(t!==o.b&&t.isUser()){const s=g.a.getUser(t);if(s&&s.pFlags&&s.pFlags.deleted)return void this.s(e,"",h.a.getPeerColorById(t),"tgico-deletedaccount")}const c=h.a.getPeerPhoto(t),p=!!c,u=!!e.firstElementChild&&!e.firstElementChild.classList.contains("emoji");if(!p||!u||!this.savedAvatarURLs[t]){let i,d="";if(!t||t===l&&s||(d=h.a.getPeerColorById(t)),t===o.c)return void this.s(e,"",d,"tgico-reply_filled");if(a)i=r.b.getAbbreviation(a);else{i=null!==(n=h.a.getPeer(t).initials)&&void 0!==n?n:""}this.s(e,i,d,"")}if(p){const s="photo_small";return this.putAvatar(e,t,c,s,void 0,i)}}};t.a=p},123:function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return d})),s.d(t,"c",(function(){return l}));var a=s(129);const i=/[`~!@#$%^&*()\-_=+\[\]\\|{}'";:\/?.>,<]+/g,n=/^\s+|\s$/g;function o(e){return e.replace(i,"").replace(n,"")}function r(e){return e.replace(/[^A-Za-z0-9]/g,e=>{const t=a.a.LatinizeMap[e];return void 0!==t?t:e})}function d(e,t=!0){const s="%"===e.charAt(0);return e=o(e),t&&(e=r(e)),e=e.toLowerCase(),s&&(e="%"+e),e}function l(e,t={}){const s=t.includeTag&&"%"===e.charAt(0);return t.clearBadChars&&(e=o(e)),t.latinize&&(e=r(e)),t.ignoreCase&&(e=e.toLowerCase()),s&&(e="%"+e),e}},124:function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return n}));var a,i=s(29);!function(e){e[e.None=0]="None",e[e.Top=1]="Top",e[e.Bottom=2]="Bottom",e[e.Both=3]="Both"}(a||(a={}));class n{constructor(){this.sliceConstructor=n.getSliceConstructor(this);const e=this.constructSlice();this.slices=[e]}static getSliceConstructor(e){return class extends Array{constructor(){super(...arguments),this.end=a.None}isEnd(t){if((this.end&t)===t)return!0;let s=!1;if(t===a.Top){const a=e.last;s=!!(a.end&t)&&this.includes(a[a.length-1])}else if(t===a.Bottom){const a=e.first;s=!!(a.end&t)&&this.includes(a[0])}else if(t===a.Both)return this.isEnd(a.Top)&&this.isEnd(a.Bottom);return s&&this.setEnd(t),s}setEnd(e){this.end|=e}unsetEnd(e){this.end^=e}splice(t,s,...i){const n=super.splice(t,s,...i);if(!this.length){const t=e.slices,s=t.indexOf(this);-1!==s&&(1===t.length?this.unsetEnd(a.Both):t.splice(s,1))}return n}}}constructSlice(...e){const t=new this.sliceConstructor(e.length);for(let s=0,a=e.length;s<a;++s)t[s]=e[s];return t}insertSlice(e,t=!0){if(!e.length)return;const s=this.slices[0];if(!s.length)return s.push(...e),s;const a=e[e.length-1],i=e[0];let n,o=-1,r=-1,d=0;for(;d<this.slices.length&&(n=this.slices[d],o=n.indexOf(a),r=n.indexOf(i),-1===r||-1===o)&&(-1===r&&-1===o);++d);if(-1!==r&&-1!==o);else if(-1!==r){const t=e.slice(n.length-r);n.push(...t)}else if(-1!==o){const t=e.slice(0,e.length-o-1);n.unshift(...t)}else{let t=0;for(const s=this.slices.length;t<s;++t){const s=this.slices[t];if(e[0]>s[0])break}this.slices.splice(t,0,this.constructSlice(...e)),d=t}return t?this.flatten(d):void 0}flatten(e){if(this.slices.length>=2)for(let t=0,s=this.slices.length;t<s-1;++t){const a=this.slices[t],i=this.slices[t+1];-1!==a.indexOf(i[0])&&(a.setEnd(i.end),this.slices.splice(t+1,1),t<e&&--e,--s,--t,this.insertSlice(i,!1))}return this.slices[e]}get first(){return this.slices[0]}get last(){return this.slices[this.slices.length-1]}get slice(){return this.first}get length(){return this.slice.length}findSlice(e){for(let t=0,s=this.slices.length;t<s;++t){const s=this.slices[t],a=s.indexOf(e);if(-1!==a)return{slice:s,index:a}}}findSliceOffset(e){let t;for(let s=0;s<this.slices.length;++s){let a=0;if(t=this.slices[s],!(t.length<2))for(;a<t.length;a++)if(e>=t[a])return{slice:t,offset:e===t[a]?a:a-1}}if(t&&t.isEnd(a.Top))return{slice:t,offset:t.length}}sliceMe(e,t,s){let i=this.slice,n=0,o=0;if(e){const t=this.findSliceOffset(e);if(!t)return;i=t.slice,n=o=t.offset,i.includes(e)&&(o+=1)}let r=Math.max(o+t,0),d=o+t+s;const l=i.slice(r,d),h=t<0?s+t:s,c=Math.abs(t),g=i.length-o>=h||!!i.isEnd(a.Top)&&(l.setEnd(a.Top),!0),p=o-c>=0||!!i.isEnd(a.Bottom)&&(l.setEnd(a.Bottom),!0);return{slice:l,offsetIdOffset:n,fulfilled:a.None|(g&&p?a.Both:(g?a.Top:a.None)|(p?a.Bottom:a.None))}}unshift(...e){let t=this.first;t.length?t.isEnd(a.Bottom)||(t=this.constructSlice(),t.setEnd(a.Bottom),this.slices.unshift(t)):t.setEnd(a.Bottom),t.unshift(...e)}push(...e){let t=this.last;t.length?t.isEnd(a.Top)||(t=this.constructSlice(),t.setEnd(a.Top),this.slices.push(t)):t.setEnd(a.Top),t.push(...e)}delete(e){const t=this.findSlice(e);return!!t&&(t.slice.splice(t.index,1),!0)}}i.a&&(i.a.SlicedArray=n)},125:function(e,t,s){"use strict";var a=s(29),i=s(34),n=s(43),o=s(32),r=s(31),d=s(15),l=s(79),h=s(101),c=s(39),g=s(42),p=s(40);const u=new class{constructor(){this.polls={},this.results={},this.pollToMessages={},this.log=Object(n.b)("POLLS",n.a.Error),d.default.addMultipleEventsListeners({updateMessagePoll:e=>{this.log("updateMessagePoll:",e);let t=e.poll||this.polls[e.poll_id];if(!t)return;let s=e.results;const a=this.savePoll(t,s);t=a.poll,s=a.results,d.default.dispatchEvent("poll_update",{poll:t,results:s})}})}savePoll(e,t,s){s&&this.updatePollToMessage(s,!0);const a=e.id;return this.polls[a]?(e=Object.assign(this.polls[a],e),t=this.saveResults(e,t)):(this.polls[a]=e,e.rQuestion=r.a.wrapEmojiText(e.question),e.rReply=r.a.wrapEmojiText("ðŸ“Š")+" "+(e.rQuestion||"poll"),e.chosenIndexes=[],t=this.saveResults(e,t)),{poll:e,results:t}}saveResults(e,t){var s;return this.results[e.id]?t=Object.assign(this.results[e.id],t):this.results[e.id]=t,t.pFlags.min||(e.chosenIndexes.length=0,(null===(s=null==t?void 0:t.results)||void 0===s?void 0:s.length)&&t.results.forEach((t,s)=>{var a;(null===(a=t.pFlags)||void 0===a?void 0:a.chosen)&&e.chosenIndexes.push(s)})),t}getPoll(e){return{poll:this.polls[e],results:this.results[e]}}getInputMediaPoll(e,t,s,a){return s?(a||(a=[]),s=r.a.parseMarkdown(s,a)):s=void 0,{_:"inputMediaPoll",poll:e,correct_answers:t,solution:s,solution_entities:s?a:void 0}}updatePollToMessage(e,t){const{id:s}=e.media.poll;let a=this.pollToMessages[s];if(!t&&!a)return;a||(a=this.pollToMessages[s]=new Set);const i=e.peerId+"_"+e.mid;t?a.add(i):a.delete(i),t||a.size||(delete this.polls[s],delete this.results[s],delete this.pollToMessages[s])}sendVote(e,t){const s=e.media.poll,a=t.map(e=>s.answers[e].option),i=e.mid,n=e.peerId,r=g.a.getInputPeerById(n);return e.pFlags.is_outgoing?c.a.invokeAfterMessageIsSent(i,"sendVote",e=>(this.log("invoke sendVote callback"),this.sendVote(e,t))):o.a.invokeApi("messages.sendVote",{peer:r,msg_id:h.a.getServerMessageId(e.mid),options:a}).then(e=>{this.log("sendVote updates:",e),l.a.processUpdateMessage(e)})}getResults(e){const t=g.a.getInputPeerById(e.peerId);return o.a.invokeApi("messages.getPollResults",{peer:t,msg_id:h.a.getServerMessageId(e.mid)}).then(e=>{l.a.processUpdateMessage(e),this.log("getResults updates:",e)})}getVotes(e,t,s,a=20){return o.a.invokeApi("messages.getPollVotes",{peer:g.a.getInputPeerById(e.peerId),id:h.a.getServerMessageId(e.mid),option:t,offset:s,limit:a}).then(e=>(this.log("getPollVotes messages:",e),p.a.saveApiUsers(e.users),e))}stopPoll(e){const t=e.media.poll;if(t.pFlags.closed)return Promise.resolve();const s=Object(i.a)(t);return s.pFlags.closed=!0,c.a.editMessage(e,void 0,{newMedia:this.getInputMediaPoll(s)}).then(()=>{},e=>{this.log.error("stopPoll error:",e)})}};a.a.appPollsManager=u,t.a=u},126:function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var a=s(45),i=s(82),n=s(41),o=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};const r=[];let d=!1;function l(e,t="push"){return e.items.length?(e.promise=Object(a.a)(),r[t](e),function e(){if(!d){(function(e){if(!e.items.length)return e.promise.resolve([]),Promise.resolve([]);const t=e.items.slice(),s=[];return new Promise((a,r)=>{const d=()=>o(this,void 0,void 0,(function*(){const o=performance.now();do{yield Object(i.c)();const a=e.process.apply(e.context,t.shift());let n;if(a instanceof Promise)try{n=yield a}catch(e){return void r(e)}else n=a;s.push(n)}while(t.length>0&&performance.now()-o<6);t.length>0?Object(n.b)(d):a(s)}));Object(n.b)(d)}).then(e.promise.resolve,e.promise.reject)})(r.shift()).finally(()=>{d=!1,r.length&&e()})}}(),e.promise):Promise.resolve([])}const h="filter"in(document.createElement("canvas").getContext("2d")||{});let c,g;function p(e,t,s){return new Promise(a=>{const i=document.createElement("canvas");i.width=e.width,i.height=e.height;const n=i.getContext("2d",{alpha:!1});h?(n.filter=`blur(${t}px)`,n.drawImage(e,2*-t,2*-t,i.width+4*t,i.height+4*t)):(n.drawImage(e,0,0),g(n,0,0,i.width,i.height,t,s)),a(i.toDataURL())})}c=h?Promise.resolve():s.e(31).then(s.bind(null,149)).then(e=>{g=e.default});const u=new Map;function f(e,t=2,s=2){if(!e)return console.error("no dataUri for blur",e),Promise.resolve(e);if(u.size>1e3&&u.clear(),u.has(e))return u.get(e);const a=new Promise(a=>{c.then(()=>{const i=new Image;i.onload=()=>{h?p(i,t,s).then(a):l({items:[[i,t,s]],context:null,process:p},"unshift").then(e=>{a(e[0])})},i.src=e})});return u.set(e,a),a}},132:function(e,t,s){"use strict";var a=s(39),i=s(75),n=s(34),o=s(29),r=s(32),d=s(107),l=s(43);const h=new class{constructor(){this.contexts=new Map,this.links={},this.log=Object(l.b)("RD",void 0,!0),r.a.addTaskListener("refreshReference",e=>{const t=e.payload;Object(d.a)(e),e.originalPayload=t,this.refreshReference(t).then(t=>{e.payload=t},t=>{e.error=t}).then(()=>r.a.postMessage(e))})}saveContext(e,t,s){[s,e]=this.getContexts(e),s||(s=new Set,this.contexts.set(e,s)),this.links[Object(i.e)(e)]=e;for(const e of s)if(Object(n.b)(e,t))return;s.add(t)}getReferenceByLink(e){return this.links[Object(i.e)(e)]}getContexts(e){return[this.contexts.get(e)||(e=this.getReferenceByLink(e)||e,this.contexts.get(e)),e]}getContext(e){const t=this.getContexts(e);return t[0]?[t[0].values().next().value,t[1]]:void 0}deleteContext(e,t,s){if([s,e]=this.getContexts(e),s)for(const a of s)if(Object(n.b)(a,t))return s.delete(a),s.size||(this.contexts.delete(e),delete this.links[Object(i.e)(e)]),!0;return!1}refreshReference(e,t){if(this.log("refreshReference: start",e.slice(),t),!t){const s=this.getContext(e);if(!s)return this.log("refreshReference: got no context for reference:",e.slice()),Promise.reject("NO_CONTEXT");[t,e]=s}let s;switch(null==t?void 0:t.type){case"message":s=a.a.wrapSingleMessage(t.peerId,t.messageId,!0);break;default:return this.log.warn("refreshReference: not implemented context",t),Promise.reject()}const n=Object(i.e)(e);return this.log("refreshReference: refreshing reference:",n),s.then(()=>{const s=Object(i.e)(e);if(this.log("refreshReference: refreshed, reference before:",n,"after:",s),n!==s)return e;this.deleteContext(e,t);const a=this.getContext(e);if(a)return this.refreshReference(e,a[0]);throw this.log.error("refreshReference: no new context, reference before:",n,"after:",s,t),"NO_NEW_CONTEXT"})}};o.a.referenceDatabase=h,t.a=h},133:function(e,t,s){"use strict";function a(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content}s.d(t,"a",(function(){return a}))},139:function(e,t,s){"use strict";var a=s(29),i=s(0),n=s(43),o=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};const r=new class{constructor(){this.sampleRate=48e3,this.tasks=[],this.keepAlive=!1,this.log=Object(n.b)("OPUS",n.a.Error)}isPlaySupported(){if(void 0!==this.isPlaySupportedResult)return this.isPlaySupportedResult;const e=document.createElement("audio");return this.isPlaySupportedResult=!(!e.canPlayType||!e.canPlayType("audio/ogg;").replace(/no/,""))}loadWavWorker(){this.wavWorker||(this.wavWorker=new Worker("waveWorker.min.js"),this.wavWorker.addEventListener("message",e=>{const t=e.data;if(this.log("[WAV] got message:",t),t&&t.page){const e=t.page;this.onTaskEnd(this.tasks.shift(),e)}}))}loadWorker(){this.worker||(this.worker=new Worker("decoderWorker.min.js"),this.worker.addEventListener("message",e=>{const t=e.data;this.log("[DECODER] got message",t),"done"===t.type?(this.wavWorker.postMessage({command:"done"}),t.waveform&&(this.tasks[0].waveform=t.waveform)):this.wavWorker.postMessage({command:"encode",buffers:e.data},i.IS_SAFARI?void 0:t.map(e=>e.buffer))}))}setKeepAlive(e){this.keepAlive=e,this.keepAlive?(this.loadWorker(),this.loadWavWorker()):this.tasks.length||this.terminateWorkers()}onTaskEnd(e,t){t?(clearTimeout(e.timeout),e.callback.resolve({bytes:t,waveform:e.waveform})):e.callback.reject("timeout"),this.tasks.length&&this.executeNewTask(this.tasks[0]),this.terminateWorkers()}terminateWorkers(e=!1){(!this.keepAlive&&!this.tasks.length||e)&&(this.worker&&(this.worker.terminate(),this.worker=null),this.wavWorker&&(this.wavWorker.terminate(),this.wavWorker=null))}executeNewTask(e){this.worker.postMessage({command:"init",decoderSampleRate:this.sampleRate,outputBufferSampleRate:this.sampleRate}),this.wavWorker.postMessage({command:"init",wavBitDepth:16,wavSampleRate:this.sampleRate}),this.log("[DECODER] send decode"),this.worker.postMessage({command:"decode",pages:e.pages,waveform:e.withWaveform},i.IS_SAFARI?void 0:[e.pages.buffer]),e.timeout=window.setTimeout(()=>{this.log.error("decode timeout"),this.terminateWorkers(!0),this.tasks.length&&(this.loadWorker(),this.loadWavWorker()),this.onTaskEnd(this.tasks.shift())},1e4)}pushDecodeTask(e,t){return new Promise((s,a)=>{const i={pages:e,withWaveform:t,callback:{resolve:s,reject:a},timeout:0};this.loadWorker(),this.loadWavWorker(),1===this.tasks.push(i)&&this.executeNewTask(i)})}decode(e,t=!1){return o(this,void 0,void 0,(function*(){return this.pushDecodeTask(e,t).then(e=>{const t=new Blob([e.bytes],{type:"audio/wav"});return{url:URL.createObjectURL(t),waveform:e.waveform}})}))}};a.a.opusDecodeController=r,t.a=r},140:function(e,t,s){"use strict";var a=s(50),i=s(64),n=s(31),o=s(15),r=s(34),d=s(77),l=s(29);const h=new Set(["photo","video","gif","document"]);const c=new class{constructor(){this.webpages={},this.pendingWebPages={},o.default.addMultipleEventsListeners({updateWebPage:e=>{this.saveWebPage(e.webpage)}})}saveWebPage(e,t,s){var l,c;if("webPageNotModified"===e._)return;const{id:g}=e,p=this.webpages[g],u=p&&p._===e._&&p.hash==p.hash;if("webPage"===e._){"photo"===(null===(l=e.photo)||void 0===l?void 0:l._)?e.photo=a.a.savePhoto(e.photo,s):delete e.photo,"document"===(null===(c=e.document)||void 0===c?void 0:c._)?e.document=i.a.saveDoc(e.document,s):("document"===e.type&&delete e.type,delete e.document);const t=e.site_name;let o=e.title||e.author||t||"";t&&o===t&&delete e.site_name,o=Object(d.f)(o,80,100),e.rTitle=n.a.wrapRichText(o,{noLinks:!0,noLinebreaks:!0});let r="";if("GitHub"===t){const t=e.url.match(/(https?:\/\/github\.com\/[^\/]+\/[^\/]+)/);t&&(r=t[0]+"/issues/{1}")}const g=Object(d.f)(e.description||"",150,180);e.rDescription=n.a.wrapRichText(g,{contextSite:t||"external",contextHashtag:r}),h.has(e.type)||e.description||!e.photo||(e.type="photo")}let f=this.pendingWebPages[g];if(t&&(f||(f=this.pendingWebPages[g]=new Set),f.add(t)),void 0===p?this.webpages[g]=e:Object(r.i)(p,e),!t&&void 0!==f&&u){const e=[];f.forEach(t=>{const[s,a,i]=t.split("_");e.push({peerId:s.toPeerId(),mid:+a,isScheduled:!!i})}),o.default.dispatchEvent("webpage_updated",{id:g,msgs:e})}return e}getMessageKeyForPendingWebPage(e,t,s){return e+"_"+t+(s?"_s":"")}deleteWebPageFromPending(e,t){const s=e.id;if(!s)return;const a=this.pendingWebPages[s];a&&a.has(t)&&(a.delete(t),a.size||delete this.pendingWebPages[s])}getWebPage(e){return this.webpages[e]}};l.a&&(l.a.appWebPagesManager=c),t.a=c},141:function(e,t,s){"use strict";var a=s(117);const i=new Set(["image/jpeg","image/png","image/bmp"]);a.a&&i.add("image/webp"),t.a=i},144:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));s(75);var a=0,i=0;for(a=0;1<<a+1>1<<a;a++);i=(1<<(a>>=1))-1;n(1,1,1),n(0,1,1),new Array(0);function n(e,t,s){var i;i=s>(i=Math.ceil(t/a)+1)?s:i;var n=new Array(i);return o(n,e),n}function o(e,t){var s,n,o=e.length;for(n=t,s=0;s<o;s++)e[s]=n&i,n>>=a}function r(e){return"object"==typeof e&&null!==e}},145:function(e,t,s){"use strict";var a=s(0);var i=!!document.createElement("video").canPlayType("video/quicktime")||a.IS_SAFARI||a.IS_APPLE_MOBILE;const n=new Set(["image/gif","video/mp4","video/webm"]);i&&n.add("video/quicktime");t.a=n},39:function(e,t,s){"use strict";var a=s(74),i=s(102),n=s(45),o=s(54),r=s(103),d=s(34),l=s(66),h=s(77),c=s(16),g=s(43),p=s(32),u=s(132),f=s(68),m=s(31),_=s(15),v=s(111),M=s(44),I=s(124),y=s(47),P=s(3);class b{constructor(e,t,s,a,i,n,o,r,d,l){this.appMessagesManager=e,this.appChatsManager=t,this.appPeersManager=s,this.appUsersManager=a,this.appDraftsManager=i,this.appNotificationsManager=n,this.appStateManager=o,this.apiUpdatesManager=r,this.serverTimeManager=d,this.appMessagesIdsManager=l,this.folders={},this.onUpdateFolderPeers=e=>{e.folder_peers.forEach(e=>{var t;const{folder_id:s,peer:a}=e,i=this.appPeersManager.getPeerId(a),n=this.dropDialog(i)[0];n&&((null===(t=n.pFlags)||void 0===t?void 0:t.pinned)&&this.handleDialogUnpinning(n,s),n.folder_id=s,this.generateIndexForDialog(n),this.pushDialog(n)),this.appMessagesManager.scheduleHandleNewDialogs(i,n)})},this.onUpdateDialogPinned=e=>{var t;const s=null!==(t=e.folder_id)&&void 0!==t?t:0,a=this.appPeersManager.getPeerId(e.peer.peer),i=this.getDialogOnly(a);i&&(e.pFlags.pinned?i.pFlags.pinned=!0:this.handleDialogUnpinning(i,s),this.generateIndexForDialog(i)),this.appMessagesManager.scheduleHandleNewDialogs(a,i)},this.onUpdatePinnedDialogs=e=>{var t;const s=null!==(t=e.folder_id)&&void 0!==t?t:0,a=e=>{this.pinnedOrders[s].length=0,e.reverse(),e.forEach(e=>{i[e]=!0;const t=this.getDialogOnly(e);this.appMessagesManager.scheduleHandleNewDialogs(e,t),t&&(t.pFlags.pinned=!0,this.generateIndexForDialog(t))});const t=this.getFolderDialogs(s,!1);for(const e of t){if(!e.pFlags.pinned)break;const t=e.peerId;i[t]||this.appMessagesManager.scheduleHandleNewDialogs(t)}},i={};e.order?a(e.order.map(e=>this.appPeersManager.getPeerId(e.peer))):p.a.invokeApi("messages.getPinnedDialogs",{folder_id:s}).then(e=>{this.applyDialogs(e),a(e.dialogs.map(e=>e.peerId))})},this.storage=this.appStateManager.storages.dialogs,this.dialogs=this.storage.getCache(),this.clear(!0),_.default.addEventListener("language_change",()=>{const e=a.getSelf().id.toPeerId(!1);if(this.getDialogOnly(e)){const t=s.getPeerSearchText(e);this.dialogsIndex.indexObject(e,t)}});const h=e=>{const t=this.getCachedDialogs(!1);for(let s=0;s<t.length;++s)this.processDialogForFilter(t[s],e)};_.default.addEventListener("filter_update",h),_.default.addEventListener("filter_new",h),_.default.addEventListener("filter_delete",e=>{delete this.folders[e.id]}),_.default.addEventListener("chat_update",e=>{const t=this.appChatsManager.getChat(e),s=e.toPeerId(!0);t.pFlags.left&&this.getDialogOnly(s)&&this.dropDialogWithEvent(s)}),_.default.addMultipleEventsListeners({updateFolderPeers:this.onUpdateFolderPeers,updateDialogPinned:this.onUpdateDialogPinned,updatePinnedDialogs:this.onUpdatePinnedDialogs}),o.getState().then(e=>{this.pinnedOrders=e.pinnedOrders||{},this.pinnedOrders[0]||(this.pinnedOrders[0]=[]),this.pinnedOrders[1]||(this.pinnedOrders[1]=[]);const t=o.storagesResults.dialogs;if(t.length)for(let e=0,s=t.length;e<s;++e){const s=t[e];if(s){s.top_message=this.appMessagesIdsManager.getServerMessageId(s.top_message),s.topMessage&&this.appMessagesManager.saveMessages([s.topMessage]);for(let e=0;e<=10;++e)delete s["index_"+e];this.saveDialog(s,void 0,!0);this.appMessagesManager.getMessageByPeer(s.peerId,s.top_message).deleted&&this.appMessagesManager.reloadConversation(s.peerId)}}this.allDialogsLoaded=e.allDialogsLoaded||{}})}isDialogsLoaded(e){return!!this.allDialogsLoaded[e]}setDialogsLoaded(e,t){void 0===e&&t?(this.allDialogsLoaded[0]=t,this.allDialogsLoaded[1]=t):this.allDialogsLoaded[e]=t,this.allDialogsLoaded[0]&&this.allDialogsLoaded[1]&&(this.allDialogsLoaded[void 0]=!0),this.appStateManager.pushToState("allDialogsLoaded",this.allDialogsLoaded)}clear(e=!1){if(this.pinnedOrders={0:[],1:[]},e)this.allDialogsLoaded={};else{this.appStateManager.storagesResults.dialogs.length=0,this.storage.clear(),this.setDialogsLoaded(0,!1),this.setDialogsLoaded(1,!1),this.setDialogsLoaded(void 0,!1),this.savePinnedOrders()}this.folders={},this.dialogsOffsetDate={},this.dialogsNum=0,this.dialogsIndex=new v.a({clearBadChars:!0,ignoreCase:!0,latinize:!0,includeTag:!0}),this.cachedResults={query:"",count:0,dialogs:[],folderId:0}}handleDialogUnpinning(e,t){delete e.pFlags.pinned,Object(M.e)(this.pinnedOrders[t],e.peerId),this.savePinnedOrders()}savePinnedOrders(){this.appStateManager.pushToState("pinnedOrders",this.pinnedOrders)}resetPinnedOrder(e){this.pinnedOrders[e]=[]}getPinnedOrders(e){return this.pinnedOrders[e]}getOffsetDate(e){const t=this.dialogsOffsetDate[e]||0;return void 0!==e||t?t:Math.min(this.getOffsetDate(0),this.getOffsetDate(1))}getFolder(e){var t;return null!==(t=this.folders[e])&&void 0!==t?t:this.folders[e]={dialogs:[],id:e,unreadMessagesCount:0,unreadDialogsCount:0}}getFolderDialogs(e,t=!0){if(void 0===e)return this.getCachedDialogs(t);const s=this.getFolder(e);return t?s.dialogs.filter(e=>void 0===e.migratedTo):s.dialogs}getCachedDialogs(e){return this.getFolderDialogs(0,e).concat(this.getFolderDialogs(1,e))}setDialogIndexInFilter(e,t,s){var a;let i;if(this.appMessagesManager.filtersStorage.testDialogForFilter(e,s)){const t=s.pinnedPeerIds.indexOf(e.peerId);i=-1!==t?this.generateDialogIndex(this.generateDialogPinnedDateByIndex(s.pinned_peers.length-1-t),!0):(null===(a=e.pFlags)||void 0===a?void 0:a.pinned)?this.generateIndexForDialog(e,!0):e.index}return e[t]=i}getDialog(e,t,s=!0){const a=[];void 0===t?a.push(this.getFolder(0).dialogs,this.getFolder(1).dialogs):a.push(this.getFolderDialogs(t,!1));for(let t of a){let a=0,i=0;for(let n=t.length;a<n;++a){const n=t[a];if(n.peerId===e)return[n,a-i];s&&void 0!==n.migratedTo&&++i}}return[]}getDialogOnly(e){return this.dialogs[e]}generateDialogIndex(e,t){return void 0===e&&(e=Object(o.g)(!0)+this.serverTimeManager.serverTimeOffset),65536*e+(t?0:65535&++this.dialogsNum)}processDialogForFilters(e){const t=this.appMessagesManager.filtersStorage.filters;for(const s in t){const a=t[s];this.processDialogForFilter(e,a)}}processDialogForFilter(e,t){const s=this.getDialogIndexKey(t.id),a=this.getFolder(t.id).dialogs,i=a.findIndex(t=>t.peerId===e.peerId),n=a[i],o=n&&n[s],r=this.setDialogIndexInFilter(e,s,t);o!==r&&((!o&&r||i&&!r)&&this.prepareFolderUnreadCountModifyingByDialog(t.id,e,!!r),-1!==i&&a.splice(i,1),r&&Object(M.f)(a,e,s,i))}prepareDialogUnreadCountModifying(e){const t=[this.prepareFolderUnreadCountModifyingByDialog(e.folder_id,e)],s=this.appMessagesManager.filtersStorage.filters;for(const a in s){const i=s[a];this.appMessagesManager.filtersStorage.testDialogForFilter(e,i)&&t.push(this.prepareFolderUnreadCountModifyingByDialog(i.id,e))}return()=>t.forEach(e=>e())}prepareFolderUnreadCountModifyingByDialog(e,t,s){const a=this.appMessagesManager.getDialogUnreadCount(t);if(void 0===s)return()=>{const s=this.appMessagesManager.getDialogUnreadCount(t),i=s-a,n=s&&!a||!s&&a?a?-1:1:0;this.modifyFolderUnreadCount(e,i,n)};this.modifyFolderUnreadCount(e,s?a:-a,a?s?1:-1:0)}modifyFolderUnreadCount(e,t,s){if(!t&&!s)return;const a=this.getFolder(e);t&&(a.unreadMessagesCount=Math.max(0,a.unreadMessagesCount+t)),s&&(a.unreadDialogsCount=Math.max(0,a.unreadDialogsCount+s)),void 0===a.dispatchUnreadTimeout&&(a.dispatchUnreadTimeout=P.a.setTimeout(()=>{a.dispatchUnreadTimeout=void 0,_.default.dispatchEvent("folder_unread",a)},0))}generateIndexForDialog(e,t=!1,s){var a;let i,n=0;if(e.pFlags.pinned&&!t)n=this.generateDialogPinnedDate(e),i=!0;else{s||(s=this.appMessagesManager.getMessageByPeer(e.peerId,e.top_message)),n=s.date||n;const t=this.appPeersManager.isChannel(e.peerId)&&e.peerId.toChatId();if(t){const e=this.appChatsManager.getChat(t);(!n||e.date&&e.date>n)&&(n=e.date)}"draftMessage"===(null===(a=e.draft)||void 0===a?void 0:a._)&&e.draft.date>n&&(n=e.draft.date)}n||(n=Object(o.g)(!0));const r=this.generateDialogIndex(n,i);if(t)return r;e.index=r}generateDialogPinnedDateByIndex(e){return 2147418112+(65535&e)}generateDialogPinnedDate(e){const t=this.pinnedOrders[e.folder_id],s=t.indexOf(e.peerId);let a=s;return-1===s&&(a=t.push(e.peerId)-1,this.savePinnedOrders()),this.generateDialogPinnedDateByIndex(a)}setDialogToState(e){const{peerId:t,pts:s}=e,a=this.appMessagesManager.getHistoryStorage(t),i=this.appMessagesManager.getMessagesStorage(t),n=a.history.slice;let o;for(let e=0,s=n.length;e<s;++e){const s=n[e],a=this.appMessagesManager.getMessageFromStorage(i,s);if(!a.pFlags.is_outgoing&&!a.deleted){o=a;const e=a.viaBotId||a.fromId;e!==t&&this.appStateManager.requestPeer(e,"topMessage_"+t,1);break}}if(e.topMessage=o,t.isAnyChat()&&s){const a=this.apiUpdatesManager.getChannelState(t.toChatId(),s).pts;e.pts=a}this.storage.set({[t]:e}),this.appStateManager.requestPeer(t,"dialog_"+t,1)}pushDialog(e,t,s,a){const{folder_id:i,peerId:n}=e,o=this.getFolderDialogs(i,!1),r=o.findIndex(e=>e.peerId===n);if(-1!==r&&o.splice(r,1),this.dialogs[n]=e,this.setDialogToState(e),void 0===t&&(t=this.getDialogOffsetDate(e)),this.processDialogForFilters(e),t&&!e.pFlags.pinned){if(a){const e=this.dialogsOffsetDate[void 0];(!e||t<e)&&(this.dialogsOffsetDate[void 0]=t)}const n=this.dialogsOffsetDate[i];if(!n||t<n){if(!s&&!this.isDialogsLoaded(i))return void this.clearDialogFromState(e,!0);this.dialogsOffsetDate[i]=t}}-1===r&&this.prepareFolderUnreadCountModifyingByDialog(i,e,!0),Object(M.f)(o,e,"index",r)}dropDialog(e){const t=this.getDialog(e,void 0,!1),[s,a]=t;if(s){this.getFolder(s.folder_id).dialogs.splice(a,1),this.processDialogForFilters(s);const t=void 0!==Object(M.e)(this.pinnedOrders[s.folder_id],e);this.dialogsIndex.indexObject(e,""),delete this.dialogs[e],t&&this.savePinnedOrders(),this.clearDialogFromState(s,!1)}return t}clearDialogFromState(e,t){const s=e.peerId;this.appStateManager.keepPeerSingle(y.b,"topMessage_"+s),this.appStateManager.keepPeerSingle(y.b,"dialog_"+s),this.storage.delete(s,t)}dropDialogWithEvent(e){const t=this.dropDialog(e);t.length&&_.default.dispatchEvent("dialog_drop",{peerId:e,dialog:t[0]})}applyDialogs(e){Object(M.d)(e.dialogs,(t,s)=>{"dialogFolder"===t._&&e.dialogs.splice(s,1)}),this.appUsersManager.saveApiUsers(e.users),this.appChatsManager.saveApiChats(e.chats),this.appMessagesManager.saveMessages(e.messages);const t={};e.dialogs.forEach(e=>{const s=this.appPeersManager.getPeerId(e.peer);let a=e.top_message;const i=this.appMessagesManager.pendingTopMsgs[s];i&&(!a||this.appMessagesManager.getMessageByPeer(s,i).date>this.appMessagesManager.getMessageByPeer(s,a).date)&&(e.top_message=a=i,this.appMessagesManager.getHistoryStorage(s).maxId=i),a||e.draft&&"draftMessage"===e.draft._?(this.saveDialog(e),t[s]=e):this.dropDialogWithEvent(s);const n=this.appMessagesManager.newUpdatesAfterReloadToHandle[s];if(void 0!==n){for(const e of n)this.apiUpdatesManager.saveUpdate(e);delete this.appMessagesManager.newUpdatesAfterReloadToHandle[s]}}),Object.keys(t).length&&_.default.dispatchEvent("dialogs_multiupdate",t)}getDialogOffsetDate(e){return this.appMessagesManager.getMessageByPeer(e.peerId,e.top_message).date||0}saveDialog(e,t,s,a){var i,n;void 0===t&&(t=null!==(i=e.folder_id)&&void 0!==i?i:0);const o=this.appPeersManager.getPeerId(e.peer);if(!o)return void console.error("saveConversation no peerId???",e,t);"dialog"!==e._&&console.error("saveConversation not regular dialog",e,Object.assign({},e));const r=this.appPeersManager.isChannel(o)?o.toChatId():y.b;if(o.isAnyChat()){const e=this.appChatsManager.getChat(o.toChatId());if("channelForbidden"===e._||e.pFlags.left||e.pFlags.kicked)return}const l=this.appPeersManager.getPeerSearchText(o);this.dialogsIndex.indexObject(o,l);const h=this.getDialogOnly(o);let c,g;if(e.top_message){c=this.appMessagesIdsManager.generateMessageId(e.top_message);const t=(null==h?void 0:h.top_message)&&this.appMessagesManager.getMessageByPeer(o,h.top_message);(null===(n=null==t?void 0:t.pFlags)||void 0===n?void 0:n.is_outgoing)&&h.top_message>=c&&(c=h.top_message),g=this.appMessagesManager.getMessageByPeer(o,c)}else c=this.appMessagesManager.generateTempMessageId(o),g={_:"message",id:c,mid:c,from_id:this.appPeersManager.getOutputPeer(this.appUsersManager.getSelf().id.toPeerId(!1)),peer_id:this.appPeersManager.getOutputPeer(o),deleted:!0,pFlags:{out:!0},date:0,message:""},this.appMessagesManager.saveMessages([g],{isOutgoing:!0});if((null==g?void 0:g.pFlags)||this.appMessagesManager.log.error("saveConversation no message:",e,g),!r&&o.isAnyChat()){const t=this.appChatsManager.getChat(o.toChatId());if(t&&t.migrated_to&&t.pFlags.deactivated){const s=this.appPeersManager.getPeerId(t.migrated_to);this.appMessagesManager.migratedFromTo[o]=s,this.appMessagesManager.migratedToFrom[s]=o,e.migratedTo=s}}if(e.top_message=c,e.read_inbox_max_id=this.appMessagesIdsManager.generateMessageId(h&&!e.read_inbox_max_id?h.read_inbox_max_id:e.read_inbox_max_id),e.read_outbox_max_id=this.appMessagesIdsManager.generateMessageId(h&&!e.read_outbox_max_id?h.read_outbox_max_id:e.read_outbox_max_id),void 0===e.folder_id&&"dialog"===e._&&(e.folder_id=h?h.folder_id:t),e.draft=this.appDraftsManager.saveDraft(o,0,e.draft),e.peerId=o,g.pFlags.is_outgoing){const t=g.pFlags.out;c>e[t?"read_outbox_max_id":"read_inbox_max_id"]?(g.pFlags.unread=!0,e.unread_count||t||++e.unread_count):delete g.pFlags.unread}const p=this.appMessagesManager.getHistoryStorage(o),u=p.history.slice;if(u.length){if(!u.isEnd(I.a.Bottom)){p.history.insertSlice([c]).setEnd(I.a.Bottom),this.appMessagesManager.mergeReplyKeyboard(p,g)&&_.default.dispatchEvent("history_reply_markup",{peerId:o})}}else p.history.unshift(c),this.appMessagesManager.mergeReplyKeyboard(p,g)&&_.default.dispatchEvent("history_reply_markup",{peerId:o});p.maxId=c,p.readMaxId=e.read_inbox_max_id,p.readOutboxMaxId=e.read_outbox_max_id,this.appNotificationsManager.savePeerSettings({peerId:o,settings:e.notify_settings}),r&&e.pts&&this.apiUpdatesManager.addChannelState(r,e.pts),this.generateIndexForDialog(e),Object(d.c)(e,["index_0","index_1","index_2","index_3","index_4","index_5","index_6","index_7","index_8","index_9","index_10"]),h&&Object(d.i)(h,e),this.pushDialog(e,g.date,s,a)}getDialogIndexKey(e){return e>1?"index_"+this.appMessagesManager.filtersStorage.getFilter(e).orderIndex:"index"}getDialogs(e="",t,s=20,a=0,i=!1){const n={};if(a>1){const o=[],r=this.appUsersManager.fillContacts();r.cached||o.push(r.promise);const d=this.appMessagesManager.filtersStorage.getFilter(a),l=null==d?void 0:d.pinned_peers;if(null==l?void 0:l.length){const e=d.pinnedPeerIds,t=l.filter((t,s)=>!this.getDialogOnly(e[s]));if(t.length){const e=t.map(e=>this.appMessagesManager.reloadConversation(e)),s=Promise.all(e);o.push(s)}}if(o.length)return n.cached=!1,n.promise=Promise.all(o).then(()=>this.getDialogs(e,t,s,a,i).promise),n}const o=a>1||this.getOffsetDate(a)?void 0:a;let r=this.getFolderDialogs(a,i);const d=this.getDialogIndexKey(a);if(e){if(!s||this.cachedResults.query!==e||this.cachedResults.folderId!==a){this.cachedResults.query=e,this.cachedResults.folderId=a;const t=this.dialogsIndex.search(e),s=[];for(const e in this.dialogs){const i=this.dialogs[e];t.has(i.peerId)&&i.folder_id===a&&s.push(i)}s.sort((e,t)=>t[d]-e[d]),this.cachedResults.dialogs=s,this.cachedResults.count=s.length}r=this.cachedResults.dialogs}else this.cachedResults.query="";let l=0;if(t>0)for(let e=r.length;l<e&&!(t>r[l][d]);++l);const h=this.isDialogsLoaded(o),c=r.length>=l+s;if(e||h||c){const a=r.slice(l,l+s);return n.cached=!0,n.promise=Promise.resolve({dialogs:a,count:h?r.length:null,isTopEnd:r.length&&(a[0]&&a[0]===r[0]||r[0][d]<t),isEnd:(e||h)&&l+s>=r.length}),n}return n.cached=!1,n.promise=this.appMessagesManager.getTopMessages(s,o).then(e=>{if(i&&(r=this.getFolderDialogs(a,i)),l=0,t>0)for(let e=r.length;l<e&&!(t>r[l][d]);++l);const n=r.slice(l,l+s);return{dialogs:n,count:void 0===e.count?r.length:e.count,isTopEnd:r.length&&(n[0]&&n[0]===r[0]||r[0][d]<t),isEnd:e.isEnd}}),n}}var S=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};const C=[["pinned_peers","pinnedPeerIds"],["exclude_peers","excludePeerIds"],["include_peers","includePeerIds"]];class w{constructor(e,t,s,a,i,n,o){this.appMessagesManager=e,this.appPeersManager=t,this.appUsersManager=s,this.appNotificationsManager=a,this.appStateManager=i,this.apiUpdatesManager=n,this.rootScope=o,this.onUpdateDialogFilter=e=>{e.filter?this.saveDialogFilter(e.filter):this.filters[e.id]&&(this.rootScope.dispatchEvent("filter_delete",this.filters[e.id]),delete this.filters[e.id]),this.appStateManager.pushToState("filters",this.filters)},this.onUpdateDialogFilterOrder=e=>{this.orderIndex=1,e.order.forEach((e,t)=>{const s=this.filters[e];delete s.orderIndex,this.setOrderIndex(s)}),this.rootScope.dispatchEvent("filter_order",e.order),this.appStateManager.pushToState("filters",this.filters)},this.clear(),this.filters={},this.appStateManager.getState().then(e=>{Object(d.i)(this.filters,e.filters);for(const e in this.filters){const t=this.filters[e];t.hasOwnProperty("orderIndex")&&t.orderIndex>=this.orderIndex&&(this.orderIndex=t.orderIndex+1)}}),o.addMultipleEventsListeners({updateDialogFilter:this.onUpdateDialogFilter,updateDialogFilters:e=>{const t=Object(d.a)(this.filters);this.getDialogFilters(!0).then(e=>{for(const s in t){const t=+s;e.find(e=>e.id===t)||this.onUpdateDialogFilter({_:"updateDialogFilter",id:t})}this.onUpdateDialogFilterOrder({_:"updateDialogFilterOrder",order:e.map(e=>e.id)})})},updateDialogFilterOrder:this.onUpdateDialogFilterOrder})}clear(e=!1){e||Object(d.i)(this.filters,{}),this.orderIndex=1}testDialogForFilter(e,t){const s=e.peerId;if(t.excludePeerIds.includes(s))return!1;if(t.includePeerIds.includes(s))return!0;const a=t.pFlags;if(a.exclude_archived&&1===e.folder_id)return!1;if(a.exclude_read&&!this.appMessagesManager.isDialogUnread(e))return!1;if(a.exclude_muted){if(this.appNotificationsManager.isPeerLocalMuted(s))return!1}if(this.appPeersManager.isAnyChat(s)){if(a.broadcasts&&this.appPeersManager.isBroadcast(s))return!0;if(a.groups&&this.appPeersManager.isAnyGroup(s))return!0}else{const e=s.toUserId();if(this.appUsersManager.isBot(e))return!!a.bots;if(a.non_contacts&&!this.appUsersManager.isContact(e))return!0;if(a.contacts&&this.appUsersManager.isContact(e))return!0}return!1}testDialogForFilterId(e,t){return this.testDialogForFilter(e,this.filters[t])}getFilter(e){return this.filters[e]}toggleDialogPin(e,t){const s=this.filters[t],a=s.pinnedPeerIds.indexOf(e),i=-1!==a;if(i&&(s.pinned_peers.splice(a,1),s.pinnedPeerIds.splice(a,1)),!i){if(s.pinned_peers.length>=this.rootScope.config.pinned_infolder_count_max)return Promise.reject({type:"PINNED_DIALOGS_TOO_MUCH"});s.pinned_peers.unshift(this.appPeersManager.getInputPeerById(e)),s.pinnedPeerIds.unshift(e)}return this.updateDialogFilter(s)}createDialogFilter(e){const t=Math.max(1,...Object.keys(this.filters).map(e=>+e));return(e=Object(d.a)(e)).id=t+1,this.updateDialogFilter(e)}updateDialogFilter(e,t=!1){const s=t?0:1;return p.a.invokeApi("messages.updateDialogFilter",{flags:s,id:e.id,filter:t?void 0:this.getOutputDialogFilter(e)}).then(s=>(s&&this.onUpdateDialogFilter({_:"updateDialogFilter",id:e.id,filter:t?void 0:e}),s))}getOutputDialogFilter(e){const t=Object(d.a)(e);return this.filterIncludedPinnedPeers(e),t}filterIncludedPinnedPeers(e){Object(M.d)(e.includePeerIds,(t,s)=>{e.pinnedPeerIds.includes(t)&&(e.include_peers.splice(s,1),e.includePeerIds.splice(s,1))})}getDialogFilters(e=!1){return S(this,void 0,void 0,(function*(){const t=Object.keys(this.filters);if(t.length&&!e)return t.map(e=>this.filters[e]).sort((e,t)=>e.orderIndex-t.orderIndex);const s=yield p.a.invokeApiSingle("messages.getDialogFilters");for(const t of s)this.saveDialogFilter(t,e);return s}))}saveDialogFilter(e,t=!0){C.forEach(([t,s])=>{e[s]=e[t].map(e=>this.appPeersManager.getPeerId(e))}),this.filterIncludedPinnedPeers(e),e.include_peers=e.pinned_peers.concat(e.include_peers),e.includePeerIds=e.pinnedPeerIds.concat(e.includePeerIds);const s=this.filters[e.id];s?Object.assign(s,e):this.filters[e.id]=e,this.setOrderIndex(e),t?this.rootScope.dispatchEvent("filter_update",e):s||this.rootScope.dispatchEvent("filter_new",e)}setOrderIndex(e){e.hasOwnProperty("orderIndex")?e.orderIndex>=this.orderIndex&&(this.orderIndex=e.orderIndex+1):e.orderIndex=this.orderIndex++,this.appStateManager.pushToState("filters",this.filters)}}var D=s(79),U=s(46),E=s(64),A=s(73),F=s(42),k=s(50),x=s(125),T=s(17),O=s(40),L=s(140),j=s(113),R=s(122),B=s(70),N=s(29),H=s(95),z=s(53),q=s(133),W=s(94);const V={s:"Seconds",m:"Minutes",h:"Hours",d:"Days",w:"Weeks"};function G(e){const t=function(e,t=2){e||(e=1);let s=[];const a=[{m:1,t:"s"},{m:60,t:"m"},{m:60,t:"h"},{m:24,t:"d"},{m:7,t:"w"}];let i=1;a.forEach((t,n)=>{if(i*=t.m,e<i)return;const o=a[n===a.length-1?n:n+1].m;s.push({duration:e/i%o|0,type:t.t})});const n=s.slice(-t).reverse();for(let e=n.length-1;e>=0;--e)0===n[e].duration&&n.splice(e,1);return n}(e,2).map(e=>Object(c.i18n)(V[e.type],[e.duration])),s=document.createElement("span");return s.append(...Object(c.join)(t,!1)),s}var K=s(114),$=s(24),Q=s(108),Y=s(107),Z=s(101),J=s(141),X=s(145),ee=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};const te=new class{constructor(){this.pendingByRandomId={},this.pendingByMessageId={},this.pendingAfterMsgs={},this.pendingTopMsgs={},this.tempFinalizeCallbacks={},this.sendSmthLazyLoadQueue=new a.a(1),this.needSingleMessages=new Map,this.fetchSingleMessagesPromise=null,this.maxSeenId=0,this.migratedFromTo={},this.migratedToFrom={},this.newMessagesHandleTimeout=0,this.newMessagesToHandle={},this.newDialogsToHandle={},this.newUpdatesAfterReloadToHandle={},this.notificationsHandlePromise=0,this.notificationsToHandle={},this.reloadConversationsPeers=new Map,this.log=Object(g.b)("MESSAGES",g.a.Error|g.a.Debug|g.a.Log|g.a.Warn),this.groupedTempId=0,this.typings={},this.unreadMentions={},this.goToNextMentionPromises={},this.handleNewMessages=()=>{clearTimeout(this.newMessagesHandleTimeout),this.newMessagesHandleTimeout=0,_.default.dispatchEvent("history_multiappend",this.newMessagesToHandle),this.newMessagesToHandle={}},this.handleNewDialogs=()=>{let e=0;const t=this.newDialogsToHandle;for(const s in t){const a=t[s];a?(this.dialogsStorage.pushDialog(a),F.a.isChannel(s.toPeerId())||(e=Math.max(e,a.top_message||0))):(this.reloadConversation(s.toPeerId()),delete t[s])}0!==e&&this.incrementMaxSeenId(e),_.default.dispatchEvent("dialogs_multiupdate",t),this.newDialogsToHandle={}},this.handleNotifications=()=>{window.clearTimeout(this.notificationsHandlePromise),this.notificationsHandlePromise=0;for(const e in this.notificationsToHandle){const t=e.toPeerId();if(_.default.peerId===t&&!_.default.idle.isIDLE)continue;const s=this.notificationsToHandle[t];Promise.all([H.a.getNotifyPeerTypeSettings(),H.a.getNotifySettings(F.a.getInputNotifyPeerById(t,!0))]).then(([e,a])=>{const i=s.topMessage;!H.a.isPeerLocalMuted(t,!0)&&i.pFlags.unread&&i.pFlags.unread&&this.notifyAboutMessage(i,{fwdCount:s.fwdCount,peerTypeNotifySettings:a})})}this.notificationsToHandle={}},this.onUpdateMessageId=e=>{const t=e.random_id,s=this.pendingByRandomId[t];if(s){const{peerId:a,tempId:i,threadId:n,storage:o}=s,r=Z.a.generateMessageId(e.id),d=this.getMessageFromStorage(o,r);d.deleted?this.pendingByMessageId[r]=t:([this.getHistoryStorage(a),n?this.getHistoryStorage(a,n):void 0].filter(Boolean).forEach(e=>{e.history.delete(i)}),this.finalizePendingMessageCallbacks(o,i,d))}},this.onUpdateNewMessage=e=>{var t;const s=e.message,a=this.getMessagePeer(s),i=this.getMessagesStorage(a),n=this.getDialogOnly(a),o="updateNewDiscussionMessage"===e._;this.saveMessages([s],{storage:new Map});const r=this.getThreadKey(s),d=r?+r.split("_")[1]:void 0;if(d&&!o&&this.threadsStorage[a]&&this.threadsStorage[a][d]){const e={_:"updateNewDiscussionMessage",message:s};this.onUpdateNewMessage(e)}if(!n&&!o){let s=!0;if(a.isAnyChat()&&(s=U.a.isInChat(a.toChatId())),s){const s=null!==(t=this.newUpdatesAfterReloadToHandle[a])&&void 0!==t?t:this.newUpdatesAfterReloadToHandle[a]=new Set;if(s.has(e))return void this.log.error("here we go again",a);this.scheduleHandleNewDialogs(a),s.add(e)}return}this.saveMessages([s],{storage:i});const l=this.checkPendingMessage(s),h=this.getHistoryStorage(a,o?d:void 0);if(o||this.updateMessageRepliesIfNeeded(s),h.history.findSlice(s.mid))return!1;const c=h.history.first;if(c.isEnd(I.a.Bottom)){let e=0;for(const t=c.length;e<t&&!(s.mid>c[e]);++e);c.splice(e,0,s.mid)}else h.history.unshift(s.mid);null!==h.count&&h.count++,this.mergeReplyKeyboard(h,s)&&_.default.dispatchEvent("history_reply_markup",{peerId:a});const g=s.fromId;if(g.isUser()&&!s.pFlags.out&&s.from_id){O.a.forceUserOnline(g,s.date);const e={_:"sendMessageCancelAction"};let t;t=a.isUser()?{_:"updateUserTyping",action:e,user_id:g}:F.a.isChannel(a)?{_:"updateChannelUserTyping",action:e,channel_id:a.toChatId(),from_id:F.a.getOutputPeer(g),top_msg_id:d?Z.a.getServerMessageId(d):void 0}:{_:"updateChatUserTyping",action:e,chat_id:a.toChatId(),from_id:F.a.getOutputPeer(g)},D.a.processLocalUpdate(t)}if(l||this.handleNewMessage(a,s.mid),o)return;const p=!s.pFlags.out&&s.pFlags.unread;if(n){if(p){const e=this.dialogsStorage.prepareDialogUnreadCountModifying(n);++n.unread_count,s.pFlags.mentioned&&(++n.unread_mentions_count,this.modifyCachedMentions(a,s.mid,!0)),e()}this.setDialogTopMessage(s,n)}if(p){const e=a;let t=this.notificationsToHandle[e];void 0===t&&(t=this.notificationsToHandle[e]={fwdCount:0,fromId:y.b}),t.fromId!==g&&(t.fromId=g,t.fwdCount=0),s.fwd_from&&++t.fwdCount,t.topMessage=s,this.notificationsHandlePromise||(this.notificationsHandlePromise=window.setTimeout(this.handleNotifications,0))}},this.onUpdateDialogUnreadMark=e=>{const t=F.a.getPeerId(e.peer.peer),s=this.getDialogOnly(t);if(s){const a=this.dialogsStorage.prepareDialogUnreadCountModifying(s);e.pFlags.unread?s.pFlags.unread_mark=!0:delete s.pFlags.unread_mark,a(),_.default.dispatchEvent("dialogs_multiupdate",{[t]:s}),this.dialogsStorage.setDialogToState(s)}else this.scheduleHandleNewDialogs(t)},this.onUpdateEditMessage=e=>{const t=e.message,s=this.getMessagePeer(t),a=Z.a.generateMessageId(t.id),i=this.getMessagesStorage(s);if(!i.has(a))return;const n=this.getMessageFromStorage(i,a);this.saveMessages([t],{storage:i});const o=this.getMessageFromStorage(i,a);this.handleEditedMessage(n,o);const r=this.getDialogOnly(s),d=r&&r.top_message===a;if(t.clear_history)d&&_.default.dispatchEvent("dialog_flush",{peerId:s});else if(_.default.dispatchEvent("message_edit",{storage:i,peerId:s,mid:a}),d||t.grouped_id){const e={};e[s]=r,_.default.dispatchEvent("dialogs_multiupdate",e),this.dialogsStorage.setDialogToState(r)}},this.onUpdateReadHistory=e=>{const t=e.channel_id,s=Z.a.generateMessageId(e.max_id||e.read_max_id),a=Z.a.generateMessageId(e.top_msg_id),i=t?t.toPeerId(!0):F.a.getPeerId(e.peer),n="updateReadHistoryOutbox"===e._||"updateReadChannelOutbox"===e._||"updateReadChannelDiscussionOutbox"===e._||void 0,o=this.getMessagesStorage(i),r=Object(d.e)(o,"desc"),l=this.getDialogOnly(i),h=e.still_unread_count;let c=0,g=0,p=!1;const u=this.getHistoryStorage(i,a);if(i.isUser()&&n&&O.a.forceUserOnline(i),a){const e=this.threadsToReplies[i+"_"+a];if(e){const[t,s]=e.split("_");this.updateMessage(t.toPeerId(),+s,"replies_updated")}}const f=!a&&l&&this.dialogsStorage.prepareDialogUnreadCountModifying(l);for(let e=0,t=r.length;e<t;e++){const t=r[e];if(t>s)continue;const d=o.get(t);if(d.pFlags.out===n){if(!d.pFlags.unread)break;if(a){const e=d.reply_to;if(!e||(e.reply_to_top_id||e.reply_to_msg_id)!==a)continue}d.pFlags.unread&&(delete d.pFlags.unread,p||(p=!0),d.pFlags.out||a||!l||(void 0===h&&(c=--l.unread_count),d.pFlags.mentioned&&(g=--l.unread_mentions_count,this.modifyCachedMentions(i,d.mid,!1))),H.a.cancel("msg"+t))}}if(n?u.readOutboxMaxId=s:u.readMaxId=s,!a&&l){if(n?l.read_outbox_max_id=s:l.read_inbox_max_id=s,!n){let e;void 0!==h?e=h:c<0||!this.getReadMaxIdIfUnread(i)?e=0:c&&l.top_message>s&&(e=c),void 0!==e&&(l.unread_count=e),g<0&&(l.unread_mentions_count=0)}f&&f(),this.dialogsStorage.processDialogForFilters(l),_.default.dispatchEvent("dialog_unread",{peerId:i}),this.dialogsStorage.setDialogToState(l)}if(p&&_.default.dispatchEvent("messages_read"),!a&&t){const e=i+"_";for(const t in this.threadsToReplies)if(0===t.indexOf(e)){const[e,s]=this.threadsToReplies[t].split("_");_.default.dispatchEvent("replies_updated",this.getMessageByPeer(e.toPeerId(),+s))}}},this.onUpdateReadMessagesContents=e=>{const t=e.channel_id,s=e.messages.map(e=>Z.a.generateMessageId(e)),a=t?t.toPeerId(!0):this.getMessageById(s[0]).peerId;for(let e=0,t=s.length;e<t;++e){const t=s[e],i=this.getMessageByPeer(a,t);i.deleted?this.fixDialogUnreadMentionsIfNoMessage(a):i.pFlags.media_unread&&(delete i.pFlags.media_unread,this.setDialogToStateIfMessageIsTop(i),!i.pFlags.out&&i.pFlags.mentioned&&this.modifyCachedMentions(a,t,!1))}_.default.dispatchEvent("messages_media_read",{peerId:a,mids:s})},this.onUpdateChannelAvailableMessages=e=>{const t=e.channel_id.toPeerId(!0),s=this.getHistoryStorage(t).history.slice,a=Z.a.generateMessageId(e.available_min_id),i=s.filter(e=>e<=a);e.messages=i,this.onUpdateDeleteMessages(e)},this.onUpdateDeleteMessages=e=>{const t=e.channel_id,s=e.messages.map(e=>Z.a.generateMessageId(e)),a=t?t.toPeerId(!0):this.getMessageById(s[0]).peerId;if(!a)return;p.a.clearCache("messages.getSearchCounters",e=>F.a.getPeerId(e.peer)===a);const i=new Set;for(const e of s){const t=this.getMessageByPeer(a,e),s=this.getThreadKey(t);s&&this.threadsStorage[a]&&this.threadsStorage[a][+s.split("_")[1]]&&i.add(s)}const n=this.handleDeletedMessages(a,this.getMessagesStorage(a),s),o=Array.from(i).map(e=>{const[t,s]=e.split("_");return this.getHistoryStorage(t.toPeerId(),+s)}),r=this.getHistoryStorage(a);[r].concat(o).forEach(e=>{for(const t of n.msgs)e.history.delete(t);n.count&&e.count&&(e.count=Math.max(0,e.count-n.count))}),_.default.dispatchEvent("history_delete",{peerId:a,msgs:n.msgs});const d=this.getDialogOnly(a);if(d){const e=n.unreadMentions||n.unread,t=e&&this.dialogsStorage.prepareDialogUnreadCountModifying(d);if(n.unreadMentions&&(d.unread_mentions_count=Math.max(0,d.unread_mentions_count-n.unreadMentions)),n.unread&&(d.unread_count=Math.max(0,d.unread_count-n.unread)),e&&(t(),_.default.dispatchEvent("dialog_unread",{peerId:a})),n.msgs.has(d.top_message)){const e=r.history.first;if(e.isEnd(I.a.Bottom)&&e.length){const t=e[0],s=this.getMessageByPeer(a,t);this.setDialogTopMessage(s,d)}else this.reloadConversation(a)}}},this.onUpdateChannel=e=>{const t=e.channel_id,s=t.toPeerId(!0),a=U.a.getChat(t),i=U.a.isInChat(t);(!!a.username||!a.pFlags.left)!==(void 0!==this.historiesStorage[s])&&(delete this.historiesStorage[s],_.default.dispatchEvent("history_forbidden",s));const n=this.getDialogOnly(s);!!n!==i&&(i?this.reloadConversation(s):n&&(this.dialogsStorage.dropDialog(s),_.default.dispatchEvent("dialog_drop",{peerId:s,dialog:n})))},this.onUpdateChannelReload=e=>{const t=e.channel_id.toPeerId(!0);this.dialogsStorage.dropDialog(t),delete this.historiesStorage[t],this.reloadConversation(t).then(()=>{_.default.dispatchEvent("history_reload",t)})},this.onUpdateChannelMessageViews=e=>{const t=e.views,s=e.channel_id.toPeerId(!0),a=Z.a.generateMessageId(e.id),i=this.getMessageByPeer(s,a);!i.deleted&&void 0!==i.views&&i.views<t&&(i.views=t,_.default.dispatchEvent("message_views",{peerId:s,mid:a,views:t}),this.setDialogToStateIfMessageIsTop(i))},this.onUpdateServiceNotification=e=>{const t=y.d,s=t,a=this.generateTempMessageId(s),i={_:"message",id:a,from_id:F.a.getOutputPeer(t),peer_id:F.a.getOutputPeer(s),pFlags:{unread:!0},date:(e.inbox_date||Object(o.g)(!0))+f.a.serverTimeOffset,message:e.message,media:e.media,entities:e.entities};O.a.hasUser(t)||O.a.saveApiUsers([{_:"user",id:t,pFlags:{verified:!0},access_hash:"0",first_name:"Telegram",phone:"42777"}]),this.saveMessages([i],{isOutgoing:!0}),e.inbox_date&&(this.pendingTopMsgs[s]=a,this.onUpdateNewMessage({_:"updateNewMessage",message:i,pts:void 0,pts_count:void 0}))},this.onUpdatePinnedMessages=e=>{const t="updatePinnedChannelMessages"===e._?e.channel_id:void 0,s=t?t.toPeerId(!0):F.a.getPeerId(e.peer),a=e.messages.map(e=>Z.a.generateMessageId(e)),i=this.getMessagesStorage(s),n=a.filter(e=>!i.has(e));(n.length?Promise.all(n.map(e=>this.wrapSingleMessage(s,e))):Promise.resolve()).finally(()=>{var t;const n=null===(t=e.pFlags)||void 0===t?void 0:t.pinned;if(n)for(const e of a){i.get(e).pFlags.pinned=!0}else for(const e of a){delete i.get(e).pFlags.pinned}delete this.pinnedMessages[s],T.default.getState().then(e=>{delete e.hiddenPinnedMessages[s],_.default.dispatchEvent("peer_pinned_messages",{peerId:s,mids:a,pinned:n})})})},this.onUpdateNotifySettings=e=>{const{peer:t,notify_settings:s}=e;if("notifyPeer"===t._){const e=F.a.getPeerId(t.peer),a=this.getDialogOnly(e);a&&(a.notify_settings=s,_.default.dispatchEvent("dialog_notify_settings",a),this.dialogsStorage.setDialogToState(a))}},this.onUpdateNewScheduledMessage=e=>{const t=e.message,s=this.getMessagePeer(t),a=this.scheduledMessagesStorage[s];if(a){const e=Z.a.generateMessageId(t.id),i=this.getMessageFromStorage(a,e);this.saveMessages([t],{storage:a,isScheduled:!0});const n=this.getMessageFromStorage(a,e);if(i.deleted){this.checkPendingMessage(t)||_.default.dispatchEvent("scheduled_new",{peerId:s,mid:t.mid})}else this.handleEditedMessage(i,n),_.default.dispatchEvent("message_edit",{storage:a,peerId:s,mid:t.mid})}},this.onUpdateDeleteScheduledMessages=e=>{const t=F.a.getPeerId(e.peer),s=this.scheduledMessagesStorage[t];if(s){const a=e.messages.map(e=>Z.a.generateMessageId(e));this.handleDeletedMessages(t,s,a),_.default.dispatchEvent("scheduled_delete",{peerId:t,mids:a})}},this.clear(),_.default.addMultipleEventsListeners({updateMessageID:this.onUpdateMessageId,updateNewDiscussionMessage:this.onUpdateNewMessage,updateNewMessage:this.onUpdateNewMessage,updateNewChannelMessage:this.onUpdateNewMessage,updateDialogUnreadMark:this.onUpdateDialogUnreadMark,updateEditMessage:this.onUpdateEditMessage,updateEditChannelMessage:this.onUpdateEditMessage,updateReadChannelDiscussionInbox:this.onUpdateReadHistory,updateReadChannelDiscussionOutbox:this.onUpdateReadHistory,updateReadHistoryInbox:this.onUpdateReadHistory,updateReadHistoryOutbox:this.onUpdateReadHistory,updateReadChannelInbox:this.onUpdateReadHistory,updateReadChannelOutbox:this.onUpdateReadHistory,updateChannelReadMessagesContents:this.onUpdateReadMessagesContents,updateReadMessagesContents:this.onUpdateReadMessagesContents,updateChannelAvailableMessages:this.onUpdateChannelAvailableMessages,updateDeleteMessages:this.onUpdateDeleteMessages,updateDeleteChannelMessages:this.onUpdateDeleteMessages,updateChannel:this.onUpdateChannel,updateChannelReload:this.onUpdateChannelReload,updateChannelMessageViews:this.onUpdateChannelMessageViews,updateServiceNotification:this.onUpdateServiceNotification,updatePinnedMessages:this.onUpdatePinnedMessages,updatePinnedChannelMessages:this.onUpdatePinnedMessages,updateNotifySettings:this.onUpdateNotifySettings,updateNewScheduledMessage:this.onUpdateNewScheduledMessage,updateDeleteScheduledMessages:this.onUpdateDeleteScheduledMessages}),_.default.addEventListener("notify_peer_type_settings",({key:e,settings:t})=>{let s;s="notifyUsers"===e?e=>e.peerId.isUser():"notifyBroadcasts"===e?e=>e.peerId.isBroadcast():e=>F.a.isAnyGroup(e.peerId),this.dialogsStorage.getFolderDialogs(0).concat(this.dialogsStorage.getFolderDialogs(1)).filter(s).forEach(e=>{_.default.dispatchEvent("dialog_notify_settings",e)})}),_.default.addEventListener("webpage_updated",({id:e,msgs:t})=>{t.forEach(({peerId:t,mid:s,isScheduled:a})=>{const i=a?this.getScheduledMessagesStorage(t):this.getMessagesStorage(t),n=this.getMessageFromStorage(i,s);n&&(n.media={_:"messageMediaWebPage",webpage:L.a.getWebPage(e)},_.default.dispatchEvent("message_edit",{storage:i,peerId:t,mid:s}))})}),_.default.addEventListener("draft_updated",({peerId:e,threadId:t,draft:s})=>{if(t)return;const a=this.getDialogOnly(e);if(a){if(!t){a.draft=s;let t=!1;s||Z.a.getServerMessageId(a.top_message)?(this.dialogsStorage.generateIndexForDialog(a),this.dialogsStorage.pushDialog(a)):(this.dialogsStorage.dropDialog(e),t=!0),_.default.dispatchEvent("dialog_draft",{peerId:e,dialog:a,drop:t,draft:s,index:a.index})}}else this.reloadConversation(e)}),_.default.addEventListener("poll_update",({poll:e})=>{const t=x.a.pollToMessages[e.id];if(t)for(const e of t){const[t,s]=e.split("_"),a=this.getMessageByPeer(t.toPeerId(),+s);this.setDialogToStateIfMessageIsTop(a)}}),T.default.getState().then(e=>{e.maxSeenMsgId&&(this.maxSeenId=e.maxSeenMsgId)})}clear(){this.middleware?this.middleware.clean():this.middleware=Object(Q.a)(),this.messagesStorageByPeerId={},this.groupedMessagesStorage={},this.scheduledMessagesStorage={},this.historiesStorage={},this.threadsStorage={},this.searchesStorage={},this.pinnedMessages={},this.threadsServiceMessagesIdsStorage={},this.threadsToReplies={},this.dialogsStorage&&this.dialogsStorage.clear(),this.filtersStorage&&this.filtersStorage.clear()}construct(){this.filtersStorage=new w(this,F.a,O.a,H.a,T.default,D.a,_.default),this.dialogsStorage=new b(this,U.a,F.a,O.a,j.a,H.a,T.default,D.a,f.a,Z.a)}getInputEntities(e){const t=Object(d.a)(e);return t.forEach(e=>{"messageEntityMentionName"===e._&&(e._="inputMessageEntityMentionName",e.user_id=O.a.getUserInput(e.user_id))}),t}invokeAfterMessageIsSent(e,t,s){var a,i;const o=null!==(a=this.tempFinalizeCallbacks[e])&&void 0!==a?a:this.tempFinalizeCallbacks[e]={},r=null!==(i=o[t])&&void 0!==i?i:o[t]={deferred:Object(n.a)()};return r.callback=s,r.deferred}editMessage(e,t,s={}){const{mid:a,peerId:i}=e;if(e.pFlags.is_outgoing)return this.invokeAfterMessageIsSent(a,"edit",e=>this.editMessage(e,t,s));let n=s.entities||[];t&&(t=m.a.parseMarkdown(t,n));const o=s.scheduleDate||(e.pFlags.is_scheduled?e.date:void 0);return p.a.invokeApi("messages.editMessage",{peer:F.a.getInputPeerById(i),id:e.id,message:t,media:s.newMedia,entities:n.length?this.getInputEntities(n):void 0,no_webpage:s.noWebPage,schedule_date:o}).then(e=>{D.a.processUpdateMessage(e)},e=>{if(this.log.error("editMessage error:",e),!e||"MESSAGE_NOT_MODIFIED"!==e.type)return e&&"MESSAGE_EMPTY"===e.type&&(e.handled=!0),Promise.reject(e);e.handled=!0})}sendText(e,t,s={}){if("string"!=typeof t||!t.length)return;s.threadId&&!s.replyToMsgId&&(s.replyToMsgId=s.threadId);const a=_.default.config.message_length_max;if(t.length>a){const i=Object(h.g)(t,a);t=i[0],i.length>1&&delete s.webPage;for(let t=1;t<i.length;++t)setTimeout(()=>{this.sendText(e,i[t],s)},t)}e=F.a.getPeerMigratedTo(e)||e;let i=s.entities||[];s.viaBotId||(t=m.a.parseMarkdown(t,i));let n=this.getInputEntities(i);n.length||(n=void 0);const o=this.generateOutgoingMessage(e,s);o.entities=i,o.message=t;const r=s.replyToMsgId?Z.a.getServerMessageId(s.replyToMsgId):void 0,l=F.a.isChannel(e);s.webPage&&(o.media={_:"messageMediaWebPage",webpage:s.webPage});const c=e=>{e?o.error=!0:delete o.error,_.default.dispatchEvent("messages_pending")};o.send=()=>{c(!1);const a={};let i;return this.pendingAfterMsgs[e]&&(a.afterMessageId=this.pendingAfterMsgs[e].messageId),i=s.viaBotId?p.a.invokeApiAfter("messages.sendInlineBotResult",{peer:F.a.getInputPeerById(e),random_id:o.random_id,reply_to_msg_id:r||void 0,query_id:s.queryId,id:s.resultId,clear_draft:s.clearDraft},a):p.a.invokeApiAfter("messages.sendMessage",{no_webpage:s.noWebPage,peer:F.a.getInputPeerById(e),message:t,random_id:o.random_id,reply_to_msg_id:r||void 0,entities:n,clear_draft:s.clearDraft,schedule_date:s.scheduleDate||void 0,silent:s.silent},a),this.pendingAfterMsgs[e]=a,i.then(e=>{if("updateShortSentMessage"===e._){const t=Object(d.a)(o);t.date=e.date,t.id=e.id,t.media=e.media,t.entities=e.entities,this.wrapMessageEntities(t),e.pFlags.out&&(t.pFlags.out=!0),e={_:"updates",users:[],chats:[],seq:0,date:void 0,updates:[{_:"updateMessageID",random_id:o.random_id,id:t.id},{_:s.scheduleDate?"updateNewScheduledMessage":l?"updateNewChannelMessage":"updateNewMessage",message:t,pts:e.pts,pts_count:e.pts_count}]}}else e.updates&&e.updates.forEach(e=>{"updateDraftMessage"===e._&&(e.local=!0)});D.a.processUpdateMessage(e)},()=>{c(!0)}).finally(()=>{this.pendingAfterMsgs[e]===a&&delete this.pendingAfterMsgs[e]})},this.beforeMessageSending(o,{isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft})}sendFile(e,t,s={}){e=F.a.getPeerMigratedTo(e)||e;const a=this.generateOutgoingMessage(e,s),o=s.replyToMsgId?Z.a.getServerMessageId(s.replyToMsgId):void 0;let d,l;const h="mime_type"in t?t.mime_type:t.type,c=t instanceof File?t.name:"",g=!(t instanceof File||t instanceof Blob);let u=s.caption||"";this.log("sendFile",t,h);const f=s.entities||[];u&&(u=m.a.parseMarkdown(u,f));const v=[],M=J.a.has(h);let I,y,P;if(g)d="document",l="";else if(0===h.indexOf("audio/")||["video/ogg"].indexOf(h)>=0){d="audio",l="audio."+("ogg"===h.split("/")[1]?"ogg":"mp3"),P="sendMessageUploadAudioAction",s.isVoiceMessage&&(d="voice",a.pFlags.media_unread=!0);let e={_:"documentAttributeAudio",pFlags:{voice:s.isVoiceMessage},waveform:s.waveform,duration:s.duration||0};v.push(e)}else if(s.isMedia)if(M){d="photo",l="photo."+h.split("/")[1],P="sendMessageUploadPhotoAction";const e={_:"photoSize",w:s.width,h:s.height,type:"full",location:null,size:t.size};I={_:"photo",id:""+a.id,sizes:[e],w:s.width,h:s.height};const i=A.a.getCacheContext(I,e.type);i.downloaded=t.size,i.url=s.objectURL||"",I=k.a.savePhoto(I)}else if(X.a.has(h)){d="video",l="video.mp4",P="sendMessageUploadVideoAction";const e={_:"documentAttributeVideo",pFlags:{round_message:s.isRoundMessage,supports_streaming:!0},duration:s.duration,w:s.width,h:s.height};v.push(e),s.noSound&&t.size>10240&&t.size<10485760&&v.push({_:"documentAttributeAnimated"})}else d="document",l="document."+h.split("/")[1],P="sendMessageUploadDocumentAction";else d="document",l="document."+h.split("/")[1],P="sendMessageUploadDocumentAction";if(v.push({_:"documentAttributeFilename",file_name:c||l}),-1!==["document","video","audio","voice"].indexOf(d)&&!g){const e=[];y={_:"document",id:""+a.id,duration:s.duration,attributes:v,w:s.width,h:s.height,thumbs:e,mime_type:h,size:t.size};const i=A.a.getCacheContext(y);let n;if(i.downloaded=t.size,i.url=s.objectURL||"",M)v.push({_:"documentAttributeImageSize",w:s.width,h:s.height}),n={_:"photoSize",w:s.width,h:s.height,type:"full",size:t.size};else if("video"===d&&s.thumb){n={_:"photoSize",w:s.thumb.size.width,h:s.thumb.size.height,type:"local-thumb",size:s.thumb.blob.size};const e=A.a.getCacheContext(y,n.type);e.downloaded=n.size,e.url=s.thumb.url}n&&e.push(n),y=E.a.saveDoc(y)}this.log("sendFile",d,l,t.type,s);const b=g?void 0:new i.a({attachMethod:"prepend",tryAgainOnFail:!1,isUpload:!0}),S=Object(n.a)();b&&(b.attachPromise(S),S.cancel=()=>{const e=new Error("Download canceled");e.name="AbortError",S.reject(e)},S.catch(t=>{"AbortError"!==t.name||U||(this.log("cancelling upload",C),this.cancelPendingMessage(a.random_id),this.setTyping(e,{_:"sendMessageCancelAction"}),(null==x?void 0:x.cancel)&&x.cancel())}));const C=g?void 0:{_:I?"messageMediaPhoto":"messageMediaDocument",pFlags:{},preloader:b,photo:I,document:y,promise:S};a.entities=f,a.message=u,a.media=g?{_:"messageMediaDocument",pFlags:{},document:t}:C;const w=e=>{e?a.error=!0:delete a.error,_.default.dispatchEvent("messages_pending")};let U=!1,x=null;return a.send=()=>{if(g){const{id:e,access_hash:s,file_reference:a}=t,i={_:"inputMediaDocument",id:{_:"inputDocument",id:e,access_hash:s,file_reference:a}};S.resolve(i)}else if(t instanceof File||t instanceof Blob){const i=()=>{let i;return U&&!a.error||(U=!1,x=A.a.upload(t),S.notifyAll({done:0,total:t.size})),"video"===d&&s.objectURL&&(i=new Promise((e,t)=>{(s.thumb&&s.thumb.blob?Promise.resolve(s.thumb):Object(r.a)(s.objectURL)).then(s=>{s?A.a.upload(s.blob).then(e,t):e(null)},t)})),x&&x.then(e=>ee(this,void 0,void 0,(function*(){let t;switch(delete a.media.preloader,e.name=l,U=!0,d){case"photo":t={_:"inputMediaUploadedPhoto",file:e};break;default:t={_:"inputMediaUploadedDocument",file:e,mime_type:h,pFlags:{force_file:"sendMessageUploadDocumentAction"===P||void 0},attributes:v}}if(i)try{const e=yield i;t.thumb=e}catch(e){this.log.error("sendFile thumb upload error:",e)}S.resolve(t)})),()=>{w(!0)}),x.addNotifyListener(t=>{const s=Math.max(1,Math.floor(100*t.done/t.total));P&&this.setTyping(e,{_:P,progress:0|s}),S.notifyAll(t)}),S};s.isGroupedItem?i():this.sendSmthLazyLoadQueue.push({load:i})}return S},this.beforeMessageSending(a,{isGroupedItem:s.isGroupedItem,isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft}),s.isGroupedItem||S.then(t=>(this.setTyping(e,{_:"sendMessageCancelAction"}),p.a.invokeApi("messages.sendMedia",{background:s.background,peer:F.a.getInputPeerById(e),media:t,message:u,random_id:a.random_id,reply_to_msg_id:o,schedule_date:s.scheduleDate,silent:s.silent,entities:f,clear_draft:s.clearDraft}).then(e=>{D.a.processUpdateMessage(e)},e=>{if("photo"===d&&400===e.code&&("PHOTO_INVALID_DIMENSIONS"===e.type||"PHOTO_SAVE_FILE_INVALID"===e.type))return e.handled=!0,d="document",void a.send();w(!0)}))),{message:a,promise:S}}sendAlbum(e,t,s={}){return ee(this,void 0,void 0,(function*(){if(s.threadId&&!s.replyToMsgId&&(s.replyToMsgId=s.threadId),1===t.length)return this.sendFile(e,t[0],Object.assign(Object.assign({},s),s.sendFileDetails[0]));e=F.a.getPeerMigratedTo(e)||e;const a=s.replyToMsgId?Z.a.getServerMessageId(s.replyToMsgId):void 0;let i=s.caption||"",n=s.entities||[];i&&(i=m.a.parseMarkdown(i,n)),this.log("sendAlbum",t,s);const o=""+ ++this.groupedTempId,r=t.map((t,r)=>{const d=s.sendFileDetails[r],l=Object.assign({isGroupedItem:!0,isMedia:s.isMedia,scheduleDate:s.scheduleDate,silent:s.silent,replyToMsgId:a,threadId:s.threadId,groupId:o},d);return 0===r&&(l.caption=i,l.entities=n),this.sendFile(e,t,l).message});s.clearDraft&&setTimeout(()=>{j.a.clearDraft(e,s.threadId)},0);const d=(e,t)=>{t?e.error=!0:delete e.error,_.default.dispatchEvent("messages_pending")},l=F.a.getInputPeerById(e),h=t=>{this.setTyping(e,{_:"sendMessageCancelAction"}),this.sendSmthLazyLoadQueue.push({load:()=>p.a.invokeApi("messages.sendMultiMedia",{peer:l,multi_media:t,reply_to_msg_id:a,schedule_date:s.scheduleDate,silent:s.silent,clear_draft:s.clearDraft}).then(e=>{D.a.processUpdateMessage(e)},e=>{r.forEach(e=>d(e,!0))})})},c=r.map((e,t)=>e.send().then(e=>p.a.invokeApi("messages.uploadMedia",{peer:l,media:e})).then(t=>{let s;if("messageMediaPhoto"===t._){const e=k.a.savePhoto(t.photo);s=k.a.getMediaInput(e)}else if("messageMediaDocument"===t._){const e=E.a.saveDoc(t.document);s=E.a.getMediaInput(e)}const a={_:"inputSingleMedia",media:s,random_id:e.random_id,message:i,entities:n};return i&&(i="",n=[]),a}).catch(t=>{if("AbortError"===t.name)return null;throw this.log.error("sendAlbum upload item error:",t,e),d(e,!0),t}));Promise.all(c).then(e=>{h(e.filter(Boolean))})}))}sendOther(e,t,s={}){var a;e=F.a.getPeerMigratedTo(e)||e;const i=this.generateOutgoingMessage(e,s),n=s.replyToMsgId?Z.a.getServerMessageId(s.replyToMsgId):void 0;let o;switch(t._){case"inputMediaPoll":{const e=""+i.id;t.poll.id=e,x.a.savePoll(t.poll,{_:"pollResults",flags:4,total_voters:0,pFlags:{}});const{poll:s,results:a}=x.a.getPoll(e);o={_:"messageMediaPoll",poll:s,results:a};break}case"inputMediaPhoto":o={_:"messageMediaPhoto",photo:k.a.getPhoto(t.id.id)};break;case"inputMediaDocument":o={_:"messageMediaDocument",document:E.a.getDoc(t.id.id)};break;case"inputMediaContact":o={_:"messageMediaContact",phone_number:t.phone_number,first_name:t.first_name,last_name:t.last_name,user_id:null!==(a=t.user_id)&&void 0!==a?a:"0",vcard:t.vcard};break;case"inputMediaGeoPoint":o={_:"messageMediaGeo",geo:s.geoPoint};break;case"inputMediaVenue":o={_:"messageMediaVenue",geo:s.geoPoint,title:t.title,address:t.address,provider:t.provider,venue_id:t.venue_id,venue_type:t.venue_type};break;case"messageMediaPending":o=t}i.media=o;i.send=()=>{const a={};let o;return this.pendingAfterMsgs[e]&&(a.afterMessageId=this.pendingAfterMsgs[e].messageId),o=s.viaBotId?p.a.invokeApiAfter("messages.sendInlineBotResult",{peer:F.a.getInputPeerById(e),random_id:i.random_id,reply_to_msg_id:n||void 0,query_id:s.queryId,id:s.resultId,clear_draft:s.clearDraft,schedule_date:s.scheduleDate,silent:s.silent},a):p.a.invokeApiAfter("messages.sendMedia",{peer:F.a.getInputPeerById(e),media:t,random_id:i.random_id,reply_to_msg_id:n||void 0,message:"",clear_draft:s.clearDraft,schedule_date:s.scheduleDate,silent:s.silent},a),this.pendingAfterMsgs[e]=a,o.then(e=>{e.updates&&e.updates.forEach(e=>{"updateDraftMessage"===e._&&(e.local=!0)}),D.a.processUpdateMessage(e)},e=>{_.default.dispatchEvent("messages_pending")}).finally(()=>{this.pendingAfterMsgs[e]===a&&delete this.pendingAfterMsgs[e]})},this.beforeMessageSending(i,{isScheduled:!!s.scheduleDate||void 0,threadId:s.threadId,clearDraft:s.clearDraft})}beforeMessageSending(e,t={}){const s=e.id,a=this.getMessagePeer(e),i=t.isScheduled?this.getScheduledMessagesStorage(a):this.getMessagesStorage(a);if(t.isScheduled)this.saveMessages([e],{storage:i,isScheduled:!0,isOutgoing:!0}),setTimeout(()=>{_.default.dispatchEvent("scheduled_new",{peerId:a,mid:s})},0);else{const n=[this.getHistoryStorage(a),t.threadId?this.getHistoryStorage(a,t.threadId):void 0];for(const e of n)e&&e.history.unshift(s);this.saveMessages([e],{storage:i,isOutgoing:!0}),this.setDialogTopMessage(e),setTimeout(()=>{_.default.dispatchEvent("history_append",{storage:i,peerId:a,mid:s})},0)}this.pendingByRandomId[e.random_id]={peerId:a,tempId:s,threadId:t.threadId,storage:i},!t.isGroupedItem&&e.send&&setTimeout(()=>{t.clearDraft&&j.a.clearDraft(a,t.threadId),e.send()},0)}generateOutgoingMessage(e,t){let s;t.threadId&&!t.replyToMsgId&&(t.replyToMsgId=t.threadId);const a=F.a.isBroadcast(e);if(a){if(F.a.getPeer(e).pFlags.signatures){const e=O.a.getSelf();s=e.first_name+(e.last_name?" "+e.last_name:"")}}return{_:"message",id:this.generateTempMessageId(e),from_id:this.generateFromId(e),peer_id:F.a.getOutputPeer(e),post_author:s,pFlags:this.generateFlags(e),date:t.scheduleDate||Object(o.g)(!0)+f.a.serverTimeOffset,message:"",grouped_id:t.groupId,random_id:Object(l.b)(),reply_to:this.generateReplyHeader(t.replyToMsgId,t.threadId),via_bot_id:t.viaBotId,reply_markup:t.replyMarkup,replies:this.generateReplies(e),views:a&&1,pending:!0}}generateReplyHeader(e,t){const s={_:"messageReplyHeader",reply_to_msg_id:e||t};return t&&s.reply_to_msg_id!==t&&(s.reply_to_top_id=t),s}generateReplies(e){let t;if(F.a.isBroadcast(e)){const s=B.default.chatsFull[e.toChatId()];(null==s?void 0:s.linked_chat_id)&&(t={_:"messageReplies",flags:1,pFlags:{comments:!0},channel_id:s.linked_chat_id,replies:0,replies_pts:0})}return t}generateFromId(e){return e.isAnyChat()&&(e.isBroadcast()||this.isAnonymousSending(e))?void 0:F.a.getOutputPeer(O.a.getSelf().id.toPeerId())}generateFlags(e){const t={};return e!==O.a.getSelf().id&&(t.out=!0,F.a.isChannel(e)||O.a.isBot(e)||(t.unread=!0)),F.a.isBroadcast(e)&&(t.post=!0),t}generateForwardHeader(e,t){const s=O.a.getSelf().id;if(t.fromId===s&&t.peerId===s&&!t.fwd_from)return;const a={_:"messageFwdHeader",flags:0,date:t.date};return t.fwd_from?(a.from_id=t.fwd_from.from_id,a.from_name=t.fwd_from.from_name,a.post_author=t.fwd_from.post_author):(a.from_id=F.a.getOutputPeer(t.fromId),a.post_author=t.post_author),F.a.isBroadcast(t.peerId)&&(t.post_author&&(a.post_author=t.post_author),a.channel_post=t.id),e===s&&(a.saved_from_msg_id=t.id,a.saved_from_peer=F.a.getOutputPeer(t.peerId)),a}generateFakeAvatarMessage(e,t){const s=Number.MAX_SAFE_INTEGER,a={_:"messageService",action:{_:"messageActionChannelEditPhoto",photo:t},mid:s,peerId:e,date:t.date,fromId:e};return this.getMessagesStorage(e).set(s,a),a}isAnonymousSending(e){var t,s;return e.isAnyChat()&&(null===(s=null===(t=F.a.getPeer(e).admin_rights)||void 0===t?void 0:t.pFlags)||void 0===s?void 0:s.anonymous)}setDialogTopMessage(e,t=this.getDialogOnly(e.peerId)){if(t){t.top_message=e.mid;this.getHistoryStorage(e.peerId).maxId=e.mid,this.dialogsStorage.generateIndexForDialog(t,!1,e),this.scheduleHandleNewDialogs(e.peerId,t)}}cancelPendingMessage(e){const t=this.pendingByRandomId[e];if(t){const{peerId:s,tempId:a,storage:i}=t,n=this.getHistoryStorage(s);return D.a.processLocalUpdate({_:"updateDeleteMessages",messages:[a],pts:void 0,pts_count:void 0}),n.history.delete(a),delete this.pendingByRandomId[e],i.delete(a),!0}return!1}fillConversations(){return ee(this,void 0,void 0,(function*(){const e=this.middleware.get();for(;!this.dialogsStorage.isDialogsLoaded(void 0);){const t=yield this.getTopMessages(100,void 0);if(!e()||t.isEnd)break}}))}getConversations(e="",t,s,a=0,i){return this.dialogsStorage.getDialogs(e,t,s,a,i)}getReadMaxIdIfUnread(e,t){var s;const a=this.getHistoryStorage(e,t);if(t){const t=this.getHistoryStorage(e),i=Math.max(null!==(s=t.readMaxId)&&void 0!==s?s:0,a.readMaxId);return!this.getMessageByPeer(e,a.maxId).pFlags.out&&i<a.maxId?i:0}{const t=this.getMessageByPeer(e,a.maxId),s=e.isUser()?Math.max(a.readMaxId,a.readOutboxMaxId):a.readMaxId;return!t.pFlags.out&&s<a.maxId?s:0}}getTopMessages(e,t,s){let a=0;void 0===s&&(s=this.dialogsStorage.getOffsetDate(t)),s&&(a=65536*s,s+=f.a.serverTimeOffset);const i=this.middleware.get(),n={folder_id:t,offset_date:s,offset_id:0,offset_peer:F.a.getInputPeerById(void 0),limit:100,hash:"0"};return p.a.invokeApiSingle("messages.getDialogs",n,{noErrorBox:!0}).then(o=>{if(!i()||"messages.dialogsNotModified"===o._)return null;N.b&&this.log("messages.getDialogs result:",o.dialogs,Object.assign({},o.dialogs[0])),s||void 0===t||this.dialogsStorage.resetPinnedOrder(t),s||$.default.setAuthorized(!0),O.a.saveApiUsers(o.users),U.a.saveApiChats(o.chats),this.saveMessages(o.messages);let r=!!s,d=!1;const l={},h=void 0===t?0:t,c=void 0===t;Object(M.d)(o.dialogs,e=>{void 0===e.folder_id&&(e.folder_id=h),this.dialogsStorage.saveDialog(e,void 0,!0,c),r||F.a.isChannel(e.peerId||F.a.getPeerId(e.peer))||(this.incrementMaxSeenId(e.top_message),r=!0),void 0!==e.peerId&&(a&&e.index>a&&(this.scheduleHandleNewDialogs(e.peerId,e),d=!0),Z.a.getServerMessageId(e.read_inbox_max_id)||Z.a.getServerMessageId(e.read_outbox_max_id)||(l[e.peerId]=e,this.log.error("noIdsDialogs",e,n)))});const g=Object.keys(l);if(g.length){const e=g.map(e=>e.toPeerId()),t=e.map(e=>this.reloadConversation(e));Promise.all(t).then(()=>{_.default.dispatchEvent("dialogs_multiupdate",l);for(let t=0;t<e.length;++t)_.default.dispatchEvent("dialog_unread",{peerId:e[t]})})}const p=o.count,u=this.dialogsStorage.getFolderDialogs(t,!1);let f=0;for(let e=0,t=u.length;e<t;++e)Z.a.getServerMessageId(u[e].top_message)&&++f;const m=!p||f>=p||!o.dialogs.length;m&&this.dialogsStorage.setDialogsLoaded(t,!0),d?this.scheduleHandleNewDialogs():_.default.dispatchEvent("dialogs_multiupdate",{});const v=o.dialogs,I=100===e?v:v.slice(0,e);return{isEnd:m&&I[I.length-1]===v[v.length-1],count:p,dialogs:I}})}forwardMessages(e,t,s,a={}){e=F.a.getPeerMigratedTo(e)||e,s=s.slice().sort((e,t)=>e-t);const i={},n=s.map(s=>{var n,o;const r=this.getMessageByPeer(t,s),d=this.generateOutgoingMessage(e,a);d.fwd_from=this.generateForwardHeader(e,r),["entities","forwards","message","media","reply_markup","views"].forEach(e=>{d[e]=r[e]});const l=null===(n=d.media)||void 0===n?void 0:n.document;if(l){["round","voice"].includes(l.type)&&(d.pFlags.media_unread=!0)}if(r.grouped_id){(null!==(o=i[r.grouped_id])&&void 0!==o?o:i[r.grouped_id]={tempId:""+ ++this.groupedTempId,messages:[]}).messages.push(d)}return d});for(const e in i){const t=i[e];t.messages.length>1&&t.messages.forEach(e=>{e.grouped_id=t.tempId})}n.forEach(e=>{this.beforeMessageSending(e,{isScheduled:!!a.scheduleDate||void 0})});const o={};this.pendingAfterMsgs[e]&&(o.afterMessageId=this.pendingAfterMsgs[e].messageId);const r=p.a.invokeApiAfter("messages.forwardMessages",{from_peer:F.a.getInputPeerById(t),id:s.map(e=>Z.a.getServerMessageId(e)),random_id:n.map(e=>e.random_id),to_peer:F.a.getInputPeerById(e),with_my_score:a.withMyScore,silent:a.silent,schedule_date:a.scheduleDate},o).then(e=>{this.log("forwardMessages updates:",e),D.a.processUpdateMessage(e)}).finally(()=>{this.pendingAfterMsgs[e]===o&&delete this.pendingAfterMsgs[e]});return this.pendingAfterMsgs[e]=o,r}generateEmptyMessage(e){return{_:"messageEmpty",id:Z.a.getServerMessageId(e),mid:e,deleted:!0,pFlags:{}}}getMessageFromStorage(e,t){return e&&e.get(t)||this.generateEmptyMessage(t)}createMessageStorage(){return new Map}getMessagesStorage(e){var t;return null!==(t=this.messagesStorageByPeerId[e])&&void 0!==t?t:this.messagesStorageByPeerId[e]=this.createMessageStorage()}getMessageById(e){for(const t in this.messagesStorageByPeerId){if(F.a.isChannel(t.toPeerId()))continue;const s=this.messagesStorageByPeerId[t].get(e);if(s)return s}return this.getMessageFromStorage(null,e)}getMessageByPeer(e,t){return e?this.getMessageFromStorage(this.getMessagesStorage(e),t):this.getMessageById(t)}getMessagePeer(e){return e.peer_id&&F.a.getPeerId(e.peer_id)||y.b}getDialogByPeerId(e){return this.dialogsStorage.getDialog(e)}getDialogOnly(e){return this.dialogsStorage.getDialogOnly(e)}reloadConversation(e){let t;if(void 0!==e){const s=F.a.getPeerId(e);let a=this.reloadConversationsPeers.get(s);if(a&&(t=a.promise),t)return t;t=Object(n.a)(),this.reloadConversationsPeers.set(s,a={inputDialogPeer:F.a.getInputDialogPeerById(e),promise:t})}return this.reloadConversationsPromise||(this.reloadConversationsPromise=new Promise((e,t)=>{setTimeout(()=>{const s=[],a={};for(const[e,{inputDialogPeer:t,promise:i}]of this.reloadConversationsPeers)s.push(t),a[e]=i;this.reloadConversationsPeers.clear();const i=()=>{for(const e in a)a[e].resolve(void 0)};p.a.invokeApi("messages.getPeerDialogs",{peers:s}).then(t=>{this.dialogsStorage.applyDialogs(t),t.dialogs.forEach(e=>{const t=e.peerId;t&&(a[t].resolve(e),delete a[t])}),i(),e()},e=>{i(),t(e)}).finally(()=>{this.reloadConversationsPromise=null,this.reloadConversationsPeers.size&&this.reloadConversation()})},0)})),t||this.reloadConversationsPromise}doFlushHistory(e,t,s){return p.a.invokeApiSingle("messages.deleteHistory",{just_clear:t,revoke:s,peer:e,max_id:0}).then(a=>(D.a.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:a.pts,pts_count:a.pts_count}}),!a.offset||this.doFlushHistory(e,t,s)))}flushHistory(e,t,s){return ee(this,void 0,void 0,(function*(){if(F.a.isChannel(e)){const t=this.getHistory(e,0,1),s=t instanceof Promise?yield t:t,a=e.toChatId(),i=s.history[0]||0;return p.a.invokeApiSingle("channels.deleteHistory",{channel:U.a.getChannelInput(a),max_id:Z.a.getServerMessageId(i)}).then(()=>(D.a.processLocalUpdate({_:"updateChannelAvailableMessages",channel_id:a,available_min_id:i}),!0))}return this.doFlushHistory(F.a.getInputPeerById(e),t,s).then(()=>{[this.historiesStorage,this.threadsStorage,this.searchesStorage,this.pinnedMessages,this.pendingAfterMsgs,this.pendingTopMsgs].forEach(t=>{delete t[e]});const s=this.needSingleMessages.get(e);s&&s.clear(),[this.messagesStorageByPeerId,this.scheduledMessagesStorage].forEach(t=>{const s=t[e];s&&s.clear()}),t?_.default.dispatchEvent("dialog_flush",{peerId:e}):(delete this.notificationsToHandle[e],delete this.typings[e],this.reloadConversationsPeers.delete(e),this.dialogsStorage.dropDialog(e),_.default.dispatchEvent("dialog_drop",{peerId:e}))})}))}hidePinnedMessages(e){return Promise.all([T.default.getState(),this.getPinnedMessage(e)]).then(([t,s])=>{t.hiddenPinnedMessages[e]=s.maxId,_.default.dispatchEvent("peer_pinned_hidden",{peerId:e,maxId:s.maxId})})}getPinnedMessage(e){var t;const s=null!==(t=this.pinnedMessages[e])&&void 0!==t?t:this.pinnedMessages[e]={};return s.promise?s.promise:s.maxId?Promise.resolve(s):s.promise=this.getSearch({peerId:e,inputFilter:{_:"inputMessagesFilterPinned"},maxId:0,limit:1}).then(e=>{var t;return s.count=e.count,s.maxId=null===(t=e.history[0])||void 0===t?void 0:t.mid,s}).finally(()=>{delete s.promise})}updatePinnedMessage(e,t,s,a,i){return p.a.invokeApi("messages.updatePinnedMessage",{peer:F.a.getInputPeerById(e),unpin:s,silent:a,pm_oneside:i,id:Z.a.getServerMessageId(t)}).then(e=>{D.a.processUpdateMessage(e)})}unpinAllMessages(e){return p.a.invokeApiSingle("messages.unpinAllMessages",{peer:F.a.getInputPeerById(e)}).then(t=>{if(D.a.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:t.pts,pts_count:t.pts_count}}),!t.offset){return this.getMessagesStorage(e).forEach(e=>{e.pFlags.pinned&&delete e.pFlags.pinned}),_.default.dispatchEvent("peer_pinned_messages",{peerId:e,unpinAll:!0}),delete this.pinnedMessages[e],!0}return this.unpinAllMessages(e)})}getAlbumText(e){const t=this.groupedMessagesStorage[e];let s,a,i,n=0;for(const[e,o]of t)if(o.message){if(++n>1)break;s=o.message,a=o.totalEntities,i=o.entities}return n>1&&(s=void 0,a=void 0,i=void 0),{message:s,entities:i,totalEntities:a}}getMidsByAlbum(e){return Object(d.e)(this.groupedMessagesStorage[e],"asc")}getMidsByMessage(e){return(null==e?void 0:e.grouped_id)?this.getMidsByAlbum(e.grouped_id):[e.mid]}filterMessages(e,t){const s=[];if(e.grouped_id){const a=this.groupedMessagesStorage[e.grouped_id];for(const[e,i]of a)t(i)&&s.push(i)}else t(e)&&s.push(e);return s}generateTempMessageId(e){const t=this.getDialogOnly(e);return Z.a.generateMessageId((null==t?void 0:t.top_message)||0,!0)}saveMessage(e,t={}){var s,a;if(void 0===e.pFlags&&(e.pFlags={}),"messageEmpty"===e._)return void(e.deleted=!0);const i=this.getMessagePeer(e),n=t.storage||this.getMessagesStorage(i),o="peerChannel"===e.peer_id._,r=o&&U.a.isBroadcast(i.toChatId());t.isScheduled&&(e.pFlags.is_scheduled=!0),t.isOutgoing&&(e.pFlags.is_outgoing=!0);const d=Z.a.generateMessageId(e.id);if(e.mid=d,e.grouped_id){(null!==(s=this.groupedMessagesStorage[e.grouped_id])&&void 0!==s?s:this.groupedMessagesStorage[e.grouped_id]=new Map).set(d,e)}const l=this.getDialogOnly(i);l&&d&&d>l[e.pFlags.out?"read_outbox_max_id":"read_inbox_max_id"]&&(e.pFlags.unread=!0),e.reply_to&&(e.reply_to.reply_to_msg_id&&(e.reply_to.reply_to_msg_id=e.reply_to_mid=Z.a.generateMessageId(e.reply_to.reply_to_msg_id)),e.reply_to.reply_to_top_id&&(e.reply_to.reply_to_top_id=Z.a.generateMessageId(e.reply_to.reply_to_top_id))),e.replies&&(e.replies.max_id&&(e.replies.max_id=Z.a.generateMessageId(e.replies.max_id)),e.replies.read_max_id&&(e.replies.read_max_id=Z.a.generateMessageId(e.replies.read_max_id)));const h=!!i;h||(e.date-=f.a.serverTimeOffset);const c=O.a.getSelf().id;e.peerId=i,e.fromId=i===c?e.fwd_from?e.fwd_from.from_id?F.a.getPeerId(e.fwd_from.from_id):0:c:e.pFlags.post||!e.from_id?i:F.a.getPeerId(e.from_id);const g=e.fwd_from;if(g){g.saved_from_msg_id&&(g.saved_from_msg_id=Z.a.generateMessageId(g.saved_from_msg_id)),g.channel_post&&(g.channel_post=Z.a.generateMessageId(g.channel_post));const t=g.saved_from_peer||g.from_id,s=g.saved_from_msg_id||g.channel_post;if(t&&s){const a=F.a.getPeerId(t),i=Z.a.generateMessageId(s);e.savedFrom=a+"_"+i}e.fwdFromId=F.a.getPeerId(g.from_id),h||(g.date-=f.a.serverTimeOffset)}e.via_bot_id>0&&(e.viaBotId=e.via_bot_id);const p={type:"message",peerId:i,messageId:d};if(e.media)switch(e.media._){case"messageMediaEmpty":delete e.media;break;case"messageMediaPhoto":e.media.ttl_seconds?e.media={_:"messageMediaUnsupportedWeb"}:e.media.photo=k.a.savePhoto(e.media.photo,p),e.media.photo||delete e.media;break;case"messageMediaPoll":{const t=x.a.savePoll(e.media.poll,e.media.results,e);e.media.poll=t.poll,e.media.results=t.results;break}case"messageMediaDocument":e.media.ttl_seconds?e.media={_:"messageMediaUnsupportedWeb"}:e.media.document=E.a.saveDoc(e.media.document,p);break;case"messageMediaWebPage":{const s=L.a.getMessageKeyForPendingWebPage(i,d,t.isScheduled);e.media.webpage=L.a.saveWebPage(e.media.webpage,s,p);break}case"messageMediaInvoice":e.media={_:"messageMediaUnsupportedWeb"}}if(e.action){const t=e.action;let s,n;const d=e.fromId===O.a.getSelf().id?"You":"";switch(t.photo&&(t.photo=k.a.savePhoto(t.photo,p)),t.document&&(t.document=E.a.saveDoc(t.photo,p)),t._){case"messageActionChatEditPhoto":(null===(a=t.photo)||void 0===a?void 0:a.video_sizes)?t._=r?"messageActionChannelEditVideo":"messageActionChatEditVideo":r&&(t._="messageActionChannelEditPhoto");break;case"messageActionGroupCall":{let s;void 0===t.duration?(s="started",i!==e.fromId&&(s+="_by"+d)):s="ended_by"+d,t.type=s;break}case"messageActionChatEditTitle":r&&(t._="messageActionChannelEditTitle");break;case"messageActionChatDeletePhoto":r&&(t._="messageActionChannelDeletePhoto");break;case"messageActionChatAddUser":1===t.users.length?(t.user_id=t.users[0],e.fromId===t.user_id&&(t._=o?"messageActionChatJoined"+d:"messageActionChatReturn"+d)):t.users.length>1&&(t._="messageActionChatAddUsers");break;case"messageActionChatDeleteUser":e.fromId===t.user_id&&(t._="messageActionChatLeave"+d);break;case"messageActionChannelMigrateFrom":s=t.chat_id.toPeerId(!0),n=i;break;case"messageActionChatMigrateTo":s=i,n=t.channel_id.toPeerId(!0);break;case"messageActionHistoryClear":e.clear_history=!0,delete e.pFlags.out,delete e.pFlags.unread;break;case"messageActionPhoneCall":t.type=(e.pFlags.out?"out_":"in_")+("phoneCallDiscardReasonMissed"===t.reason._||"phoneCallDiscardReasonBusy"===t.reason._?"missed":"ok")}s&&n&&!this.migratedFromTo[s]&&!this.migratedToFrom[n]&&this.migrateChecks(s,n)}e.message&&e.message.length&&!e.totalEntities&&this.wrapMessageEntities(e),n.set(d,e)}saveMessages(e,t={}){e.saved||(e.saved=!0,e.forEach(e=>{this.saveMessage(e,t)}))}wrapMessageEntities(e){const t=e.entities?e.entities.slice():[];e.message=m.a.fixEmoji(e.message,t);const s=m.a.parseEntities(e.message);e.totalEntities=m.a.mergeEntities(t,s)}wrapMessageForReply(e,t=e.message,s,a,i,n){const o=[],r=(e,t,s)=>{if(e&&(t=a?c.default.format(e,!0):Object(c.i18n)(e)),a)o.push(t);else{const e=document.createElement("i");"string"==typeof t?e.innerHTML=t:e.append(t),o.push(e)}s&&o.push(", ")};if(e.media){Object(Y.a)(e);let i=!0;if(e.grouped_id){if(s){const t=this.getMidsByMessage(e);if(s.length===t.length){for(const e of t)if(!s.includes(e)){i=!1;break}}else i=!1}i&&(t=this.getAlbumText(e.grouped_id).message,n||r("AttachAlbum",void 0,t))}else i=!1;if(!i&&!n){const s=e.media;switch(s._){case"messageMediaPhoto":r("AttachPhoto",void 0,e.message);break;case"messageMediaDice":r(void 0,a?s.emoticon:m.a.wrapEmojiText(s.emoticon));break;case"messageMediaVenue":{const e=a?s.title:m.a.wrapEmojiText(s.title);r("AttachLocation",void 0,e),o.push(Object(q.a)(e));break}case"messageMediaGeo":r("AttachLocation");break;case"messageMediaGeoLive":r("AttachLiveLocation");break;case"messageMediaPoll":r(void 0,a?"ðŸ“Š "+(s.poll.question||"poll"):s.poll.rReply);break;case"messageMediaContact":r("AttachContact");break;case"messageMediaGame":{const e="ðŸŽ® ";r(void 0,a?e+s.game.title:m.a.wrapEmojiText(e+s.game.title));break}case"messageMediaDocument":{const i=s.document;if("video"===i.type)r("AttachVideo",void 0,e.message);else if("voice"===i.type)r("AttachAudio",void 0,e.message);else if("gif"===i.type)r("AttachGif",void 0,e.message);else if("round"===i.type)r("AttachRound",void 0,e.message);else if("sticker"===i.type)i.stickerEmojiRaw&&r(void 0,(a?i.stickerEmojiRaw:i.stickerEmoji)+" "),r("AttachSticker"),t="";else if("audio"===i.type){const t=i.attributes.find(e=>"documentAttributeAudio"===e._&&(e.title||e.performer)),s="ðŸŽµ "+(t?[t.title,t.performer].filter(Boolean).join(" - "):i.file_name);r(void 0,a?s:m.a.wrapEmojiText(s),e.message)}else r(void 0,a?i.file_name:m.a.wrapEmojiText(i.file_name),e.message);break}}}}if(e.action){const t=this.wrapMessageActionTextNew(e,a);t&&r(void 0,t)}if(t)if(t=Object(h.f)(t,100),a)o.push(t);else{let e=m.a.parseEntities(t.replace(/\n/g," "));if(i){i=i.trim(),e||(e=[]);let s,a=!1,n=new RegExp(Object(h.e)(i),"gi");for(;null!==(s=n.exec(t));)e.push({_:"messageEntityHighlight",length:i.length,offset:s.index}),a=!0;a&&e.sort((e,t)=>e.offset-t.offset)}const s=m.a.wrapRichText(t,{noLinebreaks:!0,entities:e,noLinks:!0,noTextFormat:!0});o.push(Object(q.a)(s))}if(a)return o.join("");{const e=document.createDocumentFragment();return e.append(...o),e}}wrapSenderToPeer(e){const t=document.createElement("span");t.classList.add("sender-title");const s=e.fromId===_.default.myId&&e.peerId!==_.default.myId;if(t.append(s?Object(c.i18n)("FromYou"):new z.a({peerId:e.fromId,dialog:e.peerId===_.default.myId}).element),F.a.isAnyGroup(e.peerId)||s){const s=new z.a({peerId:e.peerId}).element;t.append(" âž ",s)}return t}wrapSentTime(e){const t=document.createElement("span");return t.classList.add("sent-time"),t.append(Object(o.c)(new Date(1e3*e.date))),t}wrapMessageActionTextNew(e,t){const s=t?void 0:document.createElement("span"),a="action"in e&&e.action;if(a.message){const e=a.message;return t?m.a.wrapPlainText(e):(s.innerHTML=m.a.wrapRichText(e,{noLinebreaks:!0}),s)}{let i,n,r=a._;const d=(e,t)=>t?F.a.getPeerTitle(e,t)+" ":new z.a({peerId:e}).element;switch(a._){case"messageActionPhoneCall":r+="."+a.type,n=[G(a.duration)];break;case"messageActionGroupCall":r+="."+a.type,n=[],r.endsWith("You")||n.push(d(e.fromId,t)),n.push(G(a.duration));break;case"messageActionInviteToGroupCall":{const s=[e.fromId,a.users[0].toPeerId()];let o="ActionGroupCall";const r=O.a.getSelf().id;s[0]===r&&(o+="You"),o+="Invited",s[1]===r&&(o+="You"),Object(M.e)(s,r),i=o,n=s.map(e=>d(e,t));break}case"messageActionGroupCallScheduled":{const s=new Date,r=new Date(1e3*a.schedule_date),l=(r.getTime()-s.getTime())/864e5,h=new Date(s);h.setDate(h.getDate()+1);const g=F.a.isBroadcast(e.peerId);i=g?"ChatList.Service.VoiceChatScheduled.Channel":"ChatList.Service.VoiceChatScheduled",n=[];const p=O.a.getSelf().id;e.fromId===p?i+="You":g||n.push(d(e.fromId,t));let u,f=[];l<1&&r.getDate()===s.getDate()?u="TodayAtFormattedWithToday":l<2&&r.getDate()===h.getDate()?u="Time.TomorrowAt":(u="formatDateAtTime",f.push(new c.default.IntlDateElement({date:r,options:{day:"2-digit",month:"2-digit",year:"2-digit"}}).element)),f.push(Object(o.e)(r));const m=Object(c.i18n)(u,f);n.push(m);break}case"messageActionChatCreate":{const s=O.a.getSelf().id;e.fromId===s?r+="You":n=[d(e.fromId,t)];break}case"messageActionPinMessage":{const s=e.peerId,a=this.getMessageByPeer(s,e.reply_to_mid);if(n=[d(e.fromId,t)],a.deleted)i="ActionPinnedNoText",e.reply_to_mid&&this.fetchMessageReplyTo(e).then(t=>{t.deleted||e.deleted||(_.default.dispatchEvent("message_edit",{storage:this.getMessagesStorage(s),peerId:s,mid:e.mid}),this.isMessageIsTopMessage(e)&&_.default.dispatchEvent("dialogs_multiupdate",{[s]:this.getDialogOnly(s)}))});else{const e=document.createElement("i");e.dataset.savedFrom=a.peerId+"_"+a.mid,e.dir="auto",e.append(this.wrapMessageForReply(a,void 0,void 0,t)),n.push(e)}break}case"messageActionContactSignUp":case"messageActionChatReturn":case"messageActionChatLeave":case"messageActionChatJoined":case"messageActionChatEditPhoto":case"messageActionChatDeletePhoto":case"messageActionChatEditVideo":case"messageActionChatJoinedByLink":case"messageActionChannelEditVideo":case"messageActionChannelDeletePhoto":n=[d(e.fromId,t)];break;case"messageActionChannelEditTitle":case"messageActionChatEditTitle":n=[],"messageActionChatEditTitle"===a._&&n.push(d(e.fromId,t)),n.push(t?a.title:Object(W.a)(m.a.wrapEmojiText(a.title)));break;case"messageActionChatDeleteUser":case"messageActionChatAddUsers":case"messageActionChatAddUser":{const s=a.users||[a.user_id];if(n=[d(e.fromId,t)],s.length>1)if(t)n.push(...s.map(e=>d(e.toPeerId(),!0).trim()).join(", "));else{const e=document.createElement("span");e.append(...Object(c.join)(s.map(e=>d(e.toPeerId(),!1)),!1)),n.push(e)}else n.push(d(s[0].toPeerId(),t));break}case"messageActionBotAllowed":{const e=m.a.wrapRichText(a.domain,{entities:[{_:"messageEntityUrl",length:a.domain.length,offset:0}]});n=[Object(W.a)(e)];break}default:i=c.langPack[r]||`[${a._}]`}return i||(i=c.langPack[r],void 0===i&&(i="["+r+"]")),t?c.default.format(i,!0,n):Object(c._i18n)(s,i,n)}}reportMessages(e,t,s,a){return p.a.invokeApiSingle("messages.report",{peer:F.a.getInputPeerById(e),id:t.map(e=>Z.a.getServerMessageId(e)),reason:{_:s},message:a})}startBot(e,t,s){const a=t?t.toPeerId(!0):e.toPeerId();if(s){const t=Object(l.b)();return p.a.invokeApi("messages.startBot",{bot:O.a.getUserInput(e),peer:F.a.getInputPeerById(a),random_id:t,start_param:s}).then(e=>{D.a.processUpdateMessage(e)})}if(t){let s;return s=U.a.isChannel(t)?U.a.inviteToChannel(t,[e]):U.a.addChatUser(t,e,0),s.catch(e=>{if(!e||"USER_ALREADY_PARTICIPANT"!=e.type)throw e;e.handled=!0}).then(()=>{const t=O.a.getUser(e);return this.sendText(a,"/start@"+t.username)})}return this.sendText(a,"/start")}editPeerFolders(e,t){p.a.invokeApi("folders.editPeerFolders",{folder_peers:e.map(e=>({_:"inputFolderPeer",peer:F.a.getInputPeerById(e),folder_id:t}))}).then(e=>{D.a.processUpdateMessage(e)})}toggleDialogPin(e,t){var s;if(t>1)return this.filtersStorage.toggleDialogPin(e,t);const a=this.getDialogOnly(e);if(!a)return Promise.reject();const i=!(null===(s=a.pFlags)||void 0===s?void 0:s.pinned)||void 0;if(i){const e=1===t?_.default.config.pinned_infolder_count_max:_.default.config.pinned_dialogs_count_max;if(this.dialogsStorage.getPinnedOrders(t).length>=e)return Promise.reject({type:"PINNED_DIALOGS_TOO_MUCH"})}return p.a.invokeApi("messages.toggleDialogPin",{peer:F.a.getInputDialogPeerById(e),pinned:i}).then(s=>{if(s){const s=i?{pinned:i}:{};D.a.saveUpdate({_:"updateDialogPinned",peer:F.a.getDialogPeer(e),folder_id:t,pFlags:s})}})}markDialogUnread(e,t){var s;const a=this.getDialogOnly(e);if(!a)return Promise.reject();const i=!t&&!(null===(s=a.pFlags)||void 0===s?void 0:s.unread_mark)||void 0;return p.a.invokeApi("messages.markDialogUnread",{peer:F.a.getInputDialogPeerById(e),unread:i}).then(t=>{if(t){const t=i?{unread:i}:{};this.onUpdateDialogUnreadMark({_:"updateDialogUnreadMark",peer:F.a.getDialogPeer(e),pFlags:t})}})}migrateChecks(e,t){if(!this.migratedFromTo[e]&&!this.migratedToFrom[t]&&U.a.hasChat(t.toChatId())){const s=U.a.getChat(e.toChatId());if(s&&s.migrated_to&&s.migrated_to.channel_id===t.toChatId()){this.migratedFromTo[e]=t,this.migratedToFrom[t]=e,_.default.dispatchEvent("dialog_migrate",{migrateFrom:e,migrateTo:t});const s=this.dialogsStorage.dropDialog(e);s.length&&_.default.dispatchEvent("dialog_drop",{peerId:e,dialog:s[0]})}}}canMessageBeEdited(e,t){if(e.pFlags.is_outgoing)return!1;const s=["messageMediaPhoto","messageMediaDocument","messageMediaWebPage"];return"poll"===t&&s.push("messageMediaPoll"),!("message"!==e._||e.deleted||e.fwd_from||e.via_bot_id||e.media&&-1===s.indexOf(e.media._)||e.fromId&&O.a.isBot(e.fromId))&&(!e.media||"messageMediaDocument"!==e.media._||!e.media.document.sticker&&"round"!==e.media.document.type)}canEditMessage(e,t="text"){var s;return!(!e||!this.canMessageBeEdited(e,t))&&(this.getMessagePeer(e)===O.a.getSelf().id||!(e.date<Object(o.g)(!0)-_.default.config.edit_time_limit&&"messageMediaPoll"!==(null===(s=e.media)||void 0===s?void 0:s._)||!e.pFlags.out))}canDeleteMessage(e){return e&&(e.peerId.isUser()||e.fromId===_.default.myId||"chat"===U.a.getChat(e.peerId.toChatId())._||U.a.hasRights(e.peerId.toChatId(),"delete_messages"))&&!e.pFlags.is_outgoing}getReplyKeyboard(e){return this.getHistoryStorage(e).replyMarkup}mergeReplyKeyboard(e,t){var s,a;let i=t.reply_markup;if(!i&&!(null===(s=t.pFlags)||void 0===s?void 0:s.out)&&!t.action)return!1;if("replyInlineMarkup"===(null==i?void 0:i._))return!1;const n=e.replyMarkup;if(i)return!(n&&n.mid>=t.mid)&&(!i.pFlags.selective&&(e.maxOutId&&t.mid<e.maxOutId&&i.pFlags.single_use&&(i.pFlags.hidden=!0),i.mid=t.mid,"replyKeyboardHide"!==i._&&(i.fromId=F.a.getPeerId(t.from_id)),e.replyMarkup=i,!0));if(t.pFlags.out)if(n){if(Object(Y.a)(n),n.pFlags.single_use&&!n.pFlags.hidden&&(t.mid>n.mid||t.pFlags.is_outgoing)&&t.message)return n.pFlags.hidden=!0,!0}else(!e.maxOutId||t.mid>e.maxOutId)&&(e.maxOutId=t.mid);return Object(Y.a)(t),!("messageActionChatDeleteUser"!==(null===(a=t.action)||void 0===a?void 0:a._)||!(n?t.action.user_id===n.fromId:O.a.isBot(t.action.user_id)))&&(e.replyMarkup={_:"replyKeyboardHide",mid:t.mid,pFlags:{}},!0)}getSearchStorage(e,t){return this.searchesStorage[e]||(this.searchesStorage[e]={}),this.searchesStorage[e][t]||(this.searchesStorage[e][t]={history:[]}),this.searchesStorage[e][t]}getSearchCounters(e,t,s=!0){return(s?p.a.invokeApiCacheable:p.a.invokeApi).bind(p.a)("messages.getSearchCounters",{peer:F.a.getInputPeerById(e),filters:t})}filterMessagesByInputFilter(e,t,s,a){const i=[];if(!t.length)return i;let n=!0;const o={},r=[],d=[];switch(e){case"inputMessagesFilterPhotos":o.messageMediaPhoto=!0;break;case"inputMessagesFilterPhotoVideo":o.messageMediaPhoto=!0,o.messageMediaDocument=!0,r.push("video");break;case"inputMessagesFilterVideo":o.messageMediaDocument=!0,r.push("video");break;case"inputMessagesFilterDocument":o.messageMediaDocument=!0,d.push("video");break;case"inputMessagesFilterVoice":o.messageMediaDocument=!0,r.push("voice");break;case"inputMessagesFilterRoundVoice":o.messageMediaDocument=!0,r.push("round","voice");break;case"inputMessagesFilterRoundVideo":o.messageMediaDocument=!0,r.push("round");break;case"inputMessagesFilterMusic":o.messageMediaDocument=!0,r.push("audio");break;case"inputMessagesFilterUrl":o.url=!0;break;case"inputMessagesFilterChatPhotos":o.avatar=!0;break;default:n=!1}if(!n)return i;for(let e=0,n=t.length;e<n;++e){const n=s.get(t[e]);if(!n)continue;let l=!1;if("message"===n._){if(n.media&&o[n.media._]){const e=n.media.document;if(e&&(r.length&&!r.includes(e.type)||d.includes(e.type)))continue;l=!0}else if(o.url&&n.message){const e=["messageEntityTextUrl","messageEntityUrl"];(n.totalEntities.find(t=>e.includes(t._))||m.a.matchUrl(n.message))&&(l=!0)}}else o.avatar&&n.action&&["messageActionChannelEditPhoto","messageActionChatEditPhoto","messageActionChannelEditVideo","messageActionChatEditVideo"].includes(n.action._)&&(l=!0);if(l&&(i.push(n),i.length>=a))break}return i}getSearch({peerId:e,query:t,inputFilter:s,maxId:a,limit:i,nextRate:n,backLimit:o,threadId:r,folderId:d,minDate:l,maxDate:h}){t||(t=""),s||(s={_:"inputMessagesFilterEmpty"}),void 0===i&&(i=20),n||(n=0),o||(o=0),l=l?l/1e3|0:0,h=h?h/1e3|0:0;let c=[];o&&(i+=o);let g;if(!e||o||a||t||1===i||r||(g=this.getHistoryStorage(e),c=this.filterMessagesByInputFilter(s._,g.history.slice,this.getMessagesStorage(e),i)),c.length){if(!(c.length<i))return Promise.resolve({count:0,next_rate:0,offset_id_offset:0,history:c});a=c[c.length-1].mid,i-=c.length}else 0;const u=p.a.invokeApi.bind(p.a);let f;if(e&&!n&&void 0===d)f=u("messages.search",{peer:F.a.getInputPeerById(e),q:t||"",filter:s,min_date:l,max_date:h,limit:i,offset_id:Z.a.getServerMessageId(a)||0,add_offset:o?-o:0,max_id:0,min_id:0,hash:"",top_msg_id:Z.a.getServerMessageId(r)||0},{noErrorBox:!0});else{let o,r=0,c=a&&this.getMessageByPeer(e,a);c&&c.date&&(r=c.id,o=this.getMessagePeer(c)),f=u("messages.searchGlobal",{q:t,filter:s,min_date:l,max_date:h,offset_rate:n,offset_peer:F.a.getInputPeerById(o),offset_id:r,limit:i,folder_id:d},{noErrorBox:!0})}return f.then(e=>{O.a.saveApiUsers(e.users),U.a.saveApiChats(e.chats),this.saveMessages(e.messages),N.b&&this.log("getSearch result:",s,e);const t=e.count||c.length+e.messages.length;return e.messages.forEach(e=>{const t=this.getMessagePeer(e);if(t.isAnyChat()){const e=U.a.getChat(t.toChatId());e.migrated_to&&this.migrateChecks(t,e.migrated_to.channel_id.toPeerId(!0))}c.push(e)}),{count:t,offset_id_offset:e.offset_id_offset||0,next_rate:e.next_rate,history:c}})}subscribeRepliesThread(e,t){const s=e+"_"+t;for(const e in this.threadsToReplies)if(this.threadsToReplies[e]===s)return;this.getDiscussionMessage(e,t)}generateThreadServiceStartMessage(e){const t=e.peerId+"_"+e.mid;if(this.threadsServiceMessagesIdsStorage[t])return;const s=Z.a.getServerMessageId(Math.max(...this.getMidsByMessage(e))),a={_:"messageService",pFlags:{is_single:!0},id:Z.a.generateMessageId(s,!0),date:e.date,from_id:{_:"peerUser",user_id:y.b},peer_id:e.peer_id,action:{_:"messageActionDiscussionStarted"},reply_to:this.generateReplyHeader(e.id)};this.saveMessages([a],{isOutgoing:!0}),this.threadsServiceMessagesIdsStorage[t]=a.mid}getDiscussionMessage(e,t){return p.a.invokeApiSingle("messages.getDiscussionMessage",{peer:F.a.getInputPeerById(e),msg_id:Z.a.getServerMessageId(t)}).then(s=>{var a;U.a.saveApiChats(s.chats),O.a.saveApiUsers(s.users),this.saveMessages(s.messages);const i=this.filterMessages(s.messages[0],e=>!!e.replies)[0],n=i.peerId+"_"+i.mid;this.generateThreadServiceStartMessage(i);const o=this.getHistoryStorage(i.peerId,i.mid);return s.max_id=o.maxId=Z.a.generateMessageId(s.max_id)||0,s.read_inbox_max_id=o.readMaxId=Z.a.generateMessageId(null!==(a=s.read_inbox_max_id)&&void 0!==a?a:i.mid),s.read_outbox_max_id=o.readOutboxMaxId=Z.a.generateMessageId(s.read_outbox_max_id)||0,this.threadsToReplies[n]=e+"_"+t,i})}handleNewMessage(e,t){void 0===this.newMessagesToHandle[e]&&(this.newMessagesToHandle[e]=new Set),this.newMessagesToHandle[e].add(t),this.newMessagesHandleTimeout||(this.newMessagesHandleTimeout=window.setTimeout(this.handleNewMessages,0))}scheduleHandleNewDialogs(e,t){return void 0!==e&&(this.newDialogsToHandle[e]=t),this.newDialogsHandlePromise?this.newDialogsHandlePromise:this.newDialogsHandlePromise=new Promise(e=>{setTimeout(()=>{e(),this.newDialogsHandlePromise=void 0,this.handleNewDialogs()},0)})}deleteMessages(e,t,s){var a,i;let n;const o=t.map(e=>Z.a.getServerMessageId(e));if(e.isAnyChat()&&F.a.isChannel(e)){const s=e.toChatId(),r=U.a.getChat(s);if(!r.pFlags.creator&&!(null===(i=null===(a=r.admin_rights)||void 0===a?void 0:a.pFlags)||void 0===i?void 0:i.delete_messages)&&!(t=t.filter(t=>!!this.getMessageByPeer(e,t).pFlags.out)).length)return;n=p.a.invokeApi("channels.deleteMessages",{channel:U.a.getChannelInput(s),id:o}).then(e=>{D.a.processLocalUpdate({_:"updateDeleteChannelMessages",channel_id:s,messages:t,pts:e.pts,pts_count:e.pts_count})})}else n=p.a.invokeApi("messages.deleteMessages",{revoke:s,id:o}).then(e=>{D.a.processLocalUpdate({_:"updateDeleteMessages",messages:t,pts:e.pts,pts_count:e.pts_count})});return n}readHistory(e,t=0,s,a=!1){if(this.log("readHistory:",e,t,s),!this.getReadMaxIdIfUnread(e,s)&&!a)return this.log("readHistory: isn't unread"),Promise.resolve();const i=this.getHistoryStorage(e,s);if(i.triedToReadMaxId>=t)return Promise.resolve();let n;return s?(i.readPromise||(n=p.a.invokeApi("messages.readDiscussion",{peer:F.a.getInputPeerById(e),msg_id:Z.a.getServerMessageId(s),read_max_id:Z.a.getServerMessageId(t)})),D.a.processLocalUpdate({_:"updateReadChannelDiscussionInbox",channel_id:e.toChatId(),top_msg_id:s,read_max_id:t})):F.a.isChannel(e)?(i.readPromise||(n=p.a.invokeApi("channels.readHistory",{channel:U.a.getChannelInput(e.toChatId()),max_id:Z.a.getServerMessageId(t)})),D.a.processLocalUpdate({_:"updateReadChannelInbox",max_id:t,channel_id:e.toChatId(),still_unread_count:void 0,pts:void 0})):(i.readPromise||(n=p.a.invokeApi("messages.readHistory",{peer:F.a.getInputPeerById(e),max_id:Z.a.getServerMessageId(t)}).then(e=>{D.a.processUpdateMessage({_:"updateShort",update:{_:"updatePts",pts:e.pts,pts_count:e.pts_count}})})),D.a.processLocalUpdate({_:"updateReadHistoryInbox",max_id:t,peer:F.a.getOutputPeer(e),still_unread_count:void 0,pts:void 0,pts_count:void 0})),H.a.soundReset(F.a.getPeerString(e)),i.readPromise?i.readPromise:(i.triedToReadMaxId=t,n.finally(()=>{delete i.readPromise;const{readMaxId:a}=i;this.log("readHistory: promise finally",t,a),a>t&&this.readHistory(e,a,s,!0)}),i.readPromise=n)}readAllHistory(e,t,s=!1){const a=this.getHistoryStorage(e,t);a.maxId&&this.readHistory(e,a.maxId,t,s)}fixDialogUnreadMentionsIfNoMessage(e){const t=this.getDialogOnly(e);(null==t?void 0:t.unread_mentions_count)&&this.reloadConversation(e)}modifyCachedMentions(e,t,s){const a=this.unreadMentions[e];a&&(s?a.first.isEnd(I.a.Top)&&a.insertSlice([t]):a.delete(t))}goToNextMention(e){var t;const s=this.goToNextMentionPromises[e];if(s)return s;const a=null!==(t=this.unreadMentions[e])&&void 0!==t?t:this.unreadMentions[e]=new I.b,i=a.length,n=a.first.isEnd(I.a.Top);if(!i&&n)return Promise.resolve();let o=Promise.resolve();return!n&&i<25&&(o=this.loadNextMentions(e)),this.goToNextMentionPromises[e]=o.then(()=>{const t=a.last,s=t&&t[t.length-1];s&&(a.delete(s),_.default.dispatchEvent("history_focus",{peerId:e,mid:s}))}).finally(()=>{delete this.goToNextMentionPromises[e]})}loadNextMentions(e){const t=this.unreadMentions[e],s=t.first[0]||1;return this.getUnreadMentions(e,s,-50,50).then(e=>{this.mergeHistoryResult(t,e,1===s?0:s,50,-50)})}getUnreadMentions(e,t,s,a,i=0,n=0){return p.a.invokeApiSingle("messages.getUnreadMentions",{peer:F.a.getInputPeerById(e),offset_id:Z.a.getServerMessageId(t),add_offset:s,limit:a,max_id:Z.a.getServerMessageId(i),min_id:Z.a.getServerMessageId(n)}).then(e=>(Object(Y.a)(e),O.a.saveApiUsers(e.users),U.a.saveApiChats(e.chats),this.saveMessages(e.messages),e))}readMessages(e,t){if(!t.length)return Promise.resolve();let s,a;if(t=t.map(e=>Z.a.getServerMessageId(e)),e.isAnyChat()&&F.a.isChannel(e)){const i=e.toChatId();a={_:"updateChannelReadMessagesContents",channel_id:i,messages:t},s=p.a.invokeApi("channels.readMessageContents",{channel:U.a.getChannelInput(i),id:t})}else a={_:"updateReadMessagesContents",messages:t,pts:void 0,pts_count:void 0},s=p.a.invokeApi("messages.readMessageContents",{id:t}).then(e=>{a.pts=e.pts,a.pts_count=e.pts_count,D.a.processLocalUpdate(a)});return D.a.processLocalUpdate(a),s}getHistoryStorage(e,t){var s,a;return t?(this.threadsStorage[e]||(this.threadsStorage[e]={}),null!==(s=this.threadsStorage[e][t])&&void 0!==s?s:this.threadsStorage[e][t]={count:null,history:new I.b}):null!==(a=this.historiesStorage[e])&&void 0!==a?a:this.historiesStorage[e]={count:null,history:new I.b}}setDialogToStateIfMessageIsTop(e){this.isMessageIsTopMessage(e)&&this.dialogsStorage.setDialogToState(this.getDialogOnly(e.peerId))}isMessageIsTopMessage(e){const t=this.getDialogOnly(e.peerId);return t&&t.top_message===e.mid}updateMessageRepliesIfNeeded(e){try{const t=this.getThreadKey(e);if(t){const e=this.threadsToReplies[t];if(e){const[t,s]=e.split("_");this.updateMessage(t.toPeerId(),+s,"replies_updated")}}}catch(t){this.log.error("incrementMessageReplies err",t,e)}}getThreadKey(e){var t;let s="";if((null===(t=e.peerId)||void 0===t?void 0:t.isAnyChat())&&e.reply_to){const t=e.reply_to.reply_to_top_id||e.reply_to.reply_to_msg_id;s=e.peerId+"_"+t}return s}updateMessage(e,t,s){return this.wrapSingleMessage(e,t,!0).then(()=>{const a=this.getMessageByPeer(e,t);return s&&_.default.dispatchEvent(s,a),a})}checkPendingMessage(e){const t=this.pendingByMessageId[e.mid];let s;if(t){const a=this.pendingByRandomId[t];(s=this.finalizePendingMessage(t,e))&&_.default.dispatchEvent("history_update",{storage:a.storage,peerId:e.peerId,mid:e.mid}),delete this.pendingByMessageId[e.mid]}return s}mutePeer(e,t){const s={_:"inputPeerNotifySettings"};return void 0===t&&(t=!H.a.isPeerLocalMuted(e,!1)),s.mute_until=t?y.a:0,H.a.updateNotifySettings({_:"inputNotifyPeer",peer:F.a.getInputPeerById(e)},s)}canSendToPeer(e,t,s="send_messages"){if(e.isAnyChat()){const a=U.a.getChat(e.toChatId());return U.a.hasRights(e.toChatId(),s,void 0,!!t)&&(!a.pFlags.left||!!t)}return O.a.canSendToUser(e)}finalizePendingMessage(e,t){const s=this.pendingByRandomId[e];if(s){const{peerId:a,tempId:i,threadId:n,storage:o}=s;[this.getHistoryStorage(a),n?this.getHistoryStorage(a,n):void 0].filter(Boolean).forEach(e=>{e.history.delete(i)});const r=this.getMessageFromStorage(o,i);return r.deleted||(delete t.pFlags.is_outgoing,delete t.pending,delete t.error,delete t.random_id,delete t.send),_.default.dispatchEvent("messages_pending"),delete this.pendingByRandomId[e],this.finalizePendingMessageCallbacks(o,i,t),r}}finalizePendingMessageCallbacks(e,t,s){const a=this.tempFinalizeCallbacks[t];if(void 0!==a){for(const e in a){const{deferred:t,callback:i}=a[e];i(s).then(t.resolve,t.reject)}delete this.tempFinalizeCallbacks[t]}if(s.media){Object(Y.a)(s);const{photo:e,document:a}=s.media;if(e){const s=k.a.getPhoto(""+t);if(s){const t=e.sizes[e.sizes.length-1],a=A.a.getCacheContext(e,t.type),i=A.a.getCacheContext(s,"full");Object.assign(a,i);const n=e.sizes[e.sizes.length-1],o=k.a.getPhotoDownloadOptions(e,n),r=Object(R.a)(o.location);A.a.fakeDownload(r,i.url)}}else if(a){const e=E.a.getDoc(""+t);if(e&&e.type&&"sticker"!==e.type&&"image/gif"!==e.mime_type){const t=A.a.getCacheContext(a),s=A.a.getCacheContext(e);Object.assign(t,s);const i=E.a.getInputFileName(a);A.a.fakeDownload(i,s.url)}}else s.media.poll&&(delete x.a.polls[t],delete x.a.results[t])}const i=this.getMessageFromStorage(e,t);e.delete(t),this.handleReleasingMessage(i,e),_.default.dispatchEvent("message_sent",{storage:e,tempId:t,tempMessage:i,mid:s.mid,message:s})}incrementMaxSeenId(e){if(!e||this.maxSeenId&&!(e>this.maxSeenId))return!1;this.maxSeenId=e,T.default.pushToState("maxSeenMsgId",e),p.a.invokeApi("messages.receivedMessages",{max_id:Z.a.getServerMessageId(e)})}incrementMessageViews(e,t){if(t.length)return p.a.invokeApiSingle("messages.getMessagesViews",{peer:F.a.getInputPeerById(e),id:t.map(e=>Z.a.getServerMessageId(e)),increment:!0}).then(s=>{const a=new Array(t.length),i=e.toChatId();for(let e=0,n=t.length;e<n;++e)a[e]={_:"updateChannelMessageViews",channel_id:i,id:t[e],views:s.views[e].views};D.a.processUpdateMessage({_:"updates",updates:a,chats:s.chats,users:s.users})})}notifyAboutMessage(e,t={}){const s=this.getMessagePeer(e),a={},i=F.a.getPeerString(s);let n;n=t.peerTypeNotifySettings.show_previews?"message"===e._&&e.fwd_from&&t.fwdCount?c.default.format("Notifications.Forwarded",!0,[t.fwdCount]):this.wrapMessageForReply(e,void 0,void 0,!0):c.default.format("Notifications.New",!0),a.title=F.a.getPeerTitle(s,!0),s.isAnyChat()&&e.fromId!==e.peerId&&(a.title=F.a.getPeerTitle(e.fromId,!0)+" @ "+a.title),a.title=m.a.wrapPlainText(a.title),a.onclick=()=>{_.default.dispatchEvent("history_focus",{peerId:s,mid:e.mid})},a.message=n,a.key="msg"+e.mid,a.tag=i,a.silent=!0;const o=F.a.getPeerPhoto(s);o?K.a.loadAvatar(s,o,"photo_small").loadPromise.then(t=>{e.pFlags.unread&&(a.image=t,H.a.notify(a))}):H.a.notify(a)}getScheduledMessagesStorage(e){var t;return null!==(t=this.scheduledMessagesStorage[e])&&void 0!==t?t:this.scheduledMessagesStorage[e]=this.createMessageStorage()}getScheduledMessageByPeer(e,t){return this.getMessageFromStorage(this.getScheduledMessagesStorage(e),t)}getScheduledMessages(e){if(!this.canSendToPeer(e))return Promise.resolve([]);const t=this.getScheduledMessagesStorage(e);return t.size?Promise.resolve([...t.keys()]):p.a.invokeApiSingle("messages.getScheduledHistory",{peer:F.a.getInputPeerById(e),hash:""}).then(t=>{if("messages.messagesNotModified"!==t._){O.a.saveApiUsers(t.users),U.a.saveApiChats(t.chats);const s=this.getScheduledMessagesStorage(e);return this.saveMessages(t.messages,{storage:s,isScheduled:!0}),[...s.keys()]}return[]})}sendScheduledMessages(e,t){return p.a.invokeApi("messages.sendScheduledMessages",{peer:F.a.getInputPeerById(e),id:t.map(e=>Z.a.getServerMessageId(e))}).then(e=>{D.a.processUpdateMessage(e)})}deleteScheduledMessages(e,t){return p.a.invokeApi("messages.deleteScheduledMessages",{peer:F.a.getInputPeerById(e),id:t.map(e=>Z.a.getServerMessageId(e))}).then(e=>{D.a.processUpdateMessage(e)})}getMessageWithReplies(e){if(e.peerId===y.c||(e=this.filterMessages(e,e=>!!e.replies)[0])&&e.replies&&e.replies.pFlags.comments&&"777"!==e.replies.channel_id)return e}isFetchIntervalNeeded(e){return e.isAnyChat()&&!U.a.isInChat(e.toChatId())}getNewHistory(e,t){var s;return ee(this,void 0,void 0,(function*(){if(!this.isFetchIntervalNeeded(e))return;const a=this.getHistoryStorage(e,t),i=a.history.slice;if(!i.isEnd(I.a.Bottom))return;delete a.maxId,i.unsetEnd(I.a.Bottom);let n=this.getHistory(e,null!==(s=i[0])&&void 0!==s?s:1,0,50,t);n instanceof Promise&&(n=yield n);for(let t=0,s=n.history.length;t<s;++t)this.handleNewMessage(e,n.history[t]);return a}))}getHistory(e,t=0,s,a,i){const n=this.getHistoryStorage(e,i);let o=0;a&&(o=-a,s+=a);const r=n.history.sliceMe(t,o,s);return!r||r.slice.length!==s&&(r.fulfilled&I.a.Both)!==I.a.Both?this.fillHistoryStorage(e,t,s,o,n,i).then(()=>{const e=n.history.sliceMe(t,o,s);return{count:n.count,history:(null==e?void 0:e.slice)||n.history.constructSlice(),offsetIdOffset:(null==e?void 0:e.offsetIdOffset)||n.count}}):{count:n.count,history:r.slice,offsetIdOffset:r.offsetIdOffset}}isHistoryResultEnd(e,t,s){const{offset_id_offset:a,messages:i}=e,n=e.count||i.length,o=a||0,r=s<0?t+s:t;return{count:n,offsetIdOffset:o,isTopEnd:o>=n-r||n<r,isBottomEnd:!o||s<0&&o+s<=0}}mergeHistoryResult(e,t,s,a,i){const{messages:n}=t,o=this.isHistoryResultEnd(t,a,i),{count:r,offsetIdOffset:d,isTopEnd:l,isBottomEnd:h}=o,c=n.map(e=>e.mid);if(s&&!c.includes(s)&&d<r){let e=0;for(const t=c.length;e<t&&!(s>c[e]);++e);c.splice(e,0,s)}const g=e.insertSlice(c)||e.slice;return l&&g.setEnd(I.a.Top),h&&g.setEnd(I.a.Bottom),Object.assign({slice:g,mids:c,messages:n},o)}fillHistoryStorage(e,t,s,a,i,n){return this.requestHistory(e,t,s,a,void 0,n).then(n=>{const{count:o,isBottomEnd:r,slice:d,messages:l}=this.mergeHistoryResult(i.history,n,t,s,a);i.count=o;for(let t=0,s=l.length;t<s;++t){const s=l[t];this.mergeReplyKeyboard(i,s)&&_.default.dispatchEvent("history_reply_markup",{peerId:e})}r&&(i.maxId=d[0])})}requestHistory(e,t,s=0,a=0,i=0,n=0){const o={peer:F.a.getInputPeerById(e),offset_id:Z.a.getServerMessageId(t)||0,offset_date:i,add_offset:a,limit:s,max_id:0,min_id:0,hash:0};n&&(o.msg_id=Z.a.getServerMessageId(n)||0);return p.a.invokeApiSingle(n?"messages.getReplies":"messages.getHistory",o,{noErrorBox:!0}).then(o=>{N.b&&this.log("requestHistory result:",e,o,t,s,a),O.a.saveApiUsers(o.users),U.a.saveApiChats(o.chats),this.saveMessages(o.messages),F.a.isChannel(e)&&D.a.addChannelState(e.toChatId(),o.pts);let r=o.messages.length,d=o.count;r&&o.messages[r-1].deleted&&(o.messages.splice(r-1,1),r--,d--);const l=this.getHistoryStorage(e,n),h=o.messages[r-1];if(r&&h.grouped_id){const t=l.history.findSlice(h.mid);if(t&&t.slice.length+o.messages.length<d)return this.requestHistory(e,h.mid,10,0,i,n).then(e=>o)}return o},t=>{switch(t.type){case"CHANNEL_PRIVATE":let t=U.a.getChat(e.toChatId());t={_:"channelForbidden",access_hash:t.access_hash,title:t.title},D.a.processUpdateMessage({_:"updates",updates:[{_:"updateChannel",channel_id:e.toChatId()}],chats:[t],users:[]})}throw t})}fetchSingleMessages(){return this.fetchSingleMessagesPromise?this.fetchSingleMessagesPromise:this.fetchSingleMessagesPromise=new Promise(e=>{setTimeout(()=>{const t=[];for(const[e,s]of this.needSingleMessages){const a=[...s.keys()],i=a.map(e=>({_:"inputMessageID",id:Z.a.getServerMessageId(e)}));let n;n=e.isAnyChat()&&F.a.isChannel(e)?p.a.invokeApiSingle("channels.getMessages",{channel:U.a.getChannelInput(e.toChatId()),id:i}):p.a.invokeApiSingle("messages.getMessages",{id:i});const o=n.then(e=>{Object(Y.a)(e),O.a.saveApiUsers(e.users),U.a.saveApiChats(e.chats),this.saveMessages(e.messages);for(let t=0;t<e.messages.length;++t){const a=e.messages[t],i=Z.a.generateMessageId(a.id);s.get(i).resolve(e.messages[t]),s.delete(i)}if(s.size)for(const[e,t]of s)t.resolve(this.generateEmptyMessage(e))}).finally(()=>{_.default.dispatchEvent("messages_downloaded",{peerId:e,mids:a})});t.push(o)}this.needSingleMessages.clear(),Promise.all(t).finally(()=>{this.fetchSingleMessagesPromise=null,this.needSingleMessages.size&&this.fetchSingleMessages(),e()})},0)})}wrapSingleMessage(e,t,s=!1){const a=this.getMessageByPeer(e,t);if(a.deleted||s){let s=this.needSingleMessages.get(e);s||this.needSingleMessages.set(e,s=new Map);let a=s.get(t);return a||(a=Object(n.a)(),s.set(t,a),this.fetchSingleMessages(),a)}return _.default.dispatchEvent("messages_downloaded",{peerId:e,mids:[t]}),Promise.resolve(a)}fetchMessageReplyTo(e){if(!e.reply_to_mid)return Promise.resolve(this.generateEmptyMessage(0));const t=e.reply_to.reply_to_peer_id?F.a.getPeerId(e.reply_to.reply_to_peer_id):e.peerId;return this.wrapSingleMessage(t,e.reply_to_mid).then(t=>(t.deleted&&delete e.reply_to_mid,t))}setTyping(e,t){let s=this.typings[e];return _.default.myId&&e&&this.canSendToPeer(e)&&e!==_.default.myId&&(null==s?void 0:s.type)!==t._?((null==s?void 0:s.timeout)&&clearTimeout(s.timeout),s=this.typings[e]={type:t._},p.a.invokeApi("messages.setTyping",{peer:F.a.getInputPeerById(e),action:t}).finally(()=>{s===this.typings[e]&&(s.timeout=window.setTimeout(()=>{delete this.typings[e]},6e3))})):Promise.resolve(!1)}handleReleasingMessage(e,t){const s=e.media;if(s){const a=s.webpage||s,i=a.photo||a.document;if((null==i?void 0:i.file_reference)&&u.a.deleteContext(i.file_reference,{type:"message",peerId:e.peerId,messageId:e.mid}),"webpage"in s&&s.webpage){const a=this.getScheduledMessagesStorage(e.peerId)===t,i=L.a.getMessageKeyForPendingWebPage(e.peerId,e.mid,a);L.a.deleteWebPageFromPending(s.webpage,i)}s.poll&&x.a.updatePollToMessage(e,!1)}}handleDeletedMessages(e,t,s){const a={count:0,unread:0,unreadMentions:0,msgs:new Set};for(const i of s){const s=this.getMessageFromStorage(t,i);if(s.deleted){this.fixDialogUnreadMentionsIfNoMessage(e);continue}this.handleReleasingMessage(s,t),this.updateMessageRepliesIfNeeded(s),s.pFlags.out||s.pFlags.is_outgoing||!s.pFlags.unread||(++a.unread,H.a.cancel("msg"+i),s.pFlags.mentioned&&(++a.unreadMentions,this.modifyCachedMentions(e,i,!1))),++a.count,a.msgs.add(i),s.deleted=!0;const n=s.grouped_id;if(n){const e=this.groupedMessagesStorage[n];e&&(e.delete(i),a.albums||(a.albums={}),(a.albums[n]||(a.albums[n]=new Set)).add(i),e.size||(delete a.albums,delete this.groupedMessagesStorage[n]))}t.delete(i);const o=this.newMessagesToHandle[e];o&&o.has(i)&&o.delete(i)}if(a.albums)for(const t in a.albums)_.default.dispatchEvent("album_edit",{peerId:e,groupId:t,deletedMids:[...a.albums[t]]});return a}handleEditedMessage(e,t){var s;if("message"===e._&&(null===(s=e.media)||void 0===s?void 0:s.webpage)){const t=L.a.getMessageKeyForPendingWebPage(e.peerId,e.mid,!!e.pFlags.is_scheduled);L.a.deleteWebPageFromPending(e.media.webpage,t)}}getMediaFromMessage(e){return e.action?e.action.photo:e.media&&(e.media.photo||e.media.document||e.media.webpage&&(e.media.webpage.document||e.media.webpage.photo))}isMentionUnread(e){var t;const s=null===(t=e.media)||void 0===t?void 0:t.document;return e.pFlags.media_unread&&e.pFlags.mentioned&&(!s||!["voice","round"].includes(s.type))}getDialogUnreadCount(e){return e.unread_count||+!!e.pFlags.unread_mark}isDialogUnread(e){return!!this.getDialogUnreadCount(e)}};N.a.appMessagesManager=te;t.a=te},40:function(e,t,s){"use strict";var a=s(29),i=s(44),n=s(45),o=s(123);function r(e){return e&&e.toLowerCase()||""}var d=s(54),l=s(106),h=s(34),c=s(16),g=s(32),p=s(47),u=s(68),f=s(31),m=s(15),_=s(111),v=s(79),M=s(46),I=s(42),y=s(17);const P=new class{constructor(){this.storage=y.default.storages.users,this.updateUsersStatuses=()=>{const e=Object(d.g)(!0);for(const t in this.users){const s=this.users[t];this.updateUserStatus(s,e)}},this.clear(!0),setInterval(this.updateUsersStatuses,6e4),m.default.addEventListener("state_synchronized",this.updateUsersStatuses),m.default.addMultipleEventsListeners({updateUserStatus:e=>{const t=e.user_id,s=this.users[t];s&&(s.status=e.status,s.status&&("expires"in s.status&&(s.status.expires-=u.a.serverTimeOffset),"was_online"in s.status&&(s.status.was_online-=u.a.serverTimeOffset)),m.default.dispatchEvent("user_update",t),this.setUserToStateIfNeeded(s))},updateUserPhoto:e=>{const t=e.user_id,s=this.users[t];s?(this.forceUserOnline(t),"userProfilePhotoEmpty"===e.photo._?delete s.photo:s.photo=Object(h.i)(s.photo,e.photo),this.setUserToStateIfNeeded(s),m.default.dispatchEvent("user_update",t),m.default.dispatchEvent("avatar_update",t.toPeerId())):console.warn("No user by id:",t)},updateUserName:e=>{const t=e.user_id,s=this.users[t];s&&(this.forceUserOnline(t),this.saveApiUser(Object.assign({},s,{first_name:e.first_name,last_name:e.last_name,username:e.username}),!0))}}),m.default.addEventListener("language_change",e=>{const t=this.getSelf().id;this.contactsIndex.indexObject(t,this.getUserSearchText(t))}),y.default.getState().then(e=>{const t=y.default.storagesResults.users;if(t.length)for(let e=0,s=t.length;e<s;++e){const s=t[e];s&&(this.users[s.id]=s)}const s=e.contactsList;s&&Array.isArray(s)&&(s.forEach(e=>{this.pushContact(e)}),s.length&&(this.contactsFillPromise=Object(n.a)(),this.contactsFillPromise.resolve(this.contactsList))),y.default.addEventListener("peerNeeded",e=>{if(!I.a.isUser(e))return;const t=e.toUserId();this.storage.getFromCache(t)||this.storage.set({[t]:this.getUser(t)})}),y.default.addEventListener("peerUnneeded",e=>{if(!I.a.isUser(e))return;const t=e.toUserId();this.storage.getFromCache(t)&&this.storage.delete(t)})})}clear(e=!1){if(e)this.users={},this.usernames={};else{const e=y.default.storagesResults.users;for(const t in this.users){if(!t)continue;const s=t.toPeerId();if(!y.default.isPeerNeeded(s)){const s=this.users[t];s.username&&delete this.usernames[r(s.username)],e.findAndSplice(e=>e.id===t),this.storage.delete(t),delete this.users[t]}}}this.getTopPeersPromises={},this.contactsIndex=this.createSearchIndex(),this.contactsFillPromise=void 0,this.contactsList=new Set,this.updatedContactsList=!1}onContactsModified(){const e=[...this.contactsList];y.default.pushToState("contactsList",e)}fillContacts(){var e;if(this.contactsFillPromise&&this.updatedContactsList)return{cached:this.contactsFillPromise.isFulfilled,promise:this.contactsFillPromise};this.updatedContactsList=!0;const t=Object(n.a)();return g.a.invokeApi("contacts.getContacts").then(e=>{"contacts.contacts"===e._&&(this.contactsList.clear(),this.saveApiUsers(e.users),e.contacts.forEach(e=>{this.pushContact(e.user_id)}),this.onContactsModified(),this.contactsFillPromise=t),t.resolve(this.contactsList)},()=>{this.updatedContactsList=!1}),{cached:null===(e=this.contactsFillPromise)||void 0===e?void 0:e.isFulfilled,promise:this.contactsFillPromise||(this.contactsFillPromise=t)}}resolveUsername(e){return"@"===e[0]&&(e=e.slice(1)),e=e.toLowerCase(),this.usernames[e]?Promise.resolve(this.users[this.usernames[e]]):g.a.invokeApi("contacts.resolveUsername",{username:e}).then(e=>(this.saveApiUsers(e.users),M.a.saveApiChats(e.chats),I.a.getPeer(I.a.getPeerId(e.peer))))}pushContact(e){this.contactsList.add(e),this.contactsIndex.indexObject(e,this.getUserSearchText(e)),y.default.requestPeer(e.toPeerId(),"contacts")}getUserSearchText(e){const t=this.users[e];if(!t)return"";return[t.first_name,t.last_name,t.phone,t.username,t.pFlags.self?c.default.format("SavedMessages",!0):"",t.pFlags.self?"Saved Messages":""].filter(Boolean).join(" ")}getContacts(e,t=!1,s="name"){return this.fillContacts().promise.then(a=>{let n=[...a];if(e){const t=this.contactsIndex.search(e);n=[...n].filter(e=>t.has(e))}"name"===s?n.sort((e,t)=>{const s=(this.users[e]||{}).sortName||"",a=(this.users[t]||{}).sortName||"";return s.localeCompare(a)}):"online"===s&&n.sort((e,t)=>{const s=P.getUserStatusForSort(P.getUser(e).status);return P.getUserStatusForSort(P.getUser(t).status)-s});const o=m.default.myId.toUserId();return Object(i.e)(n,o),t&&this.testSelfSearch(e)&&n.unshift(o),n})}getContactsPeerIds(e,t,s){return this.getContacts(e,t,s).then(e=>e.map(e=>e.toPeerId(!1)))}toggleBlock(e,t){return g.a.invokeApiSingle(t?"contacts.block":"contacts.unblock",{id:I.a.getInputPeerById(e)}).then(s=>(s&&v.a.processLocalUpdate({_:"updatePeerBlocked",peer_id:I.a.getOutputPeer(e),blocked:t}),s))}testSelfSearch(e){const t=this.getSelf(),s=this.createSearchIndex();return s.indexObject(t.id,this.getUserSearchText(t.id)),s.search(e).has(t.id)}createSearchIndex(){return new _.a({clearBadChars:!0,ignoreCase:!0,latinize:!0,includeTag:!0})}saveApiUsers(e,t){e.saved||(e.saved=!0,e.forEach(e=>this.saveApiUser(e,t)))}saveApiUser(e,t){var s,a;if("userEmpty"===e._)return;const i=e.id,n=this.users[i];if(void 0===e.pFlags&&(e.pFlags={}),e.pFlags.min&&void 0!==n)return;if(!n||n.username!==e.username){if(null==n?void 0:n.username){const e=r(n.username);delete this.usernames[e]}if(e.username){const t=r(e.username);this.usernames[t]=i}}if(n&&void 0!==n.initials&&void 0!==n.sortName&&n.first_name===e.first_name&&n.last_name===e.last_name)e.sortName=n.sortName,e.initials=n.initials;else{const t=e.first_name+(e.last_name?" "+e.last_name:"");e.sortName=e.pFlags.deleted?"":Object(o.b)(t,!1),e.initials=f.a.getAbbreviation(t)}e.status&&(e.status.expires&&(e.status.expires-=u.a.serverTimeOffset),e.status.was_online&&(e.status.was_online-=u.a.serverTimeOffset));let d=!1,l=!1;if(void 0===n)this.users[i]=e;else{e.first_name===n.first_name&&e.last_name===n.last_name&&e.username===n.username||(l=!0);(null===(s=n.photo)||void 0===s?void 0:s.photo_id)!==(null===(a=e.photo)||void 0===a?void 0:a.photo_id)&&(d=!0);const t=!!n.pFlags.contact,o=!!e.pFlags.contact;Object(h.i)(n,e),m.default.dispatchEvent("user_update",i),t!==o&&this.onContactUpdated(i,o,t)}d&&m.default.dispatchEvent("avatar_update",e.id.toPeerId()),l&&m.default.dispatchEvent("peer_title_edit",e.id.toPeerId()),this.setUserToStateIfNeeded(e)}setUserToStateIfNeeded(e){y.default.isPeerNeeded(e.id.toPeerId())&&this.storage.set({[e.id]:e})}formatUserPhone(e){return"+"+Object(l.a)(e).formatted}isUserOnlineVisible(e){return this.getUserStatusForSort(e)>3}getUserStatusForSort(e){if("object"!=typeof e&&(e=this.getUser(e).status),e){const t="userStatusOnline"===e._?e.expires:"userStatusOffline"===e._?e.was_online:0;if(t)return t;switch(e._){case"userStatusRecently":return 3;case"userStatusLastWeek":return 2;case"userStatusLastMonth":return 1}}return 0}getUser(e){return Object(h.f)(e)?e:this.users[e]||{id:e,pFlags:{deleted:!0},access_hash:""}}getSelf(){return this.getUser(m.default.myId)}getUserStatusString(e){var t;let s,a;switch(e){case p.c:s="Peer.RepliesNotifications";break;case p.d:s="Peer.ServiceNotifications";break;default:{if(this.isBot(e)){s="Bot";break}const i=this.getUser(e);if(!i){s="";break}if(i.pFlags.support){s="SupportStatus";break}switch(null===(t=i.status)||void 0===t?void 0:t._){case"userStatusRecently":s="Lately";break;case"userStatusLastWeek":s="WithinAWeek";break;case"userStatusLastMonth":s="WithinAMonth";break;case"userStatusOffline":{const e=i.status.was_online,t=Date.now()/1e3;if(t-e<60)s="Peer.Status.justNow";else if(t-e<3600){s="Peer.Status.minAgo";a=[(t-e)/60|0]}else if(t-e<86400){s="LastSeen.HoursAgo";a=[(t-e)/3600|0]}else{s="Peer.Status.LastSeenAt";const t=new Date(1e3*e);a=[("0"+t.getDate()).slice(-2)+"."+("0"+(t.getMonth()+1)).slice(-2),("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)]}break}case"userStatusOnline":s="Online";break;default:s="ALongTimeAgo"}break}}return Object(c.i18n)(s,a)}isBot(e){return this.users[e]&&this.users[e].pFlags.bot}isContact(e){return this.contactsList.has(e)||this.users[e]&&this.users[e].pFlags.contact}isRegularUser(e){const t=this.users[e];return t&&!this.isBot(e)&&!t.pFlags.deleted&&!t.pFlags.support}isNonContactUser(e){return this.isRegularUser(e)&&!this.isContact(e)&&e!==m.default.myId}hasUser(e,t){const s=this.users[e];return Object(h.f)(s)&&(t||!s.pFlags.min)}canSendToUser(e){const t=this.getUser(e);return!t.pFlags.deleted&&t.id!==p.c}getUserPhoto(e){const t=this.getUser(e);return t&&t.photo||{_:"userProfilePhotoEmpty"}}getUserString(e){const t=this.getUser(e);return"u"+e+(t.access_hash?"_"+t.access_hash:"")}getUserInput(e){const t=this.getUser(e);return t.pFlags&&t.pFlags.self?{_:"inputUserSelf"}:{_:"inputUser",user_id:e,access_hash:t.access_hash}}getContactMediaInput(e){const t=this.getUser(e);return{_:"inputMediaContact",first_name:t.first_name,last_name:t.last_name,phone_number:t.phone,vcard:"",user_id:e}}updateUserStatus(e,t=Object(d.g)(!0)){e.status&&"userStatusOnline"===e.status._&&e.status.expires<t&&(e.status={_:"userStatusOffline",was_online:e.status.expires},m.default.dispatchEvent("user_update",e.id),this.setUserToStateIfNeeded(e))}forceUserOnline(e,t){if(this.isBot(e))return;const s=Object(d.g)(!0);if(t){if(s-t>=60)return}else if(v.a.updatesState.syncLoading)return;const a=this.getUser(e);a&&a.status&&"userStatusOnline"!==a.status._&&"userStatusEmpty"!==a.status._&&!a.pFlags.support&&!a.pFlags.deleted&&(a.status={_:"userStatusOnline",expires:s+60},m.default.dispatchEvent("user_update",e),this.setUserToStateIfNeeded(a))}importContact(e,t,s){return this.importContacts([{first_name:e,last_name:t,phones:[s]}]).then(e=>{if(!e.length){const e=new Error;throw e.type="NO_USER",e}return e[0]})}importContacts(e){const t=[];for(let s=0;s<e.length;++s)for(let a=0;a<e[s].phones.length;++a)t.push({_:"inputPhoneContact",client_id:(s<<16|a).toString(10),phone:e[s].phones[a],first_name:e[s].first_name,last_name:e[s].last_name});return g.a.invokeApi("contacts.importContacts",{contacts:t}).then(e=>{this.saveApiUsers(e.users);return e.imported.map(e=>(this.onContactUpdated(e.user_id,!0),e.user_id))})}getTopPeers(e){return this.getTopPeersPromises[e]?this.getTopPeersPromises[e]:this.getTopPeersPromises[e]=y.default.getState().then(t=>{const s=t.topPeersCache[e];return s&&s.cachedTime+864e5>Date.now()&&s.peers?s.peers:g.a.invokeApi("contacts.getTopPeers",{[e]:!0,offset:0,limit:15,hash:"0"}).then(s=>{let a=[];return"contacts.topPeers"===s._&&(this.saveApiUsers(s.users),M.a.saveApiChats(s.chats),s.categories.length&&(a=s.categories[0].peers.map(e=>{const t=I.a.getPeerId(e.peer);return y.default.requestPeer(t,"topPeer"),{id:t,rating:e.rating}}))),t.topPeersCache[e]={peers:a,cachedTime:Date.now()},y.default.pushToState("topPeersCache",t.topPeersCache),a})})}getBlocked(e=0,t=0){return g.a.invokeApiSingle("contacts.getBlocked",{offset:e,limit:t}).then(e=>{this.saveApiUsers(e.users),M.a.saveApiChats(e.chats);return{count:"contacts.blocked"===e._?e.users.length+e.chats.length:e.count,peerIds:e.users.map(e=>e.id.toPeerId()).concat(e.chats.map(e=>e.id.toPeerId(!0)))}})}searchContacts(e,t=20){return g.a.invokeApiCacheable("contacts.search",{q:e,limit:t},{cacheSeconds:60}).then(e=>{this.saveApiUsers(e.users),M.a.saveApiChats(e.chats);return{my_results:Object(i.b)(e.my_results.map(e=>I.a.getPeerId(e))),results:e.results.map(e=>I.a.getPeerId(e))}})}onContactUpdated(e,t,s=this.isContact(e)){t!==s&&(t?this.pushContact(e):this.contactsList.delete(e),this.onContactsModified(),m.default.dispatchEvent("contacts_update",e))}updateUsername(e){return g.a.invokeApi("account.updateUsername",{username:e}).then(e=>{this.saveApiUser(e)})}setUserStatus(e,t){if(this.isBot(e))return;const s=this.users[e];if(s){const a=t?{_:"userStatusOffline",was_online:Object(d.g)(!0)}:{_:"userStatusOnline",expires:Object(d.g)(!0)+50};s.status=a,m.default.dispatchEvent("user_update",e),this.setUserToStateIfNeeded(s)}}addContact(e,t,s,a,i){return g.a.invokeApi("contacts.addContact",{id:this.getUserInput(e),first_name:t,last_name:s,phone:a,add_phone_privacy_exception:i}).then(t=>{v.a.processUpdateMessage(t,{override:!0}),this.onContactUpdated(e,!0)})}deleteContacts(e){return g.a.invokeApi("contacts.deleteContacts",{id:e.map(e=>this.getUserInput(e))}).then(t=>{v.a.processUpdateMessage(t,{override:!0}),e.forEach(e=>{this.onContactUpdated(e,!1)})})}};a.a.appUsersManager=P;t.a=P},42:function(e,t,s){"use strict";var a=s(29),i=s(34),n=s(31),o=s(15),r=s(46),d=s(40),l=s(16);const h=["#fc5c51","#0fb297","#d09306","#3d72ed","#895dd5","#cd4073","#00c1a6","#fa790f"],c=["red","green","yellow","blue","violet","pink","cyan","orange"],g=[0,7,4,1,6,3,5];["isChannel","isMegagroup","isAnyGroup","isBroadcast","isBot","isContact","isUser","isAnyChat"].forEach(e=>{const t=Array.isArray(e)?e[0]:e,s=Array.isArray(e)?e[1]:e;String.prototype[t]=function(){return p[s](this.toString())},Number.prototype[t]=function(){return p[s](this)}});const p=new class{canPinMessage(e){return e.isUser()||r.a.hasRights(e.toChatId(),"pin_messages")}getPeerPhoto(e){const t=e.isUser()?d.a.getUserPhoto(e.toUserId()):r.a.getChatPhoto(e.toChatId());return"chatPhotoEmpty"!==t._&&"userProfilePhotoEmpty"!==t._?t:null}getPeerMigratedTo(e){if(e.isUser())return!1;const t=r.a.getChat(e.toChatId());return!!(t&&t.migrated_to&&t.pFlags.deactivated)&&this.getPeerId(t.migrated_to)}getPeerTitle(e,t=!1,s=!1){e||(e=o.default.myId);let a="";if(e.isUser()){const t=d.a.getUser(e.toUserId());t.first_name&&(a+=t.first_name),!t.last_name||s&&a||(a+=" "+t.last_name),a=a?a.trim():t.pFlags.deleted?l.default.format("HiddenName",!0):t.username}else{a=r.a.getChat(e.toChatId()).title,s&&(a=a.split(" ")[0])}return t?a:n.a.wrapEmojiText(a)}getOutputPeer(e){if(e.isUser())return{_:"peerUser",user_id:e.toUserId()};const t=e.toChatId();return r.a.isChannel(t)?{_:"peerChannel",channel_id:t}:{_:"peerChat",chat_id:t}}getPeerString(e){return e.isUser()?d.a.getUserString(e.toUserId()):r.a.getChatString(e.toChatId())}getPeerUsername(e){return this.getPeer(e).username||""}getPeer(e){return e.isUser()?d.a.getUser(e.toUserId()):r.a.getChat(e.toChatId())}getPeerId(e){if(void 0!==e&&e.isPeerId&&e.isPeerId())return e;if(Object(i.f)(e))return void 0!==e.user_id?e.user_id.toPeerId():(e.channel_id||e.chat_id).toPeerId(!0);if(!e)return 0;const t="u"===e.charAt(0),s=e.substr(1).split("_");return t?s[0].toPeerId():(s[0]||"").toPeerId(!0)}getDialogPeer(e){return{_:"dialogPeer",peer:this.getOutputPeer(e)}}isChannel(e){return!e.isUser()&&r.a.isChannel(e.toChatId())}isMegagroup(e){return!e.isUser()&&r.a.isMegagroup(e.toChatId())}isAnyGroup(e){return!e.isUser()&&!r.a.isBroadcast(e.toChatId())}isBroadcast(e){return this.isChannel(e)&&!this.isMegagroup(e)}isBot(e){return e.isUser()&&d.a.isBot(e.toUserId())}isContact(e){return e.isUser()&&d.a.isContact(e.toUserId())}isUser(e){return+e>=0}isAnyChat(e){return!this.isUser(e)}getInputNotifyPeerById(e,t){return t?e.isUser()?{_:"inputNotifyUsers"}:this.isBroadcast(e)?{_:"inputNotifyBroadcasts"}:{_:"inputNotifyChats"}:{_:"inputNotifyPeer",peer:this.getInputPeerById(e)}}getInputPeerById(e){if(!e)return{_:"inputPeerEmpty"};if(!e.isUser()){const t=e.toChatId();return r.a.isChannel(t)?r.a.getChannelInputPeer(t):r.a.getChatInputPeer(t)}const t=e.toUserId();return{_:"inputPeerUser",user_id:t,access_hash:d.a.getUser(t).access_hash}}getInputDialogPeerById(e){return{_:"inputDialogPeer",peer:Object(i.f)(e)?e:this.getInputPeerById(e)}}getPeerColorById(e,t=!0){if(!e)return"";const s=g[Math.abs(+e)%7];return(t?c:h)[s]}getPeerSearchText(e){let t;if(this.isUser(e))t="%pu "+d.a.getUserSearchText(e.toUserId());else{t="%pg "+(r.a.getChat(e.toChatId()).title||"")}return t}getDialogType(e){return this.isMegagroup(e)?"megagroup":this.isChannel(e)?"channel":this.isUser(e)?e===o.default.myId?"saved":"chat":"group"}getDeleteButtonText(e){switch(this.getDialogType(e)){case"channel":return r.a.hasRights(e.toChatId(),"delete_chat")?"ChannelDelete":"ChatList.Context.LeaveChannel";case"megagroup":case"group":return r.a.hasRights(e.toChatId(),"delete_chat")?"DeleteMega":"ChatList.Context.LeaveGroup";default:return"ChatList.Context.DeleteChat"}}};a.a.appPeersManager=p,t.a=p},46:function(e,t,s){"use strict";var a=s(29),i=s(34),n=s(32),o=s(31),r=s(15),d=s(79),l=s(42),h=s(17),c=s(40);const g=new class{constructor(){this.storage=h.default.storages.chats,this.onChatUpdated=(e,t)=>{var s;d.a.processUpdateMessage(t),(null===(s=null==t?void 0:t.updates)||void 0===s?void 0:s.length)&&this.isChannel(e)&&r.default.dispatchEvent("invalidate_participants",e)},this.clear(!0),r.default.addMultipleEventsListeners({updateChannelParticipant:e=>{n.a.clearCache("channels.getParticipants",t=>t.channel.channel_id===e.channel_id)},updateChatDefaultBannedRights:e=>{const t=l.a.getPeerId(e.peer).toChatId(),s=this.chats[t];s&&(s.default_banned_rights=e.default_banned_rights,r.default.dispatchEvent("chat_update",t))}}),h.default.getState().then(e=>{const t=h.default.storagesResults.chats;if(t.length)for(let e=0,s=t.length;e<s;++e){const s=t[e];s&&(this.chats[s.id]=s)}h.default.addEventListener("peerNeeded",e=>{e.isUser()||this.storage.getFromCache(e.toChatId())||this.storage.set({[e.toChatId()]:this.getChat(e.toChatId())})}),h.default.addEventListener("peerUnneeded",e=>{!e.isUser()&&this.storage.getFromCache(e.toChatId())&&this.storage.delete(e.toChatId())})})}clear(e=!1){if(e)this.chats={};else{const e=h.default.storagesResults.chats;for(const t in this.chats)t&&(h.default.isPeerNeeded(t.toPeerId(!0))||(e.findAndSplice(e=>e.id===t),this.storage.delete(t),delete this.chats[t]))}}saveApiChats(e,t){e.saved||(e.saved=!0,e.forEach(e=>this.saveApiChat(e,t)))}saveApiChat(e,t){var s,a;if("chatEmpty"===e._)return;const n=this.chats[e.id];if(void 0===e.pFlags&&(e.pFlags={}),e.pFlags.min&&void 0!==n)return;e.initials=o.a.getAbbreviation(e.title),"channel"===e._&&void 0===e.participants_count&&void 0!==n&&n.participants_count&&(e.participants_count=n.participants_count);let d=!1,l=!1;if(void 0===n)this.chats[e.id]=e;else{(null===(s=n.photo)||void 0===s?void 0:s.photo_id)!==(null===(a=e.photo)||void 0===a?void 0:a.photo_id)&&(d=!0),n.title!==e.title&&(l=!0),Object(i.i)(n,e),r.default.dispatchEvent("chat_update",e.id)}const c=e.id.toPeerId(!0);d&&r.default.dispatchEvent("avatar_update",c),l&&r.default.dispatchEvent("peer_title_edit",c),h.default.isPeerNeeded(c)&&this.storage.set({[e.id]:e})}getChat(e){return e.isAnyChat()&&(console.error("chatId should be positive"),a.b),this.chats[e]||{_:"chatEmpty",id:e,deleted:!0,access_hash:"",pFlags:{}}}combineParticipantBannedRights(e,t){const s=this.getChat(e);if(s.default_banned_rights){t=Object(i.a)(t);const e=s.default_banned_rights.pFlags;for(let s in e)t.pFlags[s]=e[s]}return t}hasRights(e,t,s,a){const i=this.getChat(e);if("chatEmpty"===i._)return!1;if(i.pFlags.deactivated&&"view_messages"!==t)return!1;if(i.pFlags.creator&&void 0===s)return!0;if("chatForbidden"===i._||"channelForbidden"===i._||i.pFlags.kicked||i.pFlags.left&&!i.pFlags.megagroup)return!1;if(!s&&!(s=i.admin_rights||i.banned_rights||i.default_banned_rights))return!1;let n={};switch(s&&(n=s.pFlags),t){case"embed_links":case"send_games":case"send_gifs":case"send_inline":case"send_media":case"send_messages":case"send_polls":case"send_stickers":if(!a&&i.pFlags.left)return!1;if("chatBannedRights"===s._&&n[t])return!1;if("channel"===i._&&!i.pFlags.megagroup&&!n.post_messages)return!1;break;case"delete_messages":return!!n.delete_messages;case"pin_messages":return"chatAdminRights"===s._?n[t]||!!n.post_messages:!n[t];case"invite_users":case"change_info":return"chatAdminRights"===s._?n[t]:!n[t];case"change_type":case"delete_chat":return!1;case"change_permissions":return"chatAdminRights"===s._&&n.ban_users;case"view_participants":return!("chat"!==i._&&i.pFlags.broadcast&&!i.pFlags.creator&&!i.admin_rights)}return!0}editChatDefaultBannedRights(e,t){const s=this.getChat(e);return s.default_banned_rights&&s.default_banned_rights.until_date===t.until_date&&Object(i.b)(s.default_banned_rights.pFlags,t.pFlags)?Promise.resolve():n.a.invokeApi("messages.editChatDefaultBannedRights",{peer:l.a.getInputPeerById(e.toPeerId(!0)),banned_rights:t}).then(this.onChatUpdated.bind(this,e))}isChannel(e){const t=this.chats[e];return t&&("channel"===t._||"channelForbidden"===t._)}isMegagroup(e){const t=this.chats[e];return t&&"channel"===t._&&t.pFlags.megagroup}isBroadcast(e){return this.isChannel(e)&&!this.isMegagroup(e)}isInChat(e){let t=!0;const s=this.getChat(e);return("channelForbidden"===s._||"chatForbidden"===s._||"chatEmpty"===s._||s.pFlags.left||s.pFlags.kicked||s.pFlags.deactivated)&&(t=!1),t}getChannelInput(e){const t=this.getChat(e);return"chatEmpty"!==t._&&t.access_hash?{_:"inputChannel",channel_id:e,access_hash:t.access_hash||"0"}:{_:"inputChannelEmpty"}}getChatInputPeer(e){return{_:"inputPeerChat",chat_id:e}}getChannelInputPeer(e){return{_:"inputPeerChannel",channel_id:e,access_hash:this.getChat(e).access_hash||0}}hasChat(e,t){const s=this.chats[e];return Object(i.f)(s)&&(t||!s.pFlags.min)}getChatPhoto(e){const t=this.getChat(e);return t&&t.photo||{_:"chatPhotoEmpty"}}getChatString(e){const t=this.getChat(e);return this.isChannel(e)?(this.isMegagroup(e)?"s":"c")+e+"_"+t.access_hash:"g"+e}createChannel(e,t){return n.a.invokeApi("channels.createChannel",{broadcast:!0,title:e,about:t}).then(e=>{d.a.processUpdateMessage(e);const t=e.chats[0].id;return r.default.dispatchEvent("history_focus",{peerId:t.toPeerId(!0)}),t})}inviteToChannel(e,t){const s=this.getChannelInput(e),a=t.map(e=>c.a.getUserInput(e));return n.a.invokeApi("channels.inviteToChannel",{channel:s,users:a}).then(this.onChatUpdated.bind(this,e))}createChat(e,t){return n.a.invokeApi("messages.createChat",{users:t.map(e=>c.a.getUserInput(e)),title:e}).then(e=>{d.a.processUpdateMessage(e);const t=e.chats[0].id;return r.default.dispatchEvent("history_focus",{peerId:t.toPeerId(!0)}),t})}leaveChannel(e){return n.a.invokeApi("channels.leaveChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}joinChannel(e){return n.a.invokeApi("channels.joinChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}addChatUser(e,t,s=100){return n.a.invokeApi("messages.addChatUser",{chat_id:e,user_id:c.a.getUserInput(t),fwd_limit:s}).then(this.onChatUpdated.bind(this,e))}deleteChatUser(e,t){return n.a.invokeApi("messages.deleteChatUser",{chat_id:e,user_id:c.a.getUserInput(t)}).then(this.onChatUpdated.bind(this,e))}leaveChat(e){return this.deleteChatUser(e,c.a.getSelf().id)}leave(e){return this.isChannel(e)?this.leaveChannel(e):this.leaveChat(e)}delete(e){return this.isChannel(e)?this.deleteChannel(e):this.deleteChat(e)}deleteChannel(e){return n.a.invokeApi("channels.deleteChannel",{channel:this.getChannelInput(e)}).then(this.onChatUpdated.bind(this,e))}deleteChat(e){return n.a.invokeApi("messages.deleteChat",{chat_id:e})}migrateChat(e){const t=this.getChat(e);return"channel"===t._?Promise.resolve(t.id):n.a.invokeApi("messages.migrateChat",{chat_id:e}).then(t=>{this.onChatUpdated(e,t);return t.updates.find(e=>"updateChannel"===e._).channel_id})}updateUsername(e,t){return n.a.invokeApi("channels.updateUsername",{channel:this.getChannelInput(e),username:t}).then(s=>{if(s){this.getChat(e).username=t}return s})}editPhoto(e,t){const s={_:"inputChatUploadedPhoto",file:t};let a;return a=this.isChannel(e)?n.a.invokeApi("channels.editPhoto",{channel:this.getChannelInput(e),photo:s}):n.a.invokeApi("messages.editChatPhoto",{chat_id:e,photo:s}),a.then(e=>{d.a.processUpdateMessage(e)})}editTitle(e,t){let s;return s=this.isChannel(e)?n.a.invokeApi("channels.editTitle",{channel:this.getChannelInput(e),title:t}):n.a.invokeApi("messages.editChatTitle",{chat_id:e,title:t}),s.then(e=>{d.a.processUpdateMessage(e)})}editAbout(e,t){const s=e.toPeerId(!0);return n.a.invokeApi("messages.editChatAbout",{peer:l.a.getInputPeerById(s),about:t}).then(e=>{r.default.dispatchEvent("peer_bio_edit",s)})}getParticipantPeerId(e){return e.peer?l.a.getPeerId(e.peer):e.user_id.toPeerId()}editBanned(e,t,s){const a="object"!=typeof t?t:this.getParticipantPeerId(t);return n.a.invokeApi("channels.editBanned",{channel:this.getChannelInput(e),participant:l.a.getInputPeerById(a),banned_rights:s}).then(i=>{if(this.onChatUpdated(e,i),"object"==typeof t){const i=Date.now()/1e3|0;d.a.processLocalUpdate({_:"updateChannelParticipant",channel_id:e,date:i,actor_id:void 0,qts:void 0,user_id:a,prev_participant:t,new_participant:Object.keys(s.pFlags).length?{_:"channelParticipantBanned",date:i,banned_rights:s,kicked_by:c.a.getSelf().id,peer:l.a.getOutputPeer(a),pFlags:{}}:void 0})}})}clearChannelParticipantBannedRights(e,t){return this.editBanned(e,t,{_:"chatBannedRights",until_date:0,pFlags:{}})}kickFromChannel(e,t){return this.editBanned(e,t,{_:"chatBannedRights",until_date:0,pFlags:{view_messages:!0}})}resolveChannel(e){return n.a.invokeApiSingle("channels.getChannels",{id:[{_:"inputChannel",channel_id:e,access_hash:"0"}]}).then(e=>{this.saveApiChats(e.chats)})}togglePreHistoryHidden(e,t){return this.migrateChat(e).then(e=>n.a.invokeApi("channels.togglePreHistoryHidden",{channel:this.getChannelInput(e),enabled:t})).then(e=>{d.a.processUpdateMessage(e)})}toggleSignatures(e,t){return n.a.invokeApi("channels.toggleSignatures",{channel:this.getChannelInput(e),enabled:t}).then(e=>{d.a.processUpdateMessage(e)})}};a.a.appChatsManager=g,t.a=g},50:function(e,t,s){"use strict";var a=s(75),i=s(122),n=s(34),o=s(0),r=s(32),d=s(132),l=s(73),h=s(40),c=s(126),g=s(29),p=s(96),u=s(118),f=s(37),m=s(97);class _{constructor(){this.photos={}}savePhoto(e,t){var s;if("photoEmpty"===e._)return;const a=this.photos[e.id];if(e.file_reference&&(Object(n.h)("file_reference",a,e),d.a.saveContext(e.file_reference,t)),null===(s=e.sizes)||void 0===s?void 0:s.length){const t=e.sizes[e.sizes.length-1];"photoSizeProgressive"===t._&&(t.size=t.sizes[t.sizes.length-1])}return a?Object.assign(a,e):this.photos[e.id]=e}choosePhotoSize(e,t=0,s=0,a=!1,i=!1){window.devicePixelRatio>1&&(t*=2,s*=2);let n={_:"photoSizeEmpty",type:""},o=e.sizes||e.thumbs;if(i&&o&&"document"===e._&&(o=o.concat({_:"photoSize",w:e.w,h:e.h,size:e.size,type:void 0})),null==o?void 0:o.length){for(let e=0,a=o.length;e<a;++e){const a=o[e];if(!("w"in a)&&!("h"in a))continue;n=a;const i=Object(u.a)(a.w,a.h,t,s);if(i.width>=t||i.height>=s)break}a&&"photoSizeEmpty"===n._&&"photoStrippedSize"===o[0]._&&(n=o[0])}return n}getUserPhotos(e,t="0",s=20){const a=h.a.getUserInput(e);return r.a.invokeApiCacheable("photos.getUserPhotos",{user_id:a,offset:0,limit:s,max_id:t},{cacheSeconds:60}).then(s=>{h.a.saveApiUsers(s.users);const a=s.photos.map((t,a)=>(s.photos[a]=this.savePhoto(t,{type:"profilePhoto",peerId:e.toPeerId()}),t.id));if("0"!==t&&t){const e=a.indexOf(t);-1!==e&&a.splice(e,1)}return{count:s.count||a.length,photos:a}})}getPreviewURLFromBytes(e,t=!1){let s,a;t?s=e instanceof Uint8Array?e:new Uint8Array(e):(s=new Uint8Array(_.jpegHeader.concat(Array.from(e.slice(3)),_.jpegTail)),s[164]=e[1],s[166]=e[2]),a=t?o.IS_SAFARI?"image/png":"image/webp":"image/jpeg";const i=new Blob([s],{type:a});return URL.createObjectURL(i)}getPathFromPhotoPathSize(e){const t=e.bytes;let s="M";for(let e=0,a=t.length;e<a;++e){const a=t[e];a>=192?s+="AACAAAAHAAALMAAAQASTAVAAAZaacaaaahaaalmaaaqastava.az0123456789-,"[a-128-64]:(a>=128?s+=",":a>=64&&(s+="-"),s+=""+(63&a))}return s+="z",s}getPreviewURLFromThumb(e,t,s=!1){const a=l.a.getCacheContext(e,t.type);return a.url||(a.url=this.getPreviewURLFromBytes(t.bytes,s))}getImageFromStrippedThumb(e,t,s){const a=this.getPreviewURLFromThumb(e,t,!1),i=new Image;i.classList.add("thumbnail");const n=(s?Object(c.a)(a):Promise.resolve(a)).then(e=>Object(p.b)(i,e));return{image:i,loadPromise:n}}setAttachmentSize(e,t,s,a,i=!0,n,o,r){let d;r||(r=this.choosePhotoSize(e,s,a,void 0,o));const l="document"===e._;d=l?Object(f.c)(e.w||r.w||512,e.h||r.h||512):Object(f.c)(r.w||100,r.h||100);let h=Object(f.c)(s,a);h=d=d.aspect(h,i);let c=!0;return l&&!["video","gif"].includes(e.type)||(h.width<200&&h.height<200&&(h=d=d.aspectCovered(Object(f.c)(200,200))),n&&(n.message||n.reply_to_mid||n.media.webpage||n.replies&&n.replies.pFlags.comments&&777!==n.replies.channel_id)&&h.width<320&&(h=Object(f.c)(320,h.height),c=!1),c&&h.width<120&&n&&(h=Object(f.c)(120,h.height),c=!1)),t.style.width=h.width+"px",t.style.height=h.height+"px",{photoSize:r,size:d,isFit:c}}getStrippedThumbIfNeeded(e,t,s,a=!1){if(!t.downloaded||["video","gif"].includes(e.type)||a){if("document"===e._&&t.downloaded&&!a)return null;const i=e.sizes||e.thumbs,n=(null==i?void 0:i.length)?i.find(e=>"photoStrippedSize"===e._):null;if(n&&"bytes"in n)return this.getImageFromStrippedThumb(e,n,s)}return null}getPhotoDownloadOptions(e,t,s,a){const i="document"===e._;if(!t||"photoSizeEmpty"===t._)throw new Error("photoSizeEmpty!");const n=("photoSize"===t._||"photoSizeProgressive"===t._)&&e.access_hash&&e.file_reference,o={_:i?"inputDocumentFileLocation":"inputPhotoFileLocation",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference,thumb_size:t.type};return{dcId:e.dc_id,location:o,size:n?t.size:void 0,queueId:s,onlyCache:a}}preloadPhoto(e,t,s,a){const n=this.getPhoto(e);if(!n||"photoEmpty"===n._)throw new Error("preloadPhoto photoEmpty!");if(!t){const e=m.a.windowW,s=m.a.windowH;t=this.choosePhotoSize(n,e,s)}const o=l.a.getCacheContext(n,t.type);if(o.downloaded>=("size"in t?t.size:0)&&o.url)return Promise.resolve();const r=this.getPhotoDownloadOptions(n,t,s,a),d=Object(i.a)(r.location);let h=l.a.getDownload(d);return h||(h=l.a.download(r),h.then(e=>{if(!o.downloaded||o.downloaded<e.size){const t=URL.createObjectURL(e);o.downloaded=e.size,o.url=t}return e}).catch(()=>{}),h)}getPhoto(e){return Object(n.f)(e)?e:this.photos[e]}getInput(e){return{_:"inputPhoto",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference}}getMediaInput(e){return{_:"inputMediaPhoto",id:this.getInput(e),ttl_seconds:0}}savePhotoFile(e,t){const s=this.choosePhotoSize(e,65535,65535);if("photoSize"!==s._&&"photoSizeProgressive"!==s._)return;const a=this.getPhotoDownloadOptions(e,s,t);a.fileName="photo"+e.id+".jpg",l.a.downloadToDisc(a,a.fileName)}}_.jpegHeader=Object(a.c)("ffd8ffe000104a46494600010100000100010000ffdb004300281c1e231e19282321232d2b28303c64413c37373c7b585d4964918099968f808c8aa0b4e6c3a0aadaad8a8cc8ffcbdaeef5ffffff9bc1fffffffaffe6fdfff8ffdb0043012b2d2d3c353c76414176f8a58ca5f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8f8ffc00011080000000003012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00"),_.jpegTail=Object(a.c)("ffd9");const v=new _;g.a&&(g.a.appPhotosManager=v),t.a=v},53:function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var a=s(29),i=s(42),n=s(15),o=s(16),r=s(36),d=s(40);const l=new WeakMap;a.a.peerTitleWeakMap=l,n.default.addEventListener("peer_title_edit",e=>{Array.from(document.querySelectorAll(`.peer-title[data-peer-id="${e}"]`)).forEach(e=>{const t=l.get(e);t&&t.update()})});class h{constructor(e){this.plainText=!1,this.onlyFirstName=!1,this.dialog=!1,this.element=document.createElement("span"),this.element.classList.add("peer-title"),this.element.setAttribute("dir","auto"),this.update(e),l.set(this.element,this)}update(e){if(e)for(let t in e)this.element.dataset[t]=e[t]?""+("boolean"==typeof e[t]?+e[t]:e[t]):"0",this[t]=e[t];this.peerId===n.default.myId&&this.dialog?Object(r.a)(this.element,Object(o.i18n)(this.onlyFirstName?"Saved":"SavedMessages")):this.peerId.isUser()&&d.a.getUser(this.peerId).pFlags.deleted?Object(r.a)(this.element,Object(o.i18n)(this.onlyFirstName?"Deleted":"HiddenName")):this.element.innerHTML=i.a.getPeerTitle(this.peerId,this.plainText,this.onlyFirstName)}}},64:function(e,t,s){"use strict";var a=s(122),i=s(34),n=s(132),o=s(139),r=s(31),d=s(73),l=s(50),h=s(126),c=s(32),g=s(29),p=s(54),u=s(15),f=s(117),m=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};const _={mov:"video/quicktime",gif:"image/gif",pdf:"application/pdf"};const v=new class{constructor(){this.docs={},this.savingLottiePreview={},this.downloading=new Map,this.onServiceWorkerFail=()=>{for(const e in this.docs){const t=this.docs[e];if(t.supportsStreaming){delete t.supportsStreaming;delete d.a.getCacheContext(t).url}}},c.a.onServiceWorkerFail=this.onServiceWorkerFail}saveDoc(e,t){if("documentEmpty"===e._)return;const s=this.docs[e.id];if(e.file_reference&&(Object(i.h)("file_reference",s,e),n.a.saveContext(e.file_reference,t)),s||(this.docs[e.id]=e),e.attributes.forEach(t=>{switch(t._){case"documentAttributeFilename":e.file_name=r.a.wrapPlainText(t.file_name),e.fileName=r.a.wrapEmojiText(t.file_name);break;case"documentAttributeAudio":e.duration=t.duration,e.audioTitle=r.a.wrapEmojiText(t.title),e.audioPerformer=r.a.wrapEmojiText(t.performer),e.type=t.pFlags.voice&&"audio/ogg"===e.mime_type?"voice":"audio";break;case"documentAttributeVideo":e.duration=t.duration,e.w=t.w,e.h=t.h,t.pFlags.round_message?e.type="round":e.type="video";break;case"documentAttributeSticker":void 0!==t.alt&&(e.stickerEmojiRaw=t.alt,e.stickerEmoji=r.a.wrapRichText(e.stickerEmojiRaw,{noLinks:!0,noLinebreaks:!0})),t.stickerset&&("inputStickerSetEmpty"===t.stickerset._?delete t.stickerset:"inputStickerSetID"===t.stickerset._&&(e.stickerSetInput=t.stickerset)),"image/webp"===e.mime_type&&(e.thumbs||f.a)&&(e.type="sticker",e.sticker=1);break;case"documentAttributeImageSize":e.type="photo",e.w=t.w,e.h=t.h;break;case"documentAttributeAnimated":"image/gif"!==e.mime_type&&"video/mp4"!==e.mime_type||(e.type="gif"),e.animated=!0}}),e.mime_type)e.mime_type===_.pdf?e.type="pdf":e.mime_type===_.gif&&(e.type="gif");else{const t=(e.file_name||"").split(".").pop(),s=t&&_[t.toLowerCase()];if(s)e.mime_type=s;else switch(e.type){case"gif":case"video":case"round":e.mime_type="video/mp4";break;case"sticker":e.mime_type="image/webp";break;case"audio":e.mime_type="audio/mpeg";break;case"voice":e.mime_type="audio/ogg";break;default:e.mime_type="application/octet-stream"}}if("voice"!==e.type&&"round"!==e.type||(e.file_name=e.fileName=e.type+"_"+Object(p.f)(new Date(1e3*e.date),{monthAsNumber:!0,leadingZero:!0}).replace(/[:\.]/g,"-").replace(", ","_")),c.a.isServiceWorkerOnline()&&("gif"===e.type&&e.size>8e6||"audio"===e.type||"video"===e.type)){e.supportsStreaming=!0;const t=d.a.getCacheContext(e);t.url||(t.url=this.getFileURL(e))}return e.file_name||(e.file_name=e.fileName=""),"application/x-tgsticker"===e.mime_type&&"AnimatedSticker.tgs"===e.file_name&&(e.type="sticker",e.animated=!0,e.sticker=2),s?Object.assign(s,e):e}getDoc(e){return Object(i.f)(e)?e:this.docs[e]}getMediaInput(e){return{_:"inputMediaDocument",id:{_:"inputDocument",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference},ttl_seconds:0}}getInput(e,t){return{_:"inputDocumentFileLocation",id:e.id,access_hash:e.access_hash,file_reference:e.file_reference,thumb_size:t}}getFileDownloadOptions(e,t,s,a){const i=this.getInput(e,null==t?void 0:t.type);let n;return n=t?e.sticker?"image/webp":"image/jpeg":e.mime_type||"application/octet-stream",{dcId:e.dc_id,location:i,size:t?t.size:e.size,mimeType:n,fileName:e.file_name,queueId:s,onlyCache:a}}getFileURL(e,t=!1,s){let i;return i=t?"download":s?"thumb":e.supportsStreaming?"stream":"document",Object(a.b)(i,this.getFileDownloadOptions(e,s))}getThumbURL(e,t){let s=Promise.resolve();const a=d.a.getCacheContext(e,t.type);return a.url||(s="bytes"in t?Object(h.a)(l.a.getPreviewURLFromBytes(t.bytes,!!e.sticker)).then(e=>{a.url=e}):l.a.preloadPhoto(e,t)),{thumb:t,cacheContext:a,promise:s}}getThumb(e,t=!0){const s=l.a.choosePhotoSize(e,0,0,!t);return"photoSizeEmpty"===s._?null:this.getThumbURL(e,s)}getInputFileName(e,t){return Object(a.a)(this.getInput(e,t),{fileName:e.file_name})}downloadDoc(e,t,s){const a=this.getInputFileName(e);let i=d.a.getDownload(a);if(i)return i;const n=this.getFileDownloadOptions(e,void 0,t,s);i=d.a.download(n),this.downloading.set(e.id,i),u.default.dispatchEvent("download_start",e.id);const r=d.a.getCacheContext(e),l=i;return l.then(e=>{r.url=URL.createObjectURL(e),r.downloaded=e.size},()=>{}).finally(()=>{this.downloading.delete(e.id)}),"voice"!==e.type||o.a.isPlaySupported()||(i=l.then(e=>m(this,void 0,void 0,(function*(){const t=new FileReader;return yield new Promise((s,a)=>{t.onloadend=e=>{const t=new Uint8Array(e.target.result);o.a.decode(t).then(e=>{r.url=e.url,s()},e=>{delete r.downloaded,a(e)})},t.readAsArrayBuffer(e)}),e})))),i.then(()=>{u.default.dispatchEvent("document_downloaded",e)}),i}saveLottiePreview(e,t,s){const a=e.id+"-"+s;if(this.savingLottiePreview[a])return;e.stickerCachedThumbs||(Object(i.c)(e,["stickerCachedThumbs"]),e.stickerCachedThumbs={});const n=e.stickerCachedThumbs[s];n&&n.w>=t.width&&n.h>=t.height||(this.savingLottiePreview[a]=!0,t.toBlob(i=>{const n={url:URL.createObjectURL(i),w:t.width,h:t.height};e.stickerCachedThumbs[s]=n,delete this.savingLottiePreview[a]}))}saveDocFile(e,t){const s=this.downloadDoc(e,t);return s.then(()=>{const t=d.a.getCacheContext(e);d.a.createDownloadAnchor(t.url,e.file_name)}),s}};g.a.appDocsManager=v,t.a=v},68:function(e,t,s){"use strict";var a=s(29),i=s(65),n=s(32);const o=new class{constructor(){this.serverTimeOffset=0,i.a.get("server_time_offset").then(e=>{e&&(this.serverTimeOffset=e)}),n.a.addTaskListener("applyServerTimeOffset",e=>{this.serverTimeOffset=e.payload})}};a.a&&(a.a.serverTimeManager=o),t.a=o},70:function(e,t,s){"use strict";s.r(t),s.d(t,"AppProfileManager",(function(){return M}));var a=s(29),i=s(54),n=s(62),o=s(16),r=s(32),d=s(31),l=s(15),h=s(111),c=s(79),g=s(46),p=s(101),u=s(95),f=s(42),m=s(50),_=s(40),v=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};class M{constructor(){this.usersFull={},this.chatsFull={},this.fullPromises={},this.onUpdateUserTyping=e=>{var t;const s=e.user_id?e.user_id.toPeerId():f.a.getPeerId(e.from_id);if(l.default.myId===s||"speakingInGroupCallAction"===e.action._)return;const a=f.a.getPeerId(e),i=null!==(t=this.typingsInPeer[a])&&void 0!==t?t:this.typingsInPeer[a]=[];let n=i.find(e=>e.userId===s);const o=()=>{delete n.timeout;const e=i.indexOf(n);-1!==e&&i.splice(e,1),l.default.dispatchEvent("peer_typings",{peerId:a,typings:i}),i.length||delete this.typingsInPeer[a]};if(n&&void 0!==n.timeout&&clearTimeout(n.timeout),"sendMessageCancelAction"===e.action._){if(!n)return;return void o()}n||(n={userId:s},i.push(n)),n.action=e.action;const r=_.a.hasUser(s);r?_.a.forceUserOnline(s):"updateChatUserTyping"===e._&&e.chat_id&&g.a.hasChat(e.chat_id)&&!g.a.isChannel(e.chat_id)&&I.getChatFull(e.chat_id).then(()=>{void 0!==n.timeout&&_.a.hasUser(s)&&l.default.dispatchEvent("peer_typings",{peerId:a,typings:i})}),n.timeout=window.setTimeout(o,6e3),r&&l.default.dispatchEvent("peer_typings",{peerId:a,typings:i})},this.onUpdatePeerBlocked=e=>{const t=f.a.getPeerId(e.peer_id);if(f.a.isUser(t)){const s=this.usersFull[t.toUserId()];s&&(e.blocked?s.pFlags.blocked=!0:delete s.pFlags.blocked)}l.default.dispatchEvent("peer_block",{peerId:t,blocked:e.blocked})},l.default.addMultipleEventsListeners({updateChatParticipants:e=>{const t=e.participants;if("chatParticipants"===t._){const e=t.chat_id,s=this.chatsFull[e];void 0!==s&&(s.participants=t,l.default.dispatchEvent("chat_full_update",e))}},updateChatParticipantAdd:e=>{const t=this.chatsFull[e.chat_id];if(void 0!==t){const s=t.participants,a=s.participants||[];for(let t=0,s=a.length;t<s;t++)if(a[t].user_id===e.user_id)return;a.push({_:"chatParticipant",user_id:e.user_id,inviter_id:e.inviter_id,date:Object(i.g)(!0)}),s.version=e.version,l.default.dispatchEvent("chat_full_update",e.chat_id)}},updateChatParticipantDelete:e=>{const t=this.chatsFull[e.chat_id];if(void 0!==t){const s=t.participants,a=s.participants||[];for(let t=0,i=a.length;t<i;t++)if(a[t].user_id===e.user_id)return a.splice(t,1),s.version=e.version,void l.default.dispatchEvent("chat_full_update",e.chat_id)}},updateUserTyping:this.onUpdateUserTyping,updateChatUserTyping:this.onUpdateUserTyping,updateChannelUserTyping:this.onUpdateUserTyping,updatePeerBlocked:this.onUpdatePeerBlocked}),l.default.addEventListener("chat_update",e=>{var t;const s=this.chatsFull[e],a=g.a.getChat(e);if(!a.photo||!s)return;const i="chatPhotoEmpty"===a.photo._;if(s.chat_photo&&i!==("photoEmpty"===s.chat_photo._))return delete this.chatsFull[e],void l.default.dispatchEvent("chat_full_update",e);if(i)return;const n=a.photo.photo_id;(null===(t=s.chat_photo)||void 0===t?void 0:t.id)!==n&&(delete this.chatsFull[e],l.default.dispatchEvent("chat_full_update",e))}),l.default.addEventListener("invalidate_participants",e=>{this.invalidateChannelParticipants(e)}),this.typingsInPeer={}}getProfile(e,t){if(this.usersFull[e]&&!t)return Promise.resolve(this.usersFull[e]);const s=e.toPeerId(!1);return this.fullPromises[s]?this.fullPromises[s]:this.fullPromises[s]=r.a.invokeApi("users.getFullUser",{id:_.a.getUserInput(e)}).then(t=>{const a=t.user;return _.a.saveApiUser(a,!0),t.profile_photo&&(t.profile_photo=m.a.savePhoto(t.profile_photo,{type:"profilePhoto",peerId:s})),void 0!==t.about&&(t.rAbout=d.a.wrapRichText(t.about,{noLinebreaks:!0})),u.a.savePeerSettings({peerId:s,settings:t.notify_settings}),delete this.fullPromises[s],this.usersFull[e]=t})}getProfileByPeerId(e,t){return f.a.isAnyChat(e)?this.getChatFull(e.toChatId(),t):this.getProfile(e.toUserId(),t)}getFullPhoto(e){return this.getProfileByPeerId(e).then(e=>{switch(e._){case"userFull":return e.profile_photo;case"channelFull":case"chatFull":return e.chat_photo}})}getChatFull(e,t){if(g.a.isChannel(e))return this.getChannelFull(e,t);const s=this.chatsFull[e];if(s&&!t){const t=g.a.getChat(e);if(t.version===s.participants.version||t.pFlags.left)return Promise.resolve(s)}const a=e.toPeerId(!0);return void 0!==this.fullPromises[a]?this.fullPromises[a]:this.fullPromises[a]=r.a.invokeApi("messages.getFullChat",{chat_id:e}).then(t=>{g.a.saveApiChats(t.chats,!0),_.a.saveApiUsers(t.users);const s=t.full_chat;return s&&s.chat_photo&&s.chat_photo.id&&(s.chat_photo=m.a.savePhoto(s.chat_photo,{type:"profilePhoto",peerId:a})),u.a.savePeerSettings({peerId:a,settings:s.notify_settings}),delete this.fullPromises[a],this.chatsFull[e]=s,l.default.dispatchEvent("chat_full_update",e),s})}getChatInviteLink(e,t){return this.getChatFull(e).then(s=>!t&&s.exported_invite&&"chatInviteExported"==s.exported_invite._?s.exported_invite.link:r.a.invokeApi("messages.exportChatInvite",{peer:f.a.getInputPeerById(e.toPeerId(!0))}).then(t=>(void 0!==this.chatsFull[e]&&(this.chatsFull[e].exported_invite=t),t.link)))}getChannelParticipants(e,t={_:"channelParticipantsRecent"},s=200,a=0){if("channelParticipantsRecent"===t._){const t=g.a.getChat(e);if(t&&t.pFlags&&(t.pFlags.kicked||t.pFlags.broadcast&&!t.pFlags.creator&&!t.admin_rights))return Promise.reject()}return r.a.invokeApiCacheable("channels.getParticipants",{channel:g.a.getChannelInput(e),filter:t,offset:a,limit:s,hash:"0"},{cacheSeconds:60}).then(e=>(_.a.saveApiUsers(e.users),e))}getChannelParticipant(e,t){return r.a.invokeApiSingle("channels.getParticipant",{channel:g.a.getChannelInput(e),participant:f.a.getInputPeerById(t)}).then(e=>(_.a.saveApiUsers(e.users),e.participant))}getChannelFull(e,t){if(void 0!==this.chatsFull[e]&&!t)return Promise.resolve(this.chatsFull[e]);const s=e.toPeerId(!0);return void 0!==this.fullPromises[s]?this.fullPromises[s]:this.fullPromises[s]=r.a.invokeApi("channels.getFullChannel",{channel:g.a.getChannelInput(e)}).then(t=>{g.a.saveApiChats(t.chats,!0),_.a.saveApiUsers(t.users);const a=t.full_chat;return a&&a.chat_photo.id&&(a.chat_photo=m.a.savePhoto(a.chat_photo,{type:"profilePhoto",peerId:s})),u.a.savePeerSettings({peerId:s,settings:a.notify_settings}),delete this.fullPromises[s],this.chatsFull[e]=a,l.default.dispatchEvent("chat_full_update",e),a},t=>{switch(t.type){case"CHANNEL_PRIVATE":let t=g.a.getChat(e);t={_:"channelForbidden",access_hash:t.access_hash,title:t.title},c.a.processUpdateMessage({_:"updates",updates:[{_:"updateChannel",channel_id:e}],chats:[t],users:[]})}throw t})}getMentions(e,t,s){let a;return a=g.a.isChannel(e)?this.getChannelParticipants(e,{_:"channelParticipantsMentions",q:t,top_msg_id:p.a.getServerMessageId(s)},50,0).then(e=>e.participants.map(e=>g.a.getParticipantPeerId(e))):e?this.getChatFull(e).then(e=>e.participants.participants.map(e=>e.user_id.toPeerId())):Promise.resolve([]),Promise.all([_.a.getTopPeers("bots_inline").catch(()=>[]),a]).then(e=>(e=>{"@"===t.charAt(0)&&(t=t.slice(1));const s=new h.a({ignoreCase:!0}),a=new Map;e.forEach(e=>{s.indexObject(e.id,_.a.getUserSearchText(e.id)),a.set(e.id,e.rating)});const i=Array.from(s.search(t));return i.sort((e,t)=>a.get(t)-a.get(e)),i})(e[0].concat(e[1].map(e=>({id:e,rating:0})))))}invalidateChannelParticipants(e){delete this.chatsFull[e],delete this.fullPromises[e.toPeerId(!0)],r.a.clearCache("channels.getParticipants",t=>t.channel.channel_id===e),l.default.dispatchEvent("chat_full_update",e)}updateProfile(e,t,s){return r.a.invokeApi("account.updateProfile",{first_name:e,last_name:t,about:s}).then(e=>(_.a.saveApiUser(e),this.getProfile(l.default.myId,!0)))}uploadProfilePhoto(e){return r.a.invokeApi("photos.uploadProfilePhoto",{file:e}).then(e=>{_.a.saveApiUsers(e.users);const t=l.default.myId;m.a.savePhoto(e.photo,{type:"profilePhoto",peerId:t}),c.a.processLocalUpdate({_:"updateUserPhoto",user_id:t,date:Object(i.g)(!0),photo:_.a.getUser(t.toUserId()).photo,previous:!0})})}deletePhotos(e){return r.a.invokeApiSingle("photos.deletePhotos",{id:e.map(e=>{const t=m.a.getPhoto(e);return m.a.getInput(t)})}).then(e=>{})}getChatMembersString(e){var t,s;const a=g.a.getChat(e);if("chatForbidden"===a._)return Object(o.i18n)("YouWereKicked");const i=this.chatsFull[e];let r;r=i?"channelFull"===i._?i.participants_count:null===(t=i.participants.participants)||void 0===t?void 0:t.length:a.participants_count||(null===(s=a.participants)||void 0===s?void 0:s.participants.length);r=r||1;let d=g.a.isBroadcast(e)?"Peer.Status.Subscribers":"Peer.Status.Member";return Object(o.i18n)(d,[Object(n.d)(r)])}verifyParticipantForOnlineCount(e){const t=_.a.getUser(e.user_id);return!(!t||!t.status||"userStatusOnline"!==t.status._)}reduceParticipantsForOnlineCount(e){return e.reduce((e,t)=>e+ +this.verifyParticipantForOnlineCount(t),0)}getOnlines(e){var t;return v(this,void 0,void 0,(function*(){if(g.a.isBroadcast(e))return 1;const s=yield this.getChatFull(e);if(g.a.isMegagroup(e)){if(s.participants_count<=100){const t=yield this.getChannelParticipants(e,{_:"channelParticipantsRecent"},100);return this.reduceParticipantsForOnlineCount(t.participants)}const a=yield r.a.invokeApiCacheable("messages.getOnlines",{peer:g.a.getChannelInputPeer(e)},{cacheSeconds:60});return null!==(t=a.onlines)&&void 0!==t?t:1}const a=s.participants;return(null==a?void 0:a.participants)?this.reduceParticipantsForOnlineCount(a.participants):1}))}getPeerTypings(e){return this.typingsInPeer[e]}}const I=new M;a.a.appProfileManager=I,t.default=I},74:function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"b",(function(){return c})),s.d(t,"c",(function(){return g}));var a=s(43);class i{constructor(e){this.items=new Map,this.locked=!1,this.observer=new IntersectionObserver(t=>{if(this.locked)return;const s=[];t.forEach(e=>{const t=e.target;this.items.get(t)!==e.isIntersecting&&(this.items.set(t,e.isIntersecting),s[e.isIntersecting?"unshift":"push"]({target:t,visible:e.isIntersecting}))}),s.forEach(t=>{e(t.target,t.visible)})})}getVisible(){const e=[];return this.items.forEach((t,s)=>{t&&e.push(s)}),e}clearVisible(){const e=this.getVisible();for(const t of e)this.items.set(t,!1)}isVisible(e){return this.items.get(e)}disconnect(){this.observer.disconnect(),this.items.clear()}refresh(){this.observer.disconnect();const e=[...this.items.keys()];for(const t of e)this.observer.observe(t)}refreshVisible(){const e=this.getVisible();for(const t of e)this.observer.unobserve(t);for(const t of e)this.observer.observe(t)}observe(e){this.items.set(e,!1),this.observer.observe(e)}unobserve(e){this.observer.unobserve(e),this.items.delete(e)}unlock(){this.locked=!1}unlockAndRefresh(){this.unlock(),this.refresh()}lock(){this.locked=!0}}var n=s(44),o=s(127),r=function(e,t,s,a){return new(s||(s=Promise))((function(i,n){function o(e){try{d(a.next(e))}catch(e){n(e)}}function r(e){try{d(a.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,r)}d((a=a.apply(e,t||[])).next())}))};class d{constructor(e=8){this.parallelLimit=e,this.queueId=0,this.queue=[],this.inProcess=new Set,this.lockPromise=null,this.unlockResolve=null,this.log=Object(a.b)("LL",a.a.Error),this.processQueue=Object(o.a)(()=>this._processQueue(),20,!1)}clear(){this.inProcess.clear(),this.queue.length=0}lock(){this.lockPromise||(this.lockPromise=new Promise((e,t)=>{this.unlockResolve=e}))}unlock(){this.unlockResolve&&(this.unlockResolve(),this.unlockResolve=this.lockPromise=null,this.processQueue())}processItem(e){return r(this,void 0,void 0,(function*(){if(!this.lockPromise){this.inProcess.add(e);try{yield this.loadItem(e)}catch(e){["NO_ENTRY_FOUND","STORAGE_OFFLINE"].includes(e)||this.log.error("loadMediaQueue error:",e)}this.inProcess.delete(e),this.processQueue()}}))}loadItem(e){return e.load()}getItem(){return this.queue.shift()}addElement(e,t){this.queue[e](t),this.processQueue()}_processQueue(e){if(!this.queue.length||this.lockPromise||this.parallelLimit>0&&this.inProcess.size>=this.parallelLimit)return;do{if(e?Object(n.e)(this.queue,e):e=this.getItem(),!e)break;this.processItem(e),e=null}while(this.inProcess.size<this.parallelLimit&&this.queue.length)}push(e){this.addElement("push",e)}unshift(e){this.addElement("unshift",e)}}class l extends d{constructor(e=8){super(e),this.parallelLimit=e,this.queue=[],this.inProcess=new Set}lock(){super.lock(),this.intersector.lock()}unlock(){super.unlock(),this.intersector.unlock()}unlockAndRefresh(){super.unlock(),this.intersector.unlockAndRefresh()}clear(){super.clear(),this.intersector.disconnect()}refresh(){this.intersector.refresh()}loadItem(e){return e.load(e.div)}addElement(e,t){if(this.queue.find(e=>e.div===t.div&&e.load===t.load))return!1;for(const e of this.inProcess)if(e.div===t.div&&e.load===t.load)return!1;return this.queue[e](t),!0}setProcessQueueTimeout(){this.intersectorTimeout||(this.intersectorTimeout=window.setTimeout(()=>{this.intersectorTimeout=0,this.processQueue()},0))}push(e){super.push(e)}unshift(e){super.unshift(e)}unobserve(e){Object(n.c)(this.queue,t=>t.div===e),this.intersector.unobserve(e)}}class h extends l{constructor(e=8){super(e),this.parallelLimit=e,this.onVisibilityChange=(e,t)=>{t&&(Object(n.c)(this.queue,t=>t.div===e).forEach(e=>{e.wasSeen=!0,this.queue.unshift(e)}),this.setProcessQueueTimeout())},this.intersector=new i(this.onVisibilityChange)}getItem(){return this.queue.findAndSplice(e=>e.wasSeen)}processItem(e){const t=Object.create(null,{processItem:{get:()=>super.processItem}});return r(this,void 0,void 0,(function*(){yield t.processItem.call(this,e),this.intersector.unobserve(e.div)}))}addElement(e,t){return!!super.addElement(e,t)&&(this.intersector.observe(t.div),t.hasOwnProperty("wasSeen")||(t.wasSeen=!1),!0)}}class c extends l{constructor(e=8,t){super(e),this.parallelLimit=e,this.onVisibilityChange=t,this._queue=new Map,this.intersector=new i((e,t)=>{const s=Object(n.c)(this.queue,t=>t.div===e);if(t){(s.length?s:[this._queue.get(e)]).forEach(t=>{this.queue.unshift(t||this._queue.get(e))})}this.onVisibilityChange&&this.onVisibilityChange(e,t),this.setProcessQueueTimeout()})}clear(){super.clear(),this._queue.clear()}observe(e){this._queue.set(e.div,e),this.intersector.observe(e.div)}}class g extends l{constructor(e=8,t){super(e),this.parallelLimit=e,this.onVisibilityChange=t,this.intersector=new i((e,t)=>{const s=Object(n.c)(this.queue,t=>t.div===e);t&&s.length&&s.forEach(e=>{this.queue.unshift(e)}),this.onVisibilityChange&&this.onVisibilityChange(e,t),this.setProcessQueueTimeout()})}observe(e){this.intersector.observe(e)}}},75:function(e,t,s){"use strict";function a(e){const t=e.length,s=new Array(t);for(let a=0;a<t;++a)s[a]=(e[a]<16?"0":"")+(e[a]||0).toString(16);return s.join("")}function i(e){const t=e.length,s=new Uint8Array(Math.ceil(t/2));let a=0;t%2&&(s[a++]=parseInt(e.charAt(0),16));for(let i=a;i<t;i+=2)s[a++]=parseInt(e.substr(i,2),16);return s}function n(e){let t,s="";for(let a=e.length,i=0,n=0;n<a;++n)t=n%3,i|=e[n]<<(16>>>t&24),2!==t&&a-n!=1||(s+=String.fromCharCode(o(i>>>18&63),o(i>>>12&63),o(i>>>6&63),o(63&i)),i=0);return s.replace(/A(?=A$|$)/g,"=")}function o(e){return e<26?e+65:e<52?e+71:e<62?e-4:62===e?43:63===e?47:65}function r(e,t){const s=e.length;if(s!==t.length)return!1;for(let a=0;a<s;++a)if(e[a]!==t[a])return!1;return!0}function d(...e){const t=e.reduce((e,t)=>e+(t.byteLength||t.length),0),s=new Uint8Array(t);let a=0;return e.forEach(e=>{s.set(e instanceof ArrayBuffer?new Uint8Array(e):e,a),a+=e.byteLength||e.length}),s}s.d(t,"e",(function(){return a})),s.d(t,"c",(function(){return i})),s.d(t,"d",(function(){return n})),s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return d}))},79:function(e,t,s){"use strict";var a=s(29),i=s(43),n=s(32),o=s(15),r=s(40),d=s(46),l=s(42),h=s(17),c=s(68),g=s(107),p=s(104),u=s(31),f=s(8);const m=new class{constructor(){this.updatesState={pendingPtsUpdates:[],pendingSeqUpdates:{},syncPending:null,syncLoading:null},this.channelStates={},this.attached=!1,this.log=Object(i.b)("UPDATES",i.a.Error|i.a.Warn|i.a.Log),this.debug=a.b,this.processUpdateMessage=(e,t={})=>{const s={date:e.date,seq:e.seq,seqStart:e.seq_start};switch(this.debug&&this.log.debug("processUpdateMessage",e),e._){case"updatesTooLong":case"new_session_created":this.forceGetDifference();break;case"updateShort":this.processUpdate(e.update,s);break;case"updateShortMessage":case"updateShortChatMessage":{Object(g.a)(e),this.debug&&this.log.debug("updateShortMessage | updateShortChatMessage",Object.assign({},e));const t=e.pFlags.out,a=e.from_id||(t?o.default.myId:e.user_id),i=e.chat_id?e.chat_id.toPeerId(!0):e.user_id.toPeerId(!1)||o.default.myId;this.processUpdate({_:"updateNewMessage",message:{_:"message",pFlags:e.pFlags,id:e.id,from_id:l.a.getOutputPeer(a.toPeerId()),peer_id:l.a.getOutputPeer(i),date:e.date,message:e.message,fwd_from:e.fwd_from,reply_to:e.reply_to,entities:e.entities},pts:e.pts,pts_count:e.pts_count},s);break}case"updatesCombined":case"updates":r.a.saveApiUsers(e.users,t.override),d.a.saveApiChats(e.chats,t.override),e.updates.forEach(e=>{this.processUpdate(e,s)});break;default:this.log.warn("Unknown update message",e)}}}setProxy(){const e=this;this.updatesState=new Proxy(this.updatesState,{set:function(t,s,a){return t[s]=a,e.saveUpdatesState(),!0}})}saveUpdatesState(){const e=this.updatesState;h.default.pushToState("updates",{seq:e.seq,pts:e.pts,date:e.date})}popPendingSeqUpdate(){const e=this.updatesState,t=e.seq+1,s=e.pendingSeqUpdates[t];if(!s)return!1;const a=s.updates;for(let e=0,t=a.length;e<t;++e)this.saveUpdate(a[e]);return e.seq=s.seq,s.date&&e.date<s.date&&(e.date=s.date),delete e.pendingSeqUpdates[t],!this.popPendingSeqUpdate()&&e.syncPending&&e.syncPending.seqAwaiting&&e.seq>=e.syncPending.seqAwaiting&&(e.syncPending.ptsAwaiting?delete e.syncPending.seqAwaiting:(clearTimeout(e.syncPending.timeout),e.syncPending=null)),!0}popPendingPtsUpdate(e){const t=e?this.getChannelState(e):this.updatesState;if(!t.pendingPtsUpdates.length)return!1;t.pendingPtsUpdates.sort((e,t)=>e.pts-t.pts);let s=t.pts,a=0,i=0;for(let e=0,n=t.pendingPtsUpdates.length;e<n;++e){const n=t.pendingPtsUpdates[e];s+=n.pts_count,s>=n.pts&&(a=n.pts,i=e)}if(!a)return!1;this.debug&&this.log.debug("pop pending pts updates",a,t.pendingPtsUpdates.slice(0,i+1)),t.pts=a;for(let e=0;e<=i;++e){const s=t.pendingPtsUpdates[e];this.saveUpdate(s)}return t.pendingPtsUpdates.splice(0,i+1),!t.pendingPtsUpdates.length&&t.syncPending&&(t.syncPending.seqAwaiting?delete t.syncPending.ptsAwaiting:(clearTimeout(t.syncPending.timeout),t.syncPending=null)),!0}forceGetDifference(){this.updatesState.syncLoading||this.getDifference()}processLocalUpdate(e){this.processUpdateMessage({_:"updateShort",update:e})}getDifference(e=!1){const t=this.updatesState;let s=t.syncLoading;s||(t.pendingSeqUpdates={},t.pendingPtsUpdates=[]),t.syncPending&&(clearTimeout(t.syncPending.timeout),t.syncPending=null);const a=n.a.invokeApi("updates.getDifference",{pts:t.pts,pts_total_limit:e?1200:void 0,date:t.date,qts:-1},{timeout:2147483647}).then(s=>{if(this.debug&&this.log.debug("Get diff result",s),"updates.differenceEmpty"===s._)return this.debug&&this.log.debug("apply empty diff",s.seq),t.date=s.date,void(t.seq=s.seq);if(e&&o.default.dispatchEvent("state_synchronizing"),"updates.differenceTooLong"!==s._){r.a.saveApiUsers(s.users),d.a.saveApiChats(s.chats),s.other_updates.forEach(e=>{switch(e._){case"updateChannelTooLong":case"updateNewChannelMessage":case"updateEditChannelMessage":return void this.processUpdate(e)}this.saveUpdate(e)}),s.new_messages.forEach(e=>{this.saveUpdate({_:"updateNewMessage",message:e,pts:t.pts,pts_count:0})});const e="updates.difference"===s._?s.state:s.intermediate_state;t.seq=e.seq,t.pts=e.pts,t.date=e.date}else t.pts=s.pts,t.date=(Date.now()/1e3|0)+c.a.serverTimeOffset,delete t.seq,this.channelStates={},this.log.warn("getDifference:",s._),o.default.dispatchEvent("state_cleared");if("updates.differenceSlice"===s._)return this.getDifference();this.debug&&this.log.debug("finished get diff")});return s||this.justAName(t,a),a}getChannelDifference(e){const t=this.getChannelState(e),s=t.syncLoading;s||(t.pendingPtsUpdates=[]),t.syncPending&&(clearTimeout(t.syncPending.timeout),t.syncPending=null);const a=n.a.invokeApi("updates.getChannelDifference",{channel:d.a.getChannelInput(e),filter:{_:"channelMessagesFilterEmpty"},pts:t.pts,limit:30},{timeout:2147483647}).then(s=>{if(this.debug&&this.log.debug("Get channel diff result",s),t.pts="pts"in s?s.pts:void 0,"updates.channelDifferenceEmpty"!==s._){if("updates.channelDifferenceTooLong"===s._)return this.debug&&this.log.debug("channel diff too long",s),delete this.channelStates[e],void this.saveUpdate({_:"updateChannelReload",channel_id:e});if(r.a.saveApiUsers(s.users),d.a.saveApiChats(s.chats),this.debug&&this.log.debug("applying",s.other_updates.length,"channel other updates"),s.other_updates.forEach(e=>{this.saveUpdate(e)}),this.debug&&this.log.debug("applying",s.new_messages.length,"channel new messages"),s.new_messages.forEach(e=>{this.saveUpdate({_:"updateNewChannelMessage",message:e,pts:t.pts,pts_count:0})}),this.debug&&this.log.debug("apply channel diff",t.pts),"updates.channelDifference"===s._&&!s.pFlags.final)return this.getChannelDifference(e);this.debug&&this.log.debug("finished channel get diff")}else this.debug&&this.log.debug("apply channel empty diff",s)});return s||this.justAName(t,a,e),a}justAName(e,t,s){e.syncLoading=t,o.default.dispatchEvent("state_synchronizing",s),t.then(()=>{e.syncLoading=null,o.default.dispatchEvent("state_synchronized",s)},()=>{e.syncLoading=null})}addChannelState(e,t){if(!t)throw new Error("Add channel state without pts "+e);return!(e in this.channelStates)&&(this.channelStates[e]={pts:t,pendingPtsUpdates:[],syncPending:null,syncLoading:null},!0)}getChannelState(e,t){return void 0===this.channelStates[e]&&this.addChannelState(e,t),this.channelStates[e]}processUpdate(e,t={}){var s;let a;switch(e._){case"updateNewChannelMessage":case"updateEditChannelMessage":a=l.a.getPeerId(e.message.peer_id).toChatId();break;case"updateChannelTooLong":if(a=e.channel_id,!(a in this.channelStates))return!1;break;default:"channel_id"in e&&"pts"in e&&(a=e.channel_id)}const{pts:i,pts_count:n}=e,o=a?this.getChannelState(a,i):this.updatesState;if(o.syncLoading)return!1;if("updateChannelTooLong"===e._)return(!o.lastPtsUpdateTime||o.lastPtsUpdateTime<Date.now()-6)&&this.getChannelDifference(a),!1;if("updateNewMessage"===e._||"updateEditMessage"===e._||"updateNewChannelMessage"===e._||"updateEditChannelMessage"===e._){const t=e.message,i=l.a.getPeerId(t.peer_id),n=t.fwd_from||{};let o;if(t.from_id&&!r.a.hasUser(l.a.getPeerId(t.from_id),t.pFlags.post)&&(o="author")||n.from_id&&!r.a.hasUser(l.a.getPeerId(n.from_id),!!n.from_id.channel_id)&&(o="fwdAuthor")||(null===(s=n.from_id)||void 0===s?void 0:s.channel_id)&&!d.a.hasChat(n.from_id.channel_id,!0)&&(o="fwdChannel")||i.isUser()&&!r.a.hasUser(i)&&(o="toPeer User")||i.isAnyChat()&&!d.a.hasChat(i.toChatId())&&(o="toPeer Chat"))return this.log.warn("Not enough data for message update",i,o,t),a&&d.a.hasChat(a)?this.getChannelDifference(a):this.forceGetDifference(),!1}else if(a&&!d.a.hasChat(a))return!1;let h,c;if(i){if(o.pts+(n||0)<i)return this.debug&&this.log.warn("Pts hole",o,e,a&&d.a.getChat(a)),o.pendingPtsUpdates.push(e),o.syncPending||o.syncLoading||(o.syncPending={timeout:window.setTimeout(()=>{o.syncPending=null,o.syncLoading||(a?this.getChannelDifference(a):this.getDifference())},6)}),o.syncPending.ptsAwaiting=!0,!1;if(i>o.pts)o.pts=i,h=!0,o.lastPtsUpdateTime=Date.now();else if(n)return!1;a&&t.date&&this.updatesState.date<t.date&&(this.updatesState.date=t.date)}else if(!a&&t.seq>0){const s=t.seq,a=t.seqStart||s;if(a!==o.seq+1&&a>o.seq)return this.debug&&this.log.warn("Seq hole",o,o.syncPending&&o.syncPending.seqAwaiting),void 0===o.pendingSeqUpdates[a]&&(o.pendingSeqUpdates[a]={seq:s,date:t.date,updates:[]}),o.pendingSeqUpdates[a].updates.push(e),o.syncPending||(o.syncPending={timeout:window.setTimeout(()=>{o.syncPending=null,o.syncLoading||this.getDifference()},6)}),(!o.syncPending.seqAwaiting||o.syncPending.seqAwaiting<a)&&(o.syncPending.seqAwaiting=a),!1;o.seq!==s&&(o.seq=s,t.date&&o.date<t.date&&(o.date=t.date),c=!0)}this.saveUpdate(e),h?this.popPendingPtsUpdate(a):c&&this.popPendingSeqUpdate()}saveUpdate(e){o.default.dispatchEvent(e._,e)}attach(){this.attached||(this.log("attach"),this.attached=!0,h.default.getState().then(({updates:e})=>{const t=h.default.newVersion;e&&e.pts&&e.date?(Object.assign(this.updatesState,e),this.log("will get difference",Object.assign({},e)),this.getDifference(!0)):(this.log("will get new state"),this.updatesState.syncLoading=new Promise(e=>{n.a.invokeApi("updates.getState",{},{noErrorBox:!0}).then(t=>{this.updatesState.seq=t.seq,this.updatesState.pts=t.pts,this.updatesState.date=t.date,this.saveUpdatesState(),this.updatesState.syncLoading=null,e()})})),n.a.setUpdatesProcessor(this.processUpdateMessage),this.setProxy(),t&&this.updatesState.syncLoading.then(()=>{fetch("changelogs/"+t+".md").then(e=>200===e.status&&e.ok&&e.text()||Promise.reject()).then(e=>{e=`**Telegram Web${f.a.suffix} was updated to version alpha ${t}**\n\n`+e;const s=[],a={_:"updateServiceNotification",entities:s,message:u.b.parseMarkdown(e,s),type:"local",pFlags:{},inbox_date:Date.now()/1e3|0,media:void 0};this.processLocalUpdate(a)}).catch(p.a)})}))}};a.a.apiUpdatesManager=m,t.a=m},94:function(e,t,s){"use strict";function a(e){const t=document.createElement("span");return t.innerHTML=e,t}s.d(t,"a",(function(){return a}))},95:function(e,t,s){"use strict";var a=s(112),i=s(29),n=s(45),o=s(54),r=s(34),d=s(77),l=s(0),h=s(16),c=s(32),g=s(26),p=s(15),u=s(80),f=s(79),m=s(46),_=s(42),v=s(128),M=s(17),I=s(40);const y=new class{constructor(){this.notificationsShown={},this.notificationIndex=0,this.notificationsCount=0,this.soundsPlayed={},this.vibrateSupport=!!navigator.vibrate,this.peerSettings={notifyPeer:{},notifyUsers:null,notifyChats:null,notifyBroadcasts:null},this.faviconEl=document.head.querySelector('link[rel="icon"]'),this.titleBackup=document.title,this.titleChanged=!1,this.stopped=!1,this.settings={},this.pushInited=!1,this.updateLocalSettings=()=>{Promise.all(["notify_nodesktop","notify_volume","notify_novibrate","notify_nopreview","notify_nopush"].map(e=>u.a.get(e))).then(e=>{if(this.settings.nodesktop=e[0],this.settings.volume=void 0===e[1]?.5:e[1],this.settings.novibrate=e[2],this.settings.nopreview=e[3],this.settings.nopush=e[4],this.pushInited){const e=!this.settings.nopush&&!this.settings.nodesktop&&g.default.isAvailable||!1;e!==(!1!==this.registeredDevice)&&(e?g.default.subscribe():g.default.unsubscribe())}g.default.setSettings(this.settings)}),M.default.getState().then(e=>{this.settings.nosound=!e.settings.notifications.sound})},this.requestPermission=()=>{Notification.requestPermission(),window.removeEventListener("click",this.requestPermission)},navigator.vibrate=navigator.vibrate||navigator.mozVibrate||navigator.webkitVibrate,this.notificationsUiSupport="Notification"in window||"mozNotification"in navigator,this.topMessagesDeferred=Object(n.a)(),this.notifySoundEl=document.createElement("div"),this.notifySoundEl.id="notify-sound",document.body.append(this.notifySoundEl),p.default.addEventListener("instance_deactivated",()=>{this.stop()}),p.default.addEventListener("instance_activated",()=>{this.stopped&&this.start()}),p.default.addEventListener("idle",e=>{this.stopped||(e||this.clear(),this.toggleToggler())}),p.default.addMultipleEventsListeners({updateNotifySettings:e=>{const t="notifyPeer"===e.peer._&&_.a.getPeerId(e.peer.peer),s="notifyPeer"!==e.peer._?e.peer._:void 0;this.savePeerSettings({key:s,peerId:t,settings:e.notify_settings}),p.default.dispatchEvent("notify_settings",e)}}),p.default.addEventListener("push_init",e=>{this.pushInited=!0,this.settings.nodesktop||this.settings.nopush?this.unregisterDevice(e):e?this.registerDevice(e):g.default.subscribe()}),p.default.addEventListener("push_subscribe",e=>{this.registerDevice(e)}),p.default.addEventListener("push_unsubscribe",e=>{this.unregisterDevice(e)}),p.default.addEventListener("dialogs_multiupdate",()=>{this.topMessagesDeferred.resolve()},{once:!0}),p.default.addEventListener("push_notification_click",e=>{if("push_settings"===e.action)return;if("mute1d"===e.action)return void c.a.invokeApi("account.updateDeviceLocked",{period:86400}).then(()=>{});const t=e.custom&&e.custom.peerId.toPeerId();console.log("click",e,t),t&&this.topMessagesDeferred.then(()=>{e.custom.channel_id&&!m.a.hasChat(e.custom.channel_id)||t.isUser()&&!I.a.hasUser(t)||p.default.dispatchEvent("history_focus",{peerId:t,mid:+e.custom.msg_id})})})}toggleToggler(e=p.default.idle.isIDLE){if(l.IS_MOBILE)return;const t=()=>{this.titleChanged=!1,document.title=this.titleBackup,this.setFavicon()};window.clearInterval(this.titleInterval),this.titleInterval=0,e?this.titleInterval=window.setInterval(()=>{const e=this.notificationsCount;if(e)if(this.titleChanged)t();else{this.titleChanged=!0,document.title=h.default.format("Notifications.Count",!0,[e]);const t=document.createElement("canvas");t.width=32*window.devicePixelRatio,t.height=t.width;const s=t.getContext("2d");s.beginPath(),s.arc(t.width/2,t.height/2,t.width/2,0,2*Math.PI,!1),s.fillStyle="#3390ec",s.fill();let i=24,n=""+e;e<10?i=22:e<100?i=20:(n="99+",i=16),i*=window.devicePixelRatio,s.font=`700 ${i}px ${a.b}`,s.textBaseline="middle",s.textAlign="center",s.fillStyle="white",s.fillText(n,t.width/2,.5625*t.height),this.setFavicon(t.toDataURL())}else this.toggleToggler(!1)},1e3):t()}getLocalSettings(){return this.settings}getNotifySettings(e){let t,s=Object(d.b)(e._),a=this.peerSettings[s];return"inputNotifyPeer"===e._&&(t=s=_.a.getPeerId(e.peer),a=a[s]),a||((a||this.peerSettings)[s]=c.a.invokeApi("account.getNotifySettings",{peer:e}).then(e=>(this.savePeerSettings({key:s,peerId:t,settings:e}),e)))}getNotifyPeerTypeSettings(){if(this.getNotifyPeerTypePromise)return this.getNotifyPeerTypePromise;const e=["inputNotifyBroadcasts","inputNotifyUsers","inputNotifyChats"].map(e=>this.getNotifySettings({_:e}));return this.getNotifyPeerTypePromise=Promise.all(e)}updateNotifySettings(e,t){return c.a.invokeApi("account.updateNotifySettings",{peer:e,settings:t}).then(s=>{s&&f.a.processLocalUpdate({_:"updateNotifySettings",peer:Object.assign(Object.assign({},e),{_:Object(d.b)(e._)}),notify_settings:Object.assign(Object.assign({},t),{_:"peerNotifySettings"})})})}getNotifyExceptions(){c.a.invokeApi("account.getNotifyExceptions",{compare_sound:!0}).then(e=>{f.a.processUpdateMessage(e)})}getContactSignUpNotification(){return this.notifyContactsSignUp?this.notifyContactsSignUp:this.notifyContactsSignUp=c.a.invokeApi("account.getContactSignUpNotification")}setContactSignUpNotification(e){c.a.invokeApi("account.setContactSignUpNotification",{silent:e}).then(t=>{this.notifyContactsSignUp=Promise.resolve(!e)})}setFavicon(e="assets/img/favicon.ico"){if(this.prevFavicon===e)return;const t=this.faviconEl.cloneNode();t.href=e,this.faviconEl.parentNode.replaceChild(t,this.faviconEl),this.faviconEl=t,this.prevFavicon=e}savePeerSettings({key:e,peerId:t,settings:s}){let a;t&&(e=t,a=this.peerSettings.notifyPeer),(a||this.peerSettings)[e]=s,t||p.default.dispatchEvent("notify_peer_type_settings",{key:e,settings:s})}isMuted(e){return"peerNotifySettings"===e._&&(1e3*e.mute_until>Object(o.g)()||e.silent)}getPeerMuted(e){const t=this.getNotifySettings({_:"inputNotifyPeer",peer:_.a.getInputPeerById(e)});return(t instanceof Promise?t:Promise.resolve(t)).then(e=>this.isMuted(e))}getPeerLocalSettings(e,t=!0){const s={_:"peerNotifySettings"},a=this.peerSettings.notifyPeer[e];if(!a||a instanceof Promise||Object.assign(s,a),t){const t=_.a.getInputNotifyPeerById(e,!0),a=Object(d.b)(t._),i=this.peerSettings[a];if(i&&!(i instanceof Promise))for(let e in i)void 0===s[e]&&(s[e]=i[e])}return s}isPeerLocalMuted(e,t=!0){if(e===p.default.myId)return!1;const s=this.getPeerLocalSettings(e,t);return this.isMuted(s)}start(){if(this.updateLocalSettings(),p.default.addEventListener("settings_updated",this.updateLocalSettings),g.default.start(),!this.notificationsUiSupport)return!1;"Notification"in window&&"granted"!==Notification.permission&&"denied"!==Notification.permission&&window.addEventListener("click",this.requestPermission);try{"onbeforeunload"in window&&window.addEventListener("beforeunload",this.clear)}catch(e){}}stop(){this.clear(),window.clearInterval(this.titleInterval),this.titleInterval=0,this.setFavicon(),this.stopped=!0}notify(e){if(this.stopped)return;e.image||(e.image="assets/img/logo_filled_rounded.png"),this.notificationsCount++,this.titleInterval||this.toggleToggler();const t=++this.notificationIndex,s=e.key||"k"+t;this.notificationsShown[s]=!0;const a=Object(o.g)();if(this.settings.volume>0&&!this.settings.nosound&&(this.testSound(this.settings.volume),this.soundsPlayed[e.tag]=a),!this.notificationsUiSupport||"Notification"in window&&"granted"!==Notification.permission)return!1;if(this.settings.nodesktop)return this.vibrateSupport&&!this.settings.novibrate?void navigator.vibrate([200,100,200]):void 0;let i;if("Notification"in window){try{if(e.tag)for(let t in this.notificationsShown){const s=this.notificationsShown[t];"boolean"!=typeof s&&s.tag===e.tag&&(s.hidden=!0)}i=new Notification(e.title,{icon:e.image||"",body:e.message||"",tag:e.tag||"",silent:e.silent||!1})}catch(e){return this.notificationsUiSupport=!1,void g.default.setLocalNotificationsDisabled()}i.onclick=()=>{i.close(),v.a.focus(),this.clear(),e.onclick&&e.onclick()},i.onclose=()=>{i.hidden||(delete this.notificationsShown[s],this.clear())},i.show&&i.show(),this.notificationsShown[s]=i,l.IS_MOBILE||setTimeout(()=>{this.hide(s)},8e3)}}testSound(e){const t=Object(o.g)();if(this.nextSoundAt&&t<this.nextSoundAt&&this.prevSoundVolume===e)return;this.nextSoundAt=t+1e3,this.prevSoundVolume=e;const s="assets/audio/notification.mp3",a=document.createElement("audio");a.autoplay=!0,a.setAttribute("mozaudiochannel","notification"),a.volume=e,a.innerHTML=`\n      <source src="${s}" type="audio/mpeg" />\n      <embed hidden="true" autostart="true" loop="false" volume="${100*e}" src="${s}" />\n    `,this.notifySoundEl.append(a),a.addEventListener("ended",()=>{a.remove()},{once:!0})}cancel(e){const t=this.notificationsShown[e];if(t){this.notificationsCount>0&&--this.notificationsCount;try{"boolean"!=typeof t&&t.close&&(t.hidden=!0,t.close())}catch(e){}delete this.notificationsShown[e]}}hide(e){const t=this.notificationsShown[e];if(t&&"boolean"!=typeof t)try{t.close&&(t.hidden=!0,t.close())}catch(e){}}soundReset(e){delete this.soundsPlayed[e]}clear(){for(const e in this.notificationsShown){const t=this.notificationsShown[e];try{"boolean"!=typeof t&&t.close&&t.close()}catch(e){}}this.notificationsShown={},this.notificationsCount=0,g.default.hidePushNotifications()}registerDevice(e){if(this.registeredDevice&&Object(r.b)(this.registeredDevice,e))return!1;c.a.invokeApi("account.registerDevice",{token_type:e.tokenType,token:e.tokenValue,other_uids:[],app_sandbox:!1,secret:new Uint8Array}).then(()=>{this.registeredDevice=e},e=>{e.handled=!0})}unregisterDevice(e){if(!this.registeredDevice)return!1;c.a.invokeApi("account.unregisterDevice",{token_type:e.tokenType,token:e.tokenValue,other_uids:[]}).then(()=>{this.registeredDevice=!1},e=>{e.handled=!0})}getVibrateSupport(){return this.vibrateSupport}};i.a.appNotificationsManager=y,t.a=y},96:function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return o}));const a={},i=(e,t)=>{e instanceof HTMLImageElement||e instanceof HTMLVideoElement?e.src=t:e instanceof SVGImageElement?e.setAttributeNS(null,"href",t):e.style.backgroundImage="url("+t+")"};function n(e,t,s,n=!0){if(!t)return console.error("renderImageFromUrl: no url?",e,t),void(s&&s());if(a[t]&&n||e instanceof HTMLVideoElement)e&&i(e,t),s&&s();else{const n=e instanceof HTMLImageElement,o=n?e:new Image;o.src=t,o.addEventListener("load",()=>{!n&&e&&i(e,t),a[t]=!0,s&&s()},{once:!0}),s&&o.addEventListener("error",s)}}function o(e,t,s){return new Promise(a=>{n(e,t,a,s)})}},97:function(e,t,s){"use strict";const a=new class{constructor(){this.windowW=0,this.windowH=0;const e="visualViewport"in window?window.visualViewport:window,t=()=>{this.windowW=e.width||e.innerWidth,this.windowH=e.height||e.innerHeight};e.addEventListener("resize",t),t()}};t.a=a}}]);
//# sourceMappingURL=6.bd09757604b3ce4c31ec.chunk.js.map