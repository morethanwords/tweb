{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/config/debug.ts","webpack:///./src/config/modes.ts","webpack:///./src/lib/logger.ts","webpack:///./src/lib/serviceWorker/cache.ts","webpack:///./src/helpers/context.ts","webpack:///./src/helpers/userAgent.ts","webpack:///./src/lib/serviceWorker/stream.ts","webpack:///./src/lib/serviceWorker/timeout.ts","webpack:///./src/helpers/cancellablePromise.ts","webpack:///./src/lib/serviceWorker/index.service.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","DEBUG","test","location","search","indexOf","debug","http","ssl","multipleConnections","asServiceWorker","window","self","LogTypes","LOG_LEVELS","None","Error","Warn","Log","Debug","_logTimer","Date","now","dT","toFixed","isCorrectResponse","response","ok","status","isWebWorker","WorkerGlobalScope","isServiceWorker","ServiceWorkerGlobalScope","notifyServiceWorker","all","args","clients","matchAll","includeUncontrolled","type","then","listeners","length","slice","forEach","listener","postMessage","notifyWorker","noop","notifySomeone","userAgent","navigator","toLowerCase","vendor","isSafari","platform","maxTouchPoints","MSStream","match","onStreamFetch","event","params","range","header","chunks","split","ranges","offset","end","parseRange","request","headers","info","JSON","parse","decodeURIComponent","limitPart","size","STREAM_CHUNK_UPPER_LIMIT","STREAM_CHUNK_MIDDLE_LIMIT","delay","respondWith","Promise","race","resolve","setTimeout","Response","statusText","reject","possibleResponse","mimeType","Uint8Array","buffer","responseForSafariFirstRange","limit","Math","ceil","log","alignLimit","alignedOffset","base","alignOffset","task","id","incrementTaskId","payload","dcId","deferredPromises","deferredHelper","isFulfilled","isRejected","notify","notifyAll","lastNotify","callback","undefined","addNotifyListener","push","deferred","finally","cancel","assign","deferredPromise","result","ab","bytes","byteLength","catch","err","prefix","console","warn","error","trace","setPrefix","_prefix","setLevel","level","reduce","acc","v","logger","taskListeners","notifications_clear","ping","requestFilePart","promise","addEventListener","e","data","taskId","getTaskId","onFetch","url","origin","cache","caches","open","file","ignoreVary","fetch","put","clone","replace","random","requestCache","scope","exec","onChangeState","onfetch","waitUntil","skipWaiting","delete","claim","onerror","onunhandledrejection","onoffline","ononline"],"mappings":"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","file":"sw.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport Modes from \"./modes\";\n\nexport const DEBUG = process.env.NODE_ENV !== 'production' || Modes.debug;\nconst ctx: any = typeof(window) !== 'undefined' ? window : self;\nexport const MOUNT_CLASS_TO: any = DEBUG || true/*  && false */ ? ctx : {};\nexport default DEBUG;\n\n//let m = DEBUG;\n/* if(!DEBUG) {\n  ctx.sandpitTurtle = () => {\n    //if(!m) {\n      for(let i in MOUNT_CLASS_TO) {\n        ctx[i] = MOUNT_CLASS_TO[i];\n      }\n      //m = true;\n    //}\n  \n    //DEBUG = !DEBUG;\n  };\n} */\n\n/* export const superDebug = (object: any, key: string) => {\n  var d = object[key];\n  var beforeStr = '', afterStr = '';\n  for(var r of d) {\n    beforeStr += r.before.hex + '\\n';\n    afterStr += r.after.hex + '\\n';\n  }\n\n  beforeStr = beforeStr.trim();\n  afterStr = afterStr.trim();\n  //var beforeStr = d.map(r => r.before.hex).join('\\n');\n  //var afterStr = d.map(r => r.after.hex).join('\\n');\n\n  var dada = (name: string, str: string) => {\n    var a = document.createElement('a');\n    a.target = '_blank';\n    a.download = name + '.txt';\n    a.href = URL.createObjectURL(new Blob([str], {\n      type: 'text/plain'\n    }));\n    document.body.append(a);\n    a.click();\n  };\n\n  dada(key + '_' + 'before', beforeStr);\n  dada(key + '_' + 'after', afterStr);\n}\n\nMOUNT_CLASS_TO.superDebug = superDebug; */\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n * \n * Originally from:\n * https://github.com/zhukov/webogram\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\n * https://github.com/zhukov/webogram/blob/master/LICENSE\n */\n\nconst Modes = {\n  test: location.search.indexOf('test=1') > 0/*  || true */,\n  debug: location.search.indexOf('debug=1') > 0,\n  http: false, //location.search.indexOf('http=1') > 0,\n  ssl: true, // location.search.indexOf('ssl=1') > 0 || location.protocol === 'https:' && location.search.indexOf('ssl=0') === -1,\n  multipleConnections: true,\n  asServiceWorker: false\n};\n\n                  \n                             \n          \n\nexport default Modes;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport DEBUG from \"../config/debug\";\n\nexport enum LogTypes {\n  None = 0,\n  Error = 1,\n  Warn = 2,\n  Log = 4,\n  Debug = 8\n};\n\nexport const LOG_LEVELS = [LogTypes.None, LogTypes.Error, LogTypes.Warn, LogTypes.Log, LogTypes.Debug];\n\nconst _logTimer = Date.now();\nfunction dT() {\n  return '[' + ((Date.now() - _logTimer) / 1000).toFixed(3) + ']';\n}\n\nexport function logger(prefix: string, type: LogTypes = LogTypes.Log | LogTypes.Warn | LogTypes.Error) {\n  if(!DEBUG/*  || true */) {\n    type = LogTypes.Error;\n  }\n\n  //level = LogLevels.log | LogLevels.warn | LogLevels.error | LogLevels.debug\n\n  function Log(...args: any[]) {\n    return type & LogTypes.Log && console.log(dT(), prefix, ...args);\n  }\n  \n  Log.warn = function(...args: any[]) {\n    return type & LogTypes.Warn && console.warn(dT(), prefix, ...args);\n  };\n  \n  Log.info = function(...args: any[]) {\n    return type & LogTypes.Log && console.info(dT(), prefix, ...args);\n  };\n  \n  Log.error = function(...args: any[]) {\n    return type & LogTypes.Error && console.error(dT(), prefix, ...args);\n  };\n  \n  Log.trace = function(...args: any[]) {\n    return type & LogTypes.Log && console.trace(dT(), prefix, ...args);\n  };\n\n  /* Log.debug = function(...args: any[]) {\n    return level & LogLevels.debug && console.log(dT(), prefix, ...args);\n  }; */\n\n  Log.debug = function(...args: any[]) {\n    return type & LogTypes.Debug && console.debug(dT(), prefix, ...args);\n  };\n\n  Log.setPrefix = function(_prefix: string) {\n    prefix = '[' + _prefix + ']:';\n  };\n\n  Log.setPrefix(prefix);\n\n  Log.setLevel = function(level: 0 | 1 | 2 | 3 | 4) {\n    type = LOG_LEVELS.slice(0, level + 1).reduce((acc, v) => acc | v, 0) as any;\n  };\n  \n  return Log;\n};\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nconst ctx = self as any as ServiceWorkerGlobalScope;\nexport const CACHE_ASSETS_NAME = 'cachedAssets';\n\nfunction isCorrectResponse(response: Response) {\n  return response.ok && response.status === 200;\n}\n\nexport async function requestCache(event: FetchEvent) {\n  try {\n    const cache = await ctx.caches.open(CACHE_ASSETS_NAME);\n    const file = await cache.match(event.request, {ignoreVary: true});\n  \n    if(file && isCorrectResponse(file)) {\n      return file;\n    }\n  \n    const headers: HeadersInit = {'Vary': '*'};\n    let response = await fetch(event.request, {headers});\n    if(isCorrectResponse(response)) {\n      cache.put(event.request, response.clone());\n    } else if(response.status === 304) { // possible fix for 304 in Safari\n      const url = event.request.url.replace(/\\?.+$/, '') + '?' + (Math.random() * 100000 | 0);\n      response = await fetch(url, {headers});\n      if(isCorrectResponse(response)) {\n        cache.put(event.request, response.clone());\n      }\n    }\n  \n    return response;\n  } catch(err) {\n    return fetch(event.request);\n  }\n}\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport const isWebWorker = typeof WorkerGlobalScope !== 'undefined' && self instanceof WorkerGlobalScope;\nexport const isServiceWorker = typeof ServiceWorkerGlobalScope !== 'undefined' && self instanceof ServiceWorkerGlobalScope;\nexport const isWorker = isWebWorker || isServiceWorker;\n\n// в SW может быть сразу две переменных TRUE, поэтому проверяю по последней\n\nconst notifyServiceWorker = (all: boolean, ...args: any[]) => {\n  (self as any as ServiceWorkerGlobalScope)\n  .clients\n  .matchAll({ includeUncontrolled: false, type: 'window' })\n  .then((listeners) => {\n    if(!listeners.length) {\n      //console.trace('no listeners?', self, listeners);\n      return;\n    }\n\n    listeners.slice(all ? 0 : -1).forEach(listener => {\n      // @ts-ignore\n      listener.postMessage(...args);\n    });\n  });\n};\n\nconst notifyWorker = (...args: any[]) => {\n  // @ts-ignore\n  (self as any as DedicatedWorkerGlobalScope).postMessage(...args);\n};\n\nconst noop = () => {};\n\nexport const notifySomeone = isServiceWorker ? notifyServiceWorker.bind(null, false) : (isWebWorker ? notifyWorker : noop);\nexport const notifyAll = isServiceWorker ? notifyServiceWorker.bind(null, true) : (isWebWorker ? notifyWorker : noop);\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport const userAgent = navigator ? navigator.userAgent : null;\nexport const isApple = navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i) !== -1;\nexport const isAndroid = navigator.userAgent.toLowerCase().indexOf('android') !== -1;\nexport const isChromium = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);\n\n/**\n * Returns true when run in WebKit derived browsers.\n * This is used as a workaround for a memory leak in Safari caused by using Transferable objects to\n * transfer data between WebWorkers and the main thread.\n * https://github.com/mapbox/mapbox-gl-js/issues/8771\n *\n * This should be removed once the underlying Safari issue is fixed.\n */\nexport const ctx = typeof(window) !== 'undefined' ? window : self;\n\n// https://stackoverflow.com/a/58065241\nexport const isAppleMobile = (/iPad|iPhone|iPod/.test(navigator.platform) ||\n  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) &&\n  !ctx.MSStream;\n\nexport const isSafari = !!('safari' in ctx) || !!(userAgent && (/\\b(iPad|iPhone|iPod)\\b/.test(userAgent) || (!!userAgent.match('Safari') && !userAgent.match('Chrome'))))/*  || true */;\nexport const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\n\nexport const isMobileSafari = isSafari && isAppleMobile;\n\nexport const isMobile = /* screen.width && screen.width < 480 ||  */navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i) != -1;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport { deferredPromise } from \"../../helpers/cancellablePromise\";\nimport { notifySomeone } from \"../../helpers/context\";\nimport { isSafari } from \"../../helpers/userAgent\";\nimport { UploadFile } from \"../../layer\";\nimport { DownloadOptions } from \"../mtproto/apiFileManager\";\nimport { RequestFilePartTask, deferredPromises, incrementTaskId } from \"./index.service\";\nimport timeout from \"./timeout\";\n\nexport default function onStreamFetch(event: FetchEvent, params: string) {\n  const range = parseRange(event.request.headers.get('Range'));\n  let [offset, end] = range;\n\n  const info: DownloadOptions = JSON.parse(decodeURIComponent(params));\n  //const fileName = getFileNameByLocation(info.location);\n\n  // ! если грузить очень большое видео чанками по 512Кб в мобильном Safari, то стрим не запустится\n  const limitPart = info.size > (75 * 1024 * 1024) ? STREAM_CHUNK_UPPER_LIMIT : STREAM_CHUNK_MIDDLE_LIMIT;\n\n  /* if(info.size > limitPart && isSafari && offset === limitPart) {\n    //end = info.size - 1;\n    //offset = info.size - 1 - limitPart;\n    offset = info.size - (info.size % limitPart);\n  } */\n\n  //log.debug('[stream]', url, offset, end);\n\n  event.respondWith(Promise.race([\n    timeout(45 * 1000),\n\n    new Promise<Response>((resolve, reject) => {\n      // safari workaround\n      const possibleResponse = responseForSafariFirstRange(range, info.mimeType, info.size);\n      if(possibleResponse) {\n        return resolve(possibleResponse);\n      }\n\n      const limit = end && end < limitPart ? alignLimit(end - offset + 1) : limitPart;\n      const alignedOffset = alignOffset(offset, limit);\n\n      //log.debug('[stream] requestFilePart:', /* info.dcId, info.location, */ alignedOffset, limit);\n\n      const task: RequestFilePartTask = {\n        type: 'requestFilePart',\n        id: incrementTaskId(),\n        payload: [info.dcId, info.location, alignedOffset, limit]\n      };\n\n      \n      const deferred = deferredPromises[task.id] = deferredPromise<UploadFile.uploadFile>();\n      deferred.then(result => {\n        let ab = result.bytes as Uint8Array;\n        \n        //log.debug('[stream] requestFilePart result:', result);\n\n        const headers: Record<string, string> = {\n          'Accept-Ranges': 'bytes',\n          'Content-Range': `bytes ${alignedOffset}-${alignedOffset + ab.byteLength - 1}/${info.size || '*'}`,\n          'Content-Length': `${ab.byteLength}`,\n        };\n\n        if(info.mimeType) headers['Content-Type'] = info.mimeType;\n\n        if(isSafari) {\n          ab = ab.slice(offset - alignedOffset, end - alignedOffset + 1);\n          headers['Content-Range'] = `bytes ${offset}-${offset + ab.byteLength - 1}/${info.size || '*'}`;\n          headers['Content-Length'] = `${ab.byteLength}`;\n        }\n\n        // simulate slow connection\n        //setTimeout(() => {\n          resolve(new Response(ab, {\n            status: 206,\n            statusText: 'Partial Content',\n            headers,\n          }));\n        //}, 2.5e3);\n      }).catch(err => {});\n\n      notifySomeone(task);\n    })\n  ]));\n}\n\nfunction responseForSafariFirstRange(range: [number, number], mimeType: string, size: number): Response {\n  if(range[0] === 0 && range[1] === 1) {\n    return new Response(new Uint8Array(2).buffer, {\n      status: 206,\n      statusText: 'Partial Content',\n      headers: {\n        'Accept-Ranges': 'bytes',\n        'Content-Range': `bytes 0-1/${size || '*'}`,\n        'Content-Length': '2',\n        'Content-Type': mimeType || 'video/mp4',\n      },\n    });\n  }\n\n  return null;\n}\n\n/* const STREAM_CHUNK_UPPER_LIMIT = 256 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 256 * 4; */\n/* const STREAM_CHUNK_UPPER_LIMIT = 1024 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 1024 * 4; */\nconst STREAM_CHUNK_MIDDLE_LIMIT = 512 * 1024;\nconst STREAM_CHUNK_UPPER_LIMIT = 1024 * 1024;\nconst SMALLEST_CHUNK_LIMIT = 512 * 4;\n\nfunction parseRange(header: string): [number, number] {\n  if(!header) return [0, 0];\n  const [, chunks] = header.split('=');\n  const ranges = chunks.split(', ');\n  const [offset, end] = ranges[0].split('-');\n\n  return [+offset, +end || 0];\n}\n\nfunction alignOffset(offset: number, base = SMALLEST_CHUNK_LIMIT) {\n  return offset - (offset % base);\n}\n\nfunction alignLimit(limit: number) {\n  return 2 ** Math.ceil(Math.log(limit) / Math.log(2));\n}\n","export default function timeout(delay: number): Promise<Response> {\n  return new Promise(((resolve) => {\n    setTimeout(() => {\n      resolve(new Response('', {\n        status: 408,\n        statusText: 'Request timed out.',\n      }));\n    }, delay);\n  }));\n}\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nexport interface CancellablePromise<T> extends Promise<T> {\n  resolve?: (...args: any[]) => void,\n  reject?: (...args: any[]) => void,\n  cancel?: () => void,\n\n  notify?: (...args: any[]) => void,\n  notifyAll?: (...args: any[]) => void,\n  lastNotify?: any,\n  listeners?: Array<(...args: any[]) => void>,\n  addNotifyListener?: (callback: (...args: any[]) => void) => void,\n\n  isFulfilled?: boolean,\n  isRejected?: boolean\n}\n\nexport function deferredPromise<T>() {\n  let deferredHelper: any = {\n    isFulfilled: false, \n    isRejected: false,\n\n    notify: () => {}, \n    notifyAll: (...args: any[]) => {\n      deferredHelper.lastNotify = args;\n      deferredHelper.listeners.forEach((callback: any) => callback(...args));\n    }, \n\n    lastNotify: undefined,\n    listeners: [],\n    addNotifyListener: (callback: (...args: any[]) => void) => {\n      if(deferredHelper.lastNotify) {\n        callback(...deferredHelper.lastNotify);\n      }\n\n      deferredHelper.listeners.push(callback);\n    }\n  };\n\n  let deferred: CancellablePromise<T> = new Promise<T>((resolve, reject) => {\n    deferredHelper.resolve = (value: T) => {\n      if(deferred.isFulfilled) return;\n\n      deferred.isFulfilled = true;\n      resolve(value);\n    };\n    \n    deferredHelper.reject = (...args: any[]) => {\n      if(deferred.isRejected) return;\n      \n      deferred.isRejected = true;\n      reject(...args);\n    };\n  });\n\n  // @ts-ignore\n  /* deferred.then = (resolve: (value: T) => any, reject: (...args: any[]) => any) => {\n    const n = deferredPromise<ReturnType<typeof resolve>>();\n    \n  }; */\n\n  deferred.finally(() => {\n    deferred.notify = null;\n    deferred.listeners.length = 0;\n    deferred.lastNotify = null;\n\n    if(deferred.cancel) {\n      deferred.cancel = () => {};\n    }\n  });\n\n  Object.assign(deferred, deferredHelper);\n\n  return deferred;\n}","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\n                  \n                                   \n          \n//import CacheStorageController from '../cacheStorage';\nimport type { WorkerTaskTemplate, WorkerTaskVoidTemplate } from '../../types';\nimport type { InputFileLocation, UploadFile } from '../../layer';\nimport type { WebPushApiManager } from '../mtproto/webPushApiManager';\nimport type { PushNotificationObject } from './push';\nimport { logger, LogTypes } from '../logger';\nimport { CancellablePromise } from '../../helpers/cancellablePromise';\nimport { CACHE_ASSETS_NAME, requestCache } from './cache';\nimport onStreamFetch from './stream';\n// import { closeAllNotifications, onPing } from './push';\n\nexport const log = logger('SW', LogTypes.Error | LogTypes.Debug | LogTypes.Log | LogTypes.Warn);\nconst ctx = self as any as ServiceWorkerGlobalScope;\nexport const deferredPromises: {[taskId: number]: CancellablePromise<any>} = {};\n\nexport interface RequestFilePartTask extends WorkerTaskTemplate {\n  type: 'requestFilePart',\n  payload: [number, InputFileLocation, number, number]\n};\n\nexport interface RequestFilePartTaskResponse extends WorkerTaskTemplate {\n  type: 'requestFilePart',\n  payload?: UploadFile.uploadFile,\n  originalPayload?: RequestFilePartTask['payload']\n};\n\nexport interface ServiceWorkerPingTask extends WorkerTaskVoidTemplate {\n  type: 'ping',\n  payload: {\n    localNotifications: boolean,\n    lang: {\n      push_action_mute1d: string\n      push_action_settings: string\n      push_message_nopreview: string\n    },\n    settings: WebPushApiManager['settings']\n  }\n};\n\nexport interface ServiceWorkerNotificationsClearTask extends WorkerTaskVoidTemplate {\n  type: 'notifications_clear'\n};\n\nexport interface ServiceWorkerPushClickTask extends WorkerTaskVoidTemplate {\n  type: 'push_click',\n  payload: PushNotificationObject\n};\n\nexport type ServiceWorkerTask = RequestFilePartTaskResponse | ServiceWorkerPingTask | ServiceWorkerNotificationsClearTask;\n\n                   \nconst taskListeners: {\n  [type in ServiceWorkerTask['type']]: (task: any, event: ExtendableMessageEvent) => void\n} = {\n  notifications_clear: () => {\n    // closeAllNotifications();\n  },\n  ping: (task: ServiceWorkerPingTask, event) => {\n    // onPing(task, event);\n  },\n  requestFilePart: (task: RequestFilePartTaskResponse) => {\n    const promise = deferredPromises[task.id];\n\n    if(task.error) {\n      promise.reject(task.error);\n    } else {\n      promise.resolve(task.payload);\n    }\n\n    delete deferredPromises[task.id];\n  }\n};\nctx.addEventListener('message', (e) => {\n  const task = e.data as ServiceWorkerTask;\n  const callback = taskListeners[task.type];\n  if(callback) {\n    callback(task, e);\n  }\n});\n          \n\n//const cacheStorage = new CacheStorageController('cachedAssets');\nlet taskId = 0;\n\nexport function getTaskId() {\n  return taskId;\n}\n\nexport function incrementTaskId() {\n  return taskId++;\n}\n\nconst onFetch = (event: FetchEvent): void => {\n  if(event.request.url.indexOf(location.origin + '/') === 0 && event.request.url.match(/\\.(js|css|jpe?g|json|wasm|png|mp3|svg|tgs|ico|woff2?|ttf|webmanifest?)(?:\\?.*)?$/)) {\n    return event.respondWith(requestCache(event));\n  }\n\n  try {\n    const [, url, scope, params] = /http[:s]+\\/\\/.*?(\\/(.*?)(?:$|\\/(.*)$))/.exec(event.request.url) || [];\n\n    //log.debug('[fetch]:', event);\n  \n    switch(scope) {\n      case 'stream': {\n        onStreamFetch(event, params);\n        break;\n      }\n    }\n  } catch(err) {\n    event.respondWith(new Response('', {\n      status: 500,\n      statusText: 'Internal Server Error',\n    }));\n  }\n};\n\nconst onChangeState = () => {\n  ctx.onfetch = onFetch;\n};\n\nctx.addEventListener('install', (event) => {\n  log('installing');\n  event.waitUntil(ctx.skipWaiting()); // Activate worker immediately\n});\n\nctx.addEventListener('activate', (event) => {\n  log('activating', ctx);\n  event.waitUntil(ctx.caches.delete(CACHE_ASSETS_NAME));\n  event.waitUntil(ctx.clients.claim());\n});\n\nctx.onerror = (error) => {\n  log.error('error:', error);\n};\n\nctx.onunhandledrejection = (error) => {\n  log.error('onunhandledrejection:', error);\n};\n\nctx.onoffline = ctx.ononline = onChangeState;\n\nonChangeState();\n"],"sourceRoot":""}