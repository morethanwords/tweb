{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/helpers/userAgent.ts","webpack:///./src/config/debug.ts","webpack:///./src/config/modes.ts","webpack:///./src/lib/logger.ts","webpack:///./src/helpers/context.ts","webpack:///./src/lib/mtproto/mtproto.service.ts","webpack:///./src/helpers/cancellablePromise.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","userAgent","navigator","ctx","search","toLowerCase","indexOf","test","vendor","window","self","isSafari","platform","maxTouchPoints","MSStream","match","DEBUG","location","debug","http","ssl","multipleConnections","asServiceWorker","LogTypes","LOG_LEVELS","None","Error","Warn","Log","Debug","_logTimer","Date","now","dT","toFixed","isWebWorker","WorkerGlobalScope","isServiceWorker","ServiceWorkerGlobalScope","notifyServiceWorker","all","args","clients","matchAll","includeUncontrolled","type","then","listeners","length","slice","forEach","listener","postMessage","notifyWorker","noop","notifySomeone","log","prefix","console","warn","info","error","trace","setPrefix","_prefix","setLevel","level","reduce","acc","v","logger","deferredPromises","addEventListener","e","task","data","promise","id","reject","resolve","payload","taskId","isCorrectResponse","response","ok","status","onFetch","event","request","url","origin","respondWith","cache","caches","open","file","fetch","put","clone","replace","Math","random","Request","err","requestCache","scope","params","exec","range","header","chunks","split","ranges","offset","end","parseRange","headers","JSON","parse","decodeURIComponent","limitPart","size","STREAM_CHUNK_UPPER_LIMIT","STREAM_CHUNK_MIDDLE_LIMIT","Promise","race","delay","setTimeout","Response","statusText","possibleResponse","mimeType","Uint8Array","buffer","responseForSafariFirstRange","limit","ceil","alignLimit","alignedOffset","base","alignOffset","dcId","deferredHelper","isFulfilled","isRejected","notify","notifyAll","lastNotify","callback","undefined","addNotifyListener","push","deferred","finally","cancel","assign","deferredPromise","result","ab","bytes","byteLength","catch","onChangeState","onfetch","waitUntil","skipWaiting","delete","claim","onerror","onunhandledrejection","onoffline","ononline"],"mappings":"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","file":"sw.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport const userAgent = navigator ? navigator.userAgent : null;\r\nexport const isApple = navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i) !== -1;\r\nexport const isAndroid = navigator.userAgent.toLowerCase().indexOf('android') !== -1;\r\nexport const isChromium = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);\r\n\r\n/**\r\n * Returns true when run in WebKit derived browsers.\r\n * This is used as a workaround for a memory leak in Safari caused by using Transferable objects to\r\n * transfer data between WebWorkers and the main thread.\r\n * https://github.com/mapbox/mapbox-gl-js/issues/8771\r\n *\r\n * This should be removed once the underlying Safari issue is fixed.\r\n */\r\nexport const ctx = typeof(window) !== 'undefined' ? window : self;\r\n\r\n// https://stackoverflow.com/a/58065241\r\nexport const isAppleMobile = (/iPad|iPhone|iPod/.test(navigator.platform) ||\r\n  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) &&\r\n  !ctx.MSStream;\r\n\r\nexport const isSafari = !!('safari' in ctx) || !!(userAgent && (/\\b(iPad|iPhone|iPod)\\b/.test(userAgent) || (!!userAgent.match('Safari') && !userAgent.match('Chrome'))))/*  || true */;\r\nexport const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;\r\n\r\nexport const isMobileSafari = isSafari && isAppleMobile;\r\n\r\nexport const isMobile = /* screen.width && screen.width < 480 ||  */navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i) != -1;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport Modes from \"./modes\";\r\n\r\nexport const DEBUG = process.env.NODE_ENV !== 'production' || Modes.debug;\r\nconst ctx: any = typeof(window) !== 'undefined' ? window : self;\r\nexport const MOUNT_CLASS_TO: any = DEBUG || true/*  && false */ ? ctx : {};\r\nexport default DEBUG;\r\n\r\n//let m = DEBUG;\r\n/* if(!DEBUG) {\r\n  ctx.sandpitTurtle = () => {\r\n    //if(!m) {\r\n      for(let i in MOUNT_CLASS_TO) {\r\n        ctx[i] = MOUNT_CLASS_TO[i];\r\n      }\r\n      //m = true;\r\n    //}\r\n  \r\n    //DEBUG = !DEBUG;\r\n  };\r\n} */\r\n\r\n/* export const superDebug = (object: any, key: string) => {\r\n  var d = object[key];\r\n  var beforeStr = '', afterStr = '';\r\n  for(var r of d) {\r\n    beforeStr += r.before.hex + '\\n';\r\n    afterStr += r.after.hex + '\\n';\r\n  }\r\n\r\n  beforeStr = beforeStr.trim();\r\n  afterStr = afterStr.trim();\r\n  //var beforeStr = d.map(r => r.before.hex).join('\\n');\r\n  //var afterStr = d.map(r => r.after.hex).join('\\n');\r\n\r\n  var dada = (name: string, str: string) => {\r\n    var a = document.createElement('a');\r\n    a.target = '_blank';\r\n    a.download = name + '.txt';\r\n    a.href = URL.createObjectURL(new Blob([str], {\r\n      type: 'text/plain'\r\n    }));\r\n    document.body.append(a);\r\n    a.click();\r\n  };\r\n\r\n  dada(key + '_' + 'before', beforeStr);\r\n  dada(key + '_' + 'after', afterStr);\r\n}\r\n\r\nMOUNT_CLASS_TO.superDebug = superDebug; */\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n * \r\n * Originally from:\r\n * https://github.com/zhukov/webogram\r\n * Copyright (C) 2014 Igor Zhukov <igor.beatle@gmail.com>\r\n * https://github.com/zhukov/webogram/blob/master/LICENSE\r\n */\r\n\r\nconst Modes = {\r\n  test: location.search.indexOf('test=1') > 0/*  || true */,\r\n  debug: location.search.indexOf('debug=1') > 0,\r\n  http: false, //location.search.indexOf('http=1') > 0,\r\n  ssl: true, // location.search.indexOf('ssl=1') > 0 || location.protocol === 'https:' && location.search.indexOf('ssl=0') === -1,\r\n  multipleConnections: true,\r\n  asServiceWorker: false\r\n};\r\n\r\n                  \r\n                             \r\n          \r\n\r\nexport default Modes;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nimport DEBUG from \"../config/debug\";\r\n\r\nexport enum LogTypes {\r\n  None = 0,\r\n  Error = 1,\r\n  Warn = 2,\r\n  Log = 4,\r\n  Debug = 8\r\n};\r\n\r\nexport const LOG_LEVELS = [LogTypes.None, LogTypes.Error, LogTypes.Warn, LogTypes.Log, LogTypes.Debug];\r\n\r\nconst _logTimer = Date.now();\r\nfunction dT() {\r\n  return '[' + ((Date.now() - _logTimer) / 1000).toFixed(3) + ']';\r\n}\r\n\r\nexport function logger(prefix: string, type: LogTypes = LogTypes.Log | LogTypes.Warn | LogTypes.Error) {\r\n  if(!DEBUG/*  || true */) {\r\n    type = LogTypes.Error;\r\n  }\r\n\r\n  //level = LogLevels.log | LogLevels.warn | LogLevels.error | LogLevels.debug\r\n\r\n  function Log(...args: any[]) {\r\n    return type & LogTypes.Log && console.log(dT(), prefix, ...args);\r\n  }\r\n  \r\n  Log.warn = function(...args: any[]) {\r\n    return type & LogTypes.Warn && console.warn(dT(), prefix, ...args);\r\n  };\r\n  \r\n  Log.info = function(...args: any[]) {\r\n    return type & LogTypes.Log && console.info(dT(), prefix, ...args);\r\n  };\r\n  \r\n  Log.error = function(...args: any[]) {\r\n    return type & LogTypes.Error && console.error(dT(), prefix, ...args);\r\n  };\r\n  \r\n  Log.trace = function(...args: any[]) {\r\n    return type & LogTypes.Log && console.trace(dT(), prefix, ...args);\r\n  };\r\n\r\n  /* Log.debug = function(...args: any[]) {\r\n    return level & LogLevels.debug && console.log(dT(), prefix, ...args);\r\n  }; */\r\n\r\n  Log.debug = function(...args: any[]) {\r\n    return type & LogTypes.Debug && console.debug(dT(), prefix, ...args);\r\n  };\r\n\r\n  Log.setPrefix = function(_prefix: string) {\r\n    prefix = '[' + _prefix + ']:';\r\n  };\r\n\r\n  Log.setPrefix(prefix);\r\n\r\n  Log.setLevel = function(level: 0 | 1 | 2 | 3 | 4) {\r\n    type = LOG_LEVELS.slice(0, level + 1).reduce((acc, v) => acc | v, 0) as any;\r\n  };\r\n  \r\n  return Log;\r\n};\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport const isWebWorker = typeof WorkerGlobalScope !== 'undefined' && self instanceof WorkerGlobalScope;\r\nexport const isServiceWorker = typeof ServiceWorkerGlobalScope !== 'undefined' && self instanceof ServiceWorkerGlobalScope;\r\nexport const isWorker = isWebWorker || isServiceWorker;\r\n\r\n// в SW может быть сразу две переменных TRUE, поэтому проверяю по последней\r\n\r\nconst notifyServiceWorker = (all: boolean, ...args: any[]) => {\r\n  (self as any as ServiceWorkerGlobalScope)\r\n  .clients\r\n  .matchAll({ includeUncontrolled: false, type: 'window' })\r\n  .then((listeners) => {\r\n    if(!listeners.length) {\r\n      //console.trace('no listeners?', self, listeners);\r\n      return;\r\n    }\r\n\r\n    listeners.slice(all ? 0 : -1).forEach(listener => {\r\n      // @ts-ignore\r\n      listener.postMessage(...args);\r\n    });\r\n  });\r\n};\r\n\r\nconst notifyWorker = (...args: any[]) => {\r\n  // @ts-ignore\r\n  (self as any as DedicatedWorkerGlobalScope).postMessage(...args);\r\n};\r\n\r\nconst noop = () => {};\r\n\r\nexport const notifySomeone = isServiceWorker ? notifyServiceWorker.bind(null, false) : (isWebWorker ? notifyWorker : noop);\r\nexport const notifyAll = isServiceWorker ? notifyServiceWorker.bind(null, true) : (isWebWorker ? notifyWorker : noop);\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\n                  \r\n                          \r\n          \r\n//import CacheStorageController from '../cacheStorage';\r\nimport { isSafari } from '../../helpers/userAgent';\r\nimport { logger, LogTypes } from '../logger';\r\nimport type { DownloadOptions } from './apiFileManager';\r\nimport type { WorkerTaskTemplate } from '../../types';\r\nimport { notifySomeone } from '../../helpers/context';\r\nimport type { InputFileLocation, UploadFile } from '../../layer';\r\nimport { CancellablePromise, deferredPromise } from '../../helpers/cancellablePromise';\r\n\r\nconst log = logger('SW', LogTypes.Error | LogTypes.Debug | LogTypes.Log | LogTypes.Warn);\r\nconst ctx = self as any as ServiceWorkerGlobalScope;\r\n\r\nconst deferredPromises: {[taskId: number]: CancellablePromise<any>} = {};\r\n\r\nexport interface ServiceWorkerTask extends WorkerTaskTemplate {\r\n  type: 'requestFilePart',\r\n  payload: [number, InputFileLocation, number, number]\r\n};\r\n\r\nexport interface ServiceWorkerTaskResponse extends WorkerTaskTemplate {\r\n  type: 'requestFilePart',\r\n  payload?: UploadFile.uploadFile,\r\n  originalPayload?: ServiceWorkerTask['payload']\r\n};\r\n\r\n                   \r\nctx.addEventListener('message', (e) => {\r\n  const task = e.data as ServiceWorkerTaskResponse;\r\n  const promise = deferredPromises[task.id];\r\n\r\n  if(task.error) {\r\n    promise.reject(task.error);\r\n  } else {\r\n    promise.resolve(task.payload);\r\n  }\r\n\r\n  delete deferredPromises[task.id];\r\n});\r\n          \r\n\r\n//const cacheStorage = new CacheStorageController('cachedAssets');\r\nlet taskId = 0;\r\n\r\nfunction isCorrectResponse(response: Response) {\r\n  return response.ok && response.status === 200;\r\n}\r\n\r\nasync function requestCache(event: FetchEvent) {\r\n  try {\r\n    const cache = await ctx.caches.open('cachedAssets');\r\n    const file = await cache.match(event.request);\r\n  \r\n    if(file && isCorrectResponse(file)) {\r\n      return file;\r\n    }\r\n  \r\n    let response = await fetch(event.request);\r\n    if(isCorrectResponse(response)) {\r\n      cache.put(event.request, response.clone());\r\n    } else if(response.status === 304) { // possible fix for 304 in Safari\r\n      const url = event.request.url.replace(/\\?.+$/, '') + '?' + (Math.random() * 100000 | 0);\r\n      const request = new Request(url);\r\n      response = await fetch(request);\r\n      if(isCorrectResponse(response)) {\r\n        cache.put(request, response.clone());\r\n      }\r\n    }\r\n  \r\n    return response;\r\n  } catch(err) {\r\n    return fetch(event.request);\r\n  }\r\n}\r\n\r\nconst onFetch = (event: FetchEvent): void => {\r\n  if(event.request.url.indexOf(location.origin + '/') === 0 && event.request.url.match(/\\.(js|css|jpe?g|json|wasm|png|mp3|svg|tgs|ico|woff2?|ttf|webmanifest?)(?:\\?.*)?$/)) {\r\n    return event.respondWith(requestCache(event));\r\n  }\r\n\r\n  try {\r\n    const [, url, scope, params] = /http[:s]+\\/\\/.*?(\\/(.*?)(?:$|\\/(.*)$))/.exec(event.request.url) || [];\r\n\r\n    //log.debug('[fetch]:', event);\r\n  \r\n    switch(scope) {\r\n      case 'stream': {\r\n        const range = parseRange(event.request.headers.get('Range'));\r\n        let [offset, end] = range;\r\n  \r\n        const info: DownloadOptions = JSON.parse(decodeURIComponent(params));\r\n        //const fileName = getFileNameByLocation(info.location);\r\n\r\n        // ! если грузить очень большое видео чанками по 512Кб в мобильном Safari, то стрим не запустится\r\n        const limitPart = info.size > (75 * 1024 * 1024) ? STREAM_CHUNK_UPPER_LIMIT : STREAM_CHUNK_MIDDLE_LIMIT;\r\n\r\n        /* if(info.size > limitPart && isSafari && offset === limitPart) {\r\n          //end = info.size - 1;\r\n          //offset = info.size - 1 - limitPart;\r\n          offset = info.size - (info.size % limitPart);\r\n        } */\r\n  \r\n        //log.debug('[stream]', url, offset, end);\r\n  \r\n        event.respondWith(Promise.race([\r\n          timeout(45 * 1000),\r\n\r\n          new Promise<Response>((resolve, reject) => {\r\n            // safari workaround\r\n            const possibleResponse = responseForSafariFirstRange(range, info.mimeType, info.size);\r\n            if(possibleResponse) {\r\n              return resolve(possibleResponse);\r\n            }\r\n  \r\n            const limit = end && end < limitPart ? alignLimit(end - offset + 1) : limitPart;\r\n            const alignedOffset = alignOffset(offset, limit);\r\n  \r\n            //log.debug('[stream] requestFilePart:', /* info.dcId, info.location, */ alignedOffset, limit);\r\n\r\n            const task: ServiceWorkerTask = {\r\n              type: 'requestFilePart',\r\n              id: taskId++,\r\n              payload: [info.dcId, info.location, alignedOffset, limit]\r\n            };\r\n\r\n            \r\n            const deferred = deferredPromises[task.id] = deferredPromise<UploadFile.uploadFile>();\r\n            deferred.then(result => {\r\n              let ab = result.bytes as Uint8Array;\r\n              \r\n              //log.debug('[stream] requestFilePart result:', result);\r\n  \r\n              const headers: Record<string, string> = {\r\n                'Accept-Ranges': 'bytes',\r\n                'Content-Range': `bytes ${alignedOffset}-${alignedOffset + ab.byteLength - 1}/${info.size || '*'}`,\r\n                'Content-Length': `${ab.byteLength}`,\r\n              };\r\n  \r\n              if(info.mimeType) headers['Content-Type'] = info.mimeType;\r\n  \r\n              if(isSafari) {\r\n                ab = ab.slice(offset - alignedOffset, end - alignedOffset + 1);\r\n                headers['Content-Range'] = `bytes ${offset}-${offset + ab.byteLength - 1}/${info.size || '*'}`;\r\n                headers['Content-Length'] = `${ab.byteLength}`;\r\n              }\r\n\r\n              // simulate slow connection\r\n              //setTimeout(() => {\r\n                resolve(new Response(ab, {\r\n                  status: 206,\r\n                  statusText: 'Partial Content',\r\n                  headers,\r\n                }));\r\n              //}, 2.5e3);\r\n            }).catch(err => {});\r\n\r\n            notifySomeone(task);\r\n          })\r\n        ]));\r\n        break;\r\n      }\r\n    }\r\n  } catch(err) {\r\n    event.respondWith(new Response('', {\r\n      status: 500,\r\n      statusText: 'Internal Server Error',\r\n    }));\r\n  }\r\n};\r\n\r\nconst onChangeState = () => {\r\n  ctx.onfetch = onFetch;\r\n};\r\n\r\nctx.addEventListener('install', (event) => {\r\n  log('installing');\r\n\r\n  /* initCache();\r\n\r\n  event.waitUntil(\r\n    initNetwork(),\r\n  ); */\r\n  event.waitUntil(ctx.skipWaiting()); // Activate worker immediately\r\n});\r\n\r\nctx.addEventListener('activate', (event) => {\r\n  log('activating', ctx);\r\n\r\n  /* if (!ctx.cache) initCache();\r\n  if (!ctx.network) initNetwork(); */\r\n\r\n  event.waitUntil(ctx.caches.delete('cachedAssets'));\r\n  event.waitUntil(ctx.clients.claim());\r\n});\r\n\r\nfunction timeout(delay: number): Promise<Response> {\r\n  return new Promise(((resolve) => {\r\n    setTimeout(() => {\r\n      resolve(new Response('', {\r\n        status: 408,\r\n        statusText: 'Request timed out.',\r\n      }));\r\n    }, delay);\r\n  }));\r\n}\r\n\r\nfunction responseForSafariFirstRange(range: [number, number], mimeType: string, size: number): Response {\r\n  if(range[0] === 0 && range[1] === 1) {\r\n    return new Response(new Uint8Array(2).buffer, {\r\n      status: 206,\r\n      statusText: 'Partial Content',\r\n      headers: {\r\n        'Accept-Ranges': 'bytes',\r\n        'Content-Range': `bytes 0-1/${size || '*'}`,\r\n        'Content-Length': '2',\r\n        'Content-Type': mimeType || 'video/mp4',\r\n      },\r\n    });\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nctx.onerror = (error) => {\r\n  log.error('error:', error);\r\n};\r\n\r\nctx.onunhandledrejection = (error) => {\r\n  log.error('onunhandledrejection:', error);\r\n};\r\n\r\nctx.onoffline = ctx.ononline = onChangeState;\r\n\r\nonChangeState();\r\n\r\n/* const STREAM_CHUNK_UPPER_LIMIT = 256 * 1024;\r\nconst SMALLEST_CHUNK_LIMIT = 256 * 4; */\r\n/* const STREAM_CHUNK_UPPER_LIMIT = 1024 * 1024;\r\nconst SMALLEST_CHUNK_LIMIT = 1024 * 4; */\r\nconst STREAM_CHUNK_MIDDLE_LIMIT = 512 * 1024;\r\nconst STREAM_CHUNK_UPPER_LIMIT = 1024 * 1024;\r\nconst SMALLEST_CHUNK_LIMIT = 512 * 4;\r\n\r\nfunction parseRange(header: string): [number, number] {\r\n  if(!header) return [0, 0];\r\n  const [, chunks] = header.split('=');\r\n  const ranges = chunks.split(', ');\r\n  const [offset, end] = ranges[0].split('-');\r\n\r\n  return [+offset, +end || 0];\r\n}\r\n\r\nfunction alignOffset(offset: number, base = SMALLEST_CHUNK_LIMIT) {\r\n  return offset - (offset % base);\r\n}\r\n\r\nfunction alignLimit(limit: number) {\r\n  return 2 ** Math.ceil(Math.log(limit) / Math.log(2));\r\n}\r\n\r\n/* ctx.addEventListener('push', (event) => {\r\n  console.log('[Service Worker] Push Received.');\r\n  console.log(`[Service Worker] Push had this data: \"${event.data.text()}\"`, event, event.data);\r\n\r\n  const title = 'Push Push Push';\r\n  const options = {};\r\n  // const options = {\r\n  //   body: 'Yay it works.',\r\n  //   icon: 'images/icon.png',\r\n  //   badge: 'images/badge.png'\r\n  // };\r\n\r\n  event.waitUntil(ctx.registration.showNotification(title, options));\r\n}); */\r\n\r\n//export default () => {};\r\n\r\n//MOUNT_CLASS_TO.onFetch = onFetch;\r\n","/*\r\n * https://github.com/morethanwords/tweb\r\n * Copyright (C) 2019-2021 Eduard Kuzmenko\r\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\r\n */\r\n\r\nexport interface CancellablePromise<T> extends Promise<T> {\r\n  resolve?: (...args: any[]) => void,\r\n  reject?: (...args: any[]) => void,\r\n  cancel?: () => void,\r\n\r\n  notify?: (...args: any[]) => void,\r\n  notifyAll?: (...args: any[]) => void,\r\n  lastNotify?: any,\r\n  listeners?: Array<(...args: any[]) => void>,\r\n  addNotifyListener?: (callback: (...args: any[]) => void) => void,\r\n\r\n  isFulfilled?: boolean,\r\n  isRejected?: boolean\r\n}\r\n\r\nexport function deferredPromise<T>() {\r\n  let deferredHelper: any = {\r\n    isFulfilled: false, \r\n    isRejected: false,\r\n\r\n    notify: () => {}, \r\n    notifyAll: (...args: any[]) => {\r\n      deferredHelper.lastNotify = args;\r\n      deferredHelper.listeners.forEach((callback: any) => callback(...args));\r\n    }, \r\n\r\n    lastNotify: undefined,\r\n    listeners: [],\r\n    addNotifyListener: (callback: (...args: any[]) => void) => {\r\n      if(deferredHelper.lastNotify) {\r\n        callback(...deferredHelper.lastNotify);\r\n      }\r\n\r\n      deferredHelper.listeners.push(callback);\r\n    }\r\n  };\r\n\r\n  let deferred: CancellablePromise<T> = new Promise<T>((resolve, reject) => {\r\n    deferredHelper.resolve = (value: T) => {\r\n      if(deferred.isFulfilled) return;\r\n\r\n      deferred.isFulfilled = true;\r\n      resolve(value);\r\n    };\r\n    \r\n    deferredHelper.reject = (...args: any[]) => {\r\n      if(deferred.isRejected) return;\r\n      \r\n      deferred.isRejected = true;\r\n      reject(...args);\r\n    };\r\n  });\r\n\r\n  // @ts-ignore\r\n  /* deferred.then = (resolve: (value: T) => any, reject: (...args: any[]) => any) => {\r\n    const n = deferredPromise<ReturnType<typeof resolve>>();\r\n    \r\n  }; */\r\n\r\n  deferred.finally(() => {\r\n    deferred.notify = null;\r\n    deferred.listeners.length = 0;\r\n    deferred.lastNotify = null;\r\n\r\n    if(deferred.cancel) {\r\n      deferred.cancel = () => {};\r\n    }\r\n  });\r\n\r\n  Object.assign(deferred, deferredHelper);\r\n\r\n  return deferred;\r\n}"],"sourceRoot":""}